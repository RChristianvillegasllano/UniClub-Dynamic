<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="https://phshirt.com/wp-content/uploads/2022/01/UM-Tagum-College-1950.png" type="image/x-icon">
  <title>Events | UniClub</title>
  <%
    if (typeof announcements === 'undefined') {
      announcements = [];
    }
    if (typeof events === 'undefined') {
      events = [];
    }
    if (typeof stats === 'undefined') {
      stats = { totalEvents: 0, youGoing: 0, thisWeek: 0, happeningToday: 0 };
    }
    if (typeof categories === 'undefined') {
      categories = [];
    }
    if (typeof clubs === 'undefined') {
      clubs = [];
    }
    if (typeof myClubIds === 'undefined') {
      myClubIds = [];
    }
  %>
  <meta name="csrf-token" content="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
  
  <!-- CRITICAL ANTI-FLICKER: Block rendering until theme is set -->
  <script>
    // This script MUST run synchronously - blocks all rendering
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      const html = document.documentElement;
      
      // Set theme attribute immediately for CSS to use
      html.setAttribute('data-theme', theme);
      
      // Apply theme class immediately
      if (theme === 'light') {
        html.classList.add('light-mode');
      } else {
        html.classList.remove('light-mode');
      }
      
      // Set background colors inline with !important - overrides all CSS
      if (theme === 'light') {
        html.style.setProperty('background-color', '#f8fafc', 'important');
      } else {
        html.style.setProperty('background-color', '#0a0f1a', 'important');
      }
    })();
  </script>
  
  <!-- Blocking inline CSS that uses theme attribute -->
  <style>
    /* Set background based on data-theme attribute - prevents dark flash */
    html[data-theme="light"],
    html[data-theme="light"] body {
      background-color: #f8fafc !important;
    }
    html[data-theme="dark"],
    html:not([data-theme]) body {
      background-color: #0a0f1a !important;
    }
    /* Hide body until it's ready */
    body:not([data-theme-ready]) {
      opacity: 0;
      visibility: hidden;
    }
    body[data-theme-ready] {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.1s ease;
    }
  </style>

  <!-- Apply theme to body once it exists -->
  <script>
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      
      function applyThemeToBody() {
        if (!document.body) return;
        
        if (theme === 'light') {
          document.body.classList.add('light-mode');
          document.body.style.setProperty('background-color', '#f8fafc', 'important');
        } else {
          document.body.classList.remove('light-mode');
          document.body.style.setProperty('background-color', '#0a0f1a', 'important');
        }
        
        // Mark body as ready
        document.body.setAttribute('data-theme-ready', 'true');
      }
      
      // Try immediately
      if (document.body) {
        applyThemeToBody();
      } else {
        // Watch for body creation
        const observer = new MutationObserver(function(mutations) {
          if (document.body) {
            applyThemeToBody();
            observer.disconnect();
          }
        });
        observer.observe(document.documentElement, { childList: true, subtree: true });
        
        // Fallback on DOMContentLoaded
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', applyThemeToBody);
        }
      }
    })();
  </script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      scroll-behavior: smooth;
    }

    body { 
      background:#0a0f1a; 
      font-family: 'Inter', system-ui, sans-serif;
      color: white;
      transition: background-color 0.3s ease, color 0.3s ease;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(198, 40, 40, 0.03) 0%, rgba(239, 108, 0, 0.015) 50%, transparent 70%),
        radial-gradient(circle at 80% 70%, rgba(229, 57, 53, 0.025) 0%, rgba(239, 108, 0, 0.01) 50%, transparent 70%),
        radial-gradient(circle at 50% 50%, rgba(239, 108, 0, 0.015) 0%, rgba(255, 167, 38, 0.008) 50%, transparent 70%);
      pointer-events: none;
      z-index: 0;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    body > * {
      position: relative;
      z-index: 1;
    }

    body.light-mode::before {
      background: 
        radial-gradient(circle at 20% 30%, rgba(198, 40, 40, 0.03) 0%, rgba(239, 108, 0, 0.015) 50%, transparent 70%),
        radial-gradient(circle at 80% 70%, rgba(229, 57, 53, 0.025) 0%, rgba(239, 108, 0, 0.01) 50%, transparent 70%),
        radial-gradient(circle at 50% 50%, rgba(239, 108, 0, 0.015) 0%, rgba(255, 167, 38, 0.008) 50%, transparent 70%);
      opacity: 1;
      z-index: 0;
    }

    body.light-mode {
      background: #f8fafc;
      color: #1e293b;
    }

    body.light-mode .text-white {
      color: #1e293b !important;
    }

    body.light-mode .text-white\/80,
    body.light-mode .text-white\/70,
    body.light-mode .text-white\/60 {
      color: #475569 !important;
    }

    body.light-mode .text-white\/50 {
      color: #64748b !important;
    }

    body.light-mode h1,
    body.light-mode h2,
    body.light-mode h3,
    body.light-mode h4,
    body.light-mode h5,
    body.light-mode h6 {
      color: #1e293b !important;
    }

    body.light-mode p,
    body.light-mode span,
    body.light-mode label,
    body.light-mode a {
      color: inherit;
    }

    /* Input fields light mode */
    body.light-mode input[type="text"],
    body.light-mode input[type="date"],
    body.light-mode input[type="search"],
    body.light-mode select {
      background: rgba(255, 255, 255, 0.9) !important;
      border-color: rgba(0, 0, 0, 0.15) !important;
      color: #1e293b !important;
    }

    body.light-mode input[type="text"]::placeholder,
    body.light-mode input[type="search"]::placeholder {
      color: #94a3b8 !important;
    }

    body.light-mode input[type="text"]:focus,
    body.light-mode input[type="date"]:focus,
    body.light-mode input[type="search"]:focus,
    body.light-mode select:focus {
      background: rgba(255, 255, 255, 1) !important;
      border-color: #C62828 !important;
      color: #1e293b !important;
    }

    /* Search input icon */
    body.light-mode .fa-search {
      color: #64748b !important;
    }

    /* Search input background */
    body.light-mode input[type="text"].bg-white\/5,
    body.light-mode input[type="search"].bg-white\/5 {
      background: rgba(255, 255, 255, 0.9) !important;
    }

    body.light-mode input[type="text"].border-white\/10,
    body.light-mode input[type="search"].border-white\/10 {
      border-color: rgba(0, 0, 0, 0.15) !important;
    }

    /* View All link */
    body.light-mode a.text-red-400 {
      color: #dc2626 !important;
    }

    body.light-mode a.text-red-400:hover {
      color: #b91c1c !important;
    }

    /* Date group headers that are dynamically rendered */
    body.light-mode .date-group-header * {
      color: inherit;
    }

    /* Filter labels and checkboxes */
    body.light-mode .filter-checkbox {
      color: #1e293b !important;
    }

    body.light-mode .filter-checkbox span {
      color: #475569 !important;
    }

    /* Links */
    body.light-mode a {
      color: #1e293b;
    }

    body.light-mode a:hover {
      color: #C62828;
    }

    body.light-mode a.text-white\/50:hover {
      color: #C62828 !important;
    }

    /* Clear filters button */
    body.light-mode #clearFilters {
      background: rgba(0, 0, 0, 0.05) !important;
      border-color: rgba(0, 0, 0, 0.1) !important;
      color: #1e293b !important;
    }

    body.light-mode #clearFilters:hover {
      background: rgba(0, 0, 0, 0.08) !important;
    }

    /* Stats card text */
    body.light-mode .stat-card .text-white\/70,
    body.light-mode .stat-card .text-white\/50 {
      color: #64748b !important;
    }

    body.light-mode .stat-card .text-white {
      color: #1e293b !important;
    }

    /* Section headers - ensure they're visible */
    body.light-mode h2.section-header,
    body.light-mode h3.section-header,
    body.light-mode h4 {
      color: #1e293b !important;
    }

    /* Navbar Styles - Same as other pages */
    #navbar {
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(32px);
      -webkit-backdrop-filter: blur(32px);
    }

    body.light-mode #navbar {
      background: rgba(255, 255, 255, 0.9) !important;
      border-bottom-color: rgba(0, 0, 0, 0.1) !important;
    }

    .nav-link {
      color: rgba(255, 255, 255, 0.7);
      font-size: 15px;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s ease;
      text-decoration: none;
      position: relative;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 12px;
      right: 12px;
      height: 2px;
      background: transparent;
      transition: all 0.2s ease;
    }

    .nav-link:hover {
      color: white;
    }

    .nav-link:hover::after {
      background: rgba(255, 255, 255, 0.3);
    }

    .nav-link.active {
      color: white;
      font-weight: 600;
    }

    .nav-link.active::after {
      background: #C62828;
      height: 3px;
    }

    body.light-mode .nav-link {
      color: #475569;
    }

    body.light-mode .nav-link:hover,
    body.light-mode .nav-link.active {
      color: #1e293b;
    }

    body.light-mode .nav-link.active::after {
      background: #C62828;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .profile-pill {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #C62828;
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
      line-height: 1.2;
    }

    .profile-dropdown {
      background: rgba(30, 41, 59, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      min-width: 280px;
      max-width: 320px;
      overflow: hidden;
    }

    body.light-mode .profile-dropdown {
      background: rgba(255, 255, 255, 0.98) !important;
      border-color: rgba(0, 0, 0, 0.15) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
    }

    body.light-mode .profile-dropdown .text-white {
      color: #1e293b !important;
    }

    body.light-mode .profile-dropdown .text-white\/65,
    body.light-mode .profile-dropdown .text-white\/80 {
      color: #64748b !important;
    }

    .mobile-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(30, 41, 59, 0.98);
      backdrop-filter: blur(32px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
      z-index: 40;
    }

    .mobile-menu.active {
      max-height: 500px;
      display: block !important;
    }

    .mobile-menu-content {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    body.light-mode .mobile-menu {
      background: rgba(255, 255, 255, 0.98) !important;
      border-bottom-color: rgba(0, 0, 0, 0.1) !important;
    }

    body.light-mode .mobile-menu .nav-link {
      color: #475569 !important;
    }

    body.light-mode .mobile-menu .nav-link:hover {
      color: #1e293b !important;
    }

    body.light-mode .mobile-menu hr {
      border-color: rgba(0, 0, 0, 0.1) !important;
    }

    /* Quick Stats Cards */
    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    body.light-mode .stat-card {
      background: rgba(255, 255, 255, 0.8);
      border-color: rgba(0, 0, 0, 0.1);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    /* Filter Sidebar */
    .filter-sidebar {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
    }

    body.light-mode .filter-sidebar {
      background: rgba(255, 255, 255, 0.6);
      border-color: rgba(0, 0, 0, 0.1);
    }

    /* Event Card */
    .event-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    body.light-mode .event-card {
      background: rgba(255, 255, 255, 0.8);
      border-color: rgba(0, 0, 0, 0.1);
    }

    .event-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    /* View Toggle Buttons */
    .view-toggle-btn {
      padding: 10px 20px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .view-toggle-btn.active {
      background: #C62828;
      border-color: #C62828;
    }

    body.light-mode .view-toggle-btn {
      background: rgba(0, 0, 0, 0.05);
      border-color: rgba(0, 0, 0, 0.1);
      color: #1e293b;
    }

    body.light-mode .view-toggle-btn.active {
      background: #C62828;
      color: white;
    }

    /* Calendar View */
    .calendar-view {
      display: none;
    }

    .calendar-view.active {
      display: block;
    }

    .timeline-view.active {
      display: block;
    }

    .timeline-view {
      display: none;
    }

    /* RSVP Button */
    .rsvp-btn {
      padding: 8px 16px;
      border-radius: 8px;
      background: #C62828;
      color: white;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .rsvp-btn:hover {
      background: #E53935;
      transform: translateY(-1px);
    }

    .rsvp-btn.going {
      background: rgba(34, 197, 94, 0.2);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    /* Section Header */
    .section-header {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    body.light-mode .section-header {
      color: #1e293b;
    }

    /* Event card content - ensure all text is visible in light mode */
    body.light-mode .event-card * {
      color: inherit;
    }

    body.light-mode .event-card .text-white,
    body.light-mode .event-card .text-white\/80,
    body.light-mode .event-card .text-white\/70,
    body.light-mode .event-card .text-white\/60,
    body.light-mode .event-card .text-white\/50 {
      color: #475569 !important;
    }

    body.light-mode .event-card h3,
    body.light-mode .event-card h4,
    body.light-mode .event-card .font-bold,
    body.light-mode .event-card .font-semibold {
      color: #1e293b !important;
    }

    /* Footer light mode */
    body.light-mode footer {
      border-top-color: rgba(0, 0, 0, 0.1) !important;
    }

    body.light-mode footer .text-white,
    body.light-mode footer .text-white\/50 {
      color: #64748b !important;
    }

    body.light-mode footer a:hover {
      color: #1e293b !important;
    }

    /* Select dropdown options */
    body.light-mode select option {
      background: white !important;
      color: #1e293b !important;
    }

    /* Ensure all emoji and icons are visible */
    body.light-mode .fa-search,
    body.light-mode i {
      color: inherit;
    }

    /* Empty state */
    body.light-mode .text-center p.text-white\/60 {
      color: #64748b !important;
    }

    /* RSVP button going state in light mode */
    body.light-mode .rsvp-btn.going {
      background: rgba(34, 197, 94, 0.15) !important;
      color: #059669 !important;
      border-color: rgba(34, 197, 94, 0.3) !important;
    }

    /* Ensure main content background is correct */
    body.light-mode main {
      background: #f8fafc !important;
      color: #1e293b !important;
    }

    /* Any remaining text-white classes */
    body.light-mode .text-white\/90,
    body.light-mode .text-white\/85,
    body.light-mode .text-white\/75,
    body.light-mode .text-white\/65 {
      color: #475569 !important;
    }

    /* Filter Checkbox */
    .filter-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      cursor: pointer;
    }

    .filter-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Date Group Header */
    .date-group-header {
      font-size: 16px;
      font-weight: 700;
      padding: 16px 0;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 16px;
    }

    body.light-mode .date-group-header {
      color: #1e293b;
      border-bottom-color: rgba(0, 0, 0, 0.1);
    }

    /* Featured Badge */
    .featured-badge {
      display: inline-block;
      padding: 4px 12px;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #1e293b;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    /* Button Icon */
    .btn-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-icon:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    body.light-mode .btn-icon {
      background: rgba(0, 0, 0, 0.05);
      border-color: rgba(0, 0, 0, 0.1);
      color: #1e293b;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .filter-sidebar {
        margin-bottom: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Shared Student Navigation -->
  <%- include('../layouts/studentNav', { 
    currentPath: '/student/events',
    student: typeof student !== 'undefined' ? student : {},
    announcements: typeof announcements !== 'undefined' ? announcements : [],
    csrfToken: typeof csrfToken !== 'undefined' ? csrfToken : ''
  }) %>

  <!-- ===== MAIN CONTENT ===== -->
  <main class="min-h-screen bg-[#0a0f1a] text-white px-3 sm:px-4 md:px-6 lg:px-8 py-6 sm:py-8 light-mode:bg-[#f8fafc] light-mode:text-[#1e293b]">
    <div class="max-w-7xl mx-auto">
      
      <!-- ===== PAGE HEADER ===== -->
      <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
          <div>
            <h1 class="text-3xl sm:text-4xl font-bold mb-2">
              üìÖ Events
            </h1>
            <div class="h-1 w-20 bg-gradient-to-r from-red-600 to-orange-500 rounded-full mb-4"></div>
            <p class="text-white/70 text-sm sm:text-base">Discover and join exciting events from clubs across campus</p>
          </div>
          <div class="w-full sm:w-auto">
            <div class="relative">
              <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-white/60"></i>
              <input type="text" id="searchInput" placeholder="üîç Search events..." class="w-full sm:w-80 pl-12 pr-4 py-3 rounded-lg bg-white/5 border border-white/10 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-red-500/50">
            </div>
          </div>
        </div>
      </div>

      <!-- ===== QUICK STATS ===== -->
      <section class="mb-8">
        <h2 class="section-header">üéØ QUICK STATS</h2>
        <div class="h-1 w-32 bg-gradient-to-r from-red-600 to-orange-500 rounded-full mb-6"></div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="stat-card">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400 text-xl">
                üìÖ
              </div>
              <div>
                <p class="text-white/70 text-sm">Total Events</p>
                <p class="text-2xl font-bold text-white"><%= stats.totalEvents || 0 %></p>
              </div>
            </div>
            <p class="text-white/50 text-xs">Upcoming</p>
          </div>

          <div class="stat-card">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center text-green-400 text-xl">
                ‚úì
              </div>
              <div>
                <p class="text-white/70 text-sm">You're Going</p>
                <p class="text-2xl font-bold text-white"><%= stats.youGoing || 0 %></p>
              </div>
            </div>
            <p class="text-white/50 text-xs">Registered</p>
          </div>

          <div class="stat-card">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-12 h-12 rounded-lg bg-orange-500/20 flex items-center justify-center text-orange-400 text-xl">
                üî•
              </div>
              <div>
                <p class="text-white/70 text-sm">This Week</p>
                <p class="text-2xl font-bold text-white"><%= stats.thisWeek || 0 %></p>
              </div>
            </div>
            <p class="text-white/50 text-xs">Don't miss</p>
          </div>

          <div class="stat-card">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400 text-xl">
                üìç
              </div>
              <div>
                <p class="text-white/70 text-sm">Happening Today</p>
                <p class="text-2xl font-bold text-white"><%= stats.happeningToday || 0 %></p>
              </div>
            </div>
            <a href="#today-events" class="text-white/50 text-xs hover:text-white transition-colors">View ‚Üí</a>
          </div>
        </div>
      </section>

      <!-- ===== VIEW OPTIONS ===== -->
      <section class="mb-8">
        <h2 class="section-header">üóìÔ∏è VIEW OPTIONS</h2>
        <div class="h-1 w-32 bg-gradient-to-r from-red-600 to-orange-500 rounded-full mb-6"></div>
        
        <div class="flex flex-wrap gap-3">
          <button class="view-toggle-btn active" data-view="timeline">
            üìã Timeline View
          </button>
          <button class="view-toggle-btn" data-view="calendar">
            üìÖ Calendar View
          </button>
          <button class="view-toggle-btn" data-view="map">
            üó∫Ô∏è Map View
          </button>
        </div>
      </section>

      <!-- ===== MAIN CONTENT AREA ===== -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- ===== FILTERS SIDEBAR ===== -->
        <aside class="lg:col-span-1">
          <div class="filter-sidebar sticky top-24">
            <h3 class="section-header mb-4">üéØ Filter Events</h3>
            
            <!-- Date Range -->
            <div class="mb-6">
              <h4 class="text-sm font-semibold text-white mb-3">üìÖ Date Range</h4>
              <div class="space-y-2">
                <input type="date" id="dateFrom" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white text-sm">
                <input type="date" id="dateTo" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white text-sm">
              </div>
            </div>

            <!-- Category -->
            <div class="mb-6">
              <h4 class="text-sm font-semibold text-white mb-3">üè∑Ô∏è Category</h4>
              <div class="space-y-2">
                <label class="filter-checkbox">
                  <input type="checkbox" class="category-filter" value="all" checked>
                  <span class="text-sm text-white/80">All (<%= events.length %>)</span>
                </label>
                <% categories.forEach(category => { %>
                  <label class="filter-checkbox">
                    <input type="checkbox" class="category-filter" value="<%= category %>">
                    <span class="text-sm text-white/80"><%= category %> (<%= events.filter(e => e.club_category === category).length %>)</span>
                  </label>
                <% }); %>
              </div>
            </div>

            <!-- Club -->
            <div class="mb-6">
              <h4 class="text-sm font-semibold text-white mb-3">üéØ Club</h4>
              <div class="space-y-2 max-h-48 overflow-y-auto">
                <label class="filter-checkbox">
                  <input type="checkbox" class="club-filter" value="all" checked>
                  <span class="text-sm text-white/80">All Clubs (<%= events.length %>)</span>
                </label>
                <label class="filter-checkbox">
                  <input type="checkbox" class="club-filter" value="my-clubs">
                  <span class="text-sm text-white/80">My Clubs Only (<%= events.filter(e => myClubIds.includes(e.club_id)).length %>)</span>
                </label>
                <% clubs.slice(0, 5).forEach(club => { %>
                  <label class="filter-checkbox">
                    <input type="checkbox" class="club-filter" value="<%= club.id %>">
                    <span class="text-sm text-white/80"><%= club.name %> (<%= events.filter(e => e.club_id === club.id).length %>)</span>
                  </label>
                <% }); %>
                <% if (clubs.length > 5) { %>
                  <a href="#" class="text-xs text-red-400 hover:text-red-300">View All ‚Üí</a>
                <% } %>
              </div>
            </div>

            <!-- Location -->
            <div class="mb-6">
              <h4 class="text-sm font-semibold text-white mb-3">üìç Location</h4>
              <div class="space-y-2">
                <label class="filter-checkbox">
                  <input type="checkbox" class="location-filter" value="on-campus" checked>
                  <span class="text-sm text-white/80">On Campus (<%= events.filter(e => e.location && !e.location.toLowerCase().includes('online') && !e.location.toLowerCase().includes('zoom')).length %>)</span>
                </label>
                <label class="filter-checkbox">
                  <input type="checkbox" class="location-filter" value="online" checked>
                  <span class="text-sm text-white/80">Online (<%= events.filter(e => e.location && (e.location.toLowerCase().includes('online') || e.location.toLowerCase().includes('zoom'))).length %>)</span>
                </label>
                <label class="filter-checkbox">
                  <input type="checkbox" class="location-filter" value="off-campus" checked>
                  <span class="text-sm text-white/80">Off Campus (<%= events.filter(e => e.location && !e.location.toLowerCase().includes('online') && !e.location.toLowerCase().includes('zoom') && !e.location.toLowerCase().includes('room') && !e.location.toLowerCase().includes('building')).length %>)</span>
                </label>
              </div>
            </div>

            <!-- RSVP Status -->
            <div class="mb-6">
              <h4 class="text-sm font-semibold text-white mb-3">üé´ RSVP Status</h4>
              <div class="space-y-2">
                <label class="filter-checkbox">
                  <input type="checkbox" class="rsvp-filter" value="all" checked>
                  <span class="text-sm text-white/80">All Events</span>
                </label>
                <label class="filter-checkbox">
                  <input type="checkbox" class="rsvp-filter" value="going">
                  <span class="text-sm text-white/80">Going (<%= events.filter(e => e.rsvp_status === 'going').length %>)</span>
                </label>
                <label class="filter-checkbox">
                  <input type="checkbox" class="rsvp-filter" value="interested">
                  <span class="text-sm text-white/80">Interested (<%= events.filter(e => e.rsvp_status === 'interested').length %>)</span>
                </label>
                <label class="filter-checkbox">
                  <input type="checkbox" class="rsvp-filter" value="not_responded">
                  <span class="text-sm text-white/80">Not Responded (<%= events.filter(e => e.rsvp_status === 'not_responded').length %>)</span>
                </label>
              </div>
            </div>

            <!-- Featured Only -->
            <div class="mb-6">
              <label class="filter-checkbox">
                <input type="checkbox" id="featuredOnly">
                <span class="text-sm text-white/80">‚≠ê Show featured events</span>
              </label>
            </div>

            <button id="clearFilters" class="w-full px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-white hover:bg-white/10 transition-colors text-sm">
              Clear All Filters
            </button>
          </div>
        </aside>

        <!-- ===== EVENTS LIST ===== -->
        <div class="lg:col-span-3">
          <!-- Timeline View -->
          <div id="timelineView" class="timeline-view active">
            <div class="flex items-center justify-between mb-6">
              <p class="text-white/70 text-sm">Showing <span id="eventsCount"><%= events.length %></span> events</p>
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                  <span class="text-white/70 text-sm">Sort by:</span>
                  <select id="sortSelect" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white text-sm focus:outline-none focus:ring-2 focus:ring-red-500/50">
                    <option value="date">Date</option>
                    <option value="name">Name</option>
                    <option value="club">Club</option>
                    <option value="popularity">Popularity</option>
                  </select>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-white/70 text-sm">View:</span>
                  <button class="view-toggle-btn active" data-display="list">List</button>
                  <button class="view-toggle-btn" data-display="grid">Grid</button>
                </div>
              </div>
            </div>

            <!-- Events grouped by date -->
            <div id="eventsList">
              <!-- Events will be dynamically rendered here -->
            </div>
          </div>

          <!-- Calendar View -->
          <div id="calendarView" class="calendar-view">
            <div class="text-center mb-6">
              <h3 class="text-2xl font-bold mb-4">üìÖ Calendar View</h3>
              <p class="text-white/70">Calendar functionality coming soon</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== FOOTER ===== -->
  <footer class="border-t border-white/10 py-6 px-4 sm:px-6 lg:px-8 mt-12">
    <div class="max-w-7xl mx-auto">
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-2">
          <img src="/img/logo.png" alt="UM Logo" class="w-6 h-6 object-contain">
          <p class="text-white font-semibold text-sm">UniClub</p>
        </div>
        <p class="text-xs text-white/50">¬© 2024 University of Mindanao</p>
        <div class="flex gap-4 text-xs text-white/50">
          <a href="#" class="hover:text-white/70 transition-colors">Privacy</a>
          <a href="#" class="hover:text-white/70 transition-colors">Terms</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // Event data from server
    const allEvents = <%- JSON.stringify(events) %>;
    const myClubIds = <%- JSON.stringify(myClubIds) %>;
    let filteredEvents = [...allEvents];
    let currentView = 'timeline';
    let currentDisplay = 'list';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      renderEvents();
      setupEventListeners();
    });

    // Setup event listeners
    function setupEventListeners() {
      // View toggle
      document.querySelectorAll('.view-toggle-btn[data-view]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.view-toggle-btn[data-view]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentView = btn.getAttribute('data-view');
          
          document.getElementById('timelineView').classList.remove('active');
          document.getElementById('calendarView').classList.remove('active');
          
          if (currentView === 'timeline') {
            document.getElementById('timelineView').classList.add('active');
          } else if (currentView === 'calendar') {
            document.getElementById('calendarView').classList.add('active');
          }
        });
      });

      // Display toggle (List/Grid)
      document.querySelectorAll('.view-toggle-btn[data-display]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.view-toggle-btn[data-display]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentDisplay = btn.getAttribute('data-display');
          renderEvents();
        });
      });

      // Search
      document.getElementById('searchInput').addEventListener('input', (e) => {
        applyFilters();
      });

      // Filters
      document.querySelectorAll('.category-filter, .club-filter, .location-filter, .rsvp-filter').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          applyFilters();
        });
      });

      document.getElementById('featuredOnly').addEventListener('change', () => {
        applyFilters();
      });

      document.getElementById('clearFilters').addEventListener('click', () => {
        clearAllFilters();
      });

      // Sort
      document.getElementById('sortSelect').addEventListener('change', (e) => {
        sortEvents(e.target.value);
        renderEvents();
      });

      // Navbar functionality (dropdowns, mobile menu) is handled by the shared navbar component (studentNav.ejs)
    }

    // Apply filters
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked')).map(cb => cb.value);
      const selectedClubs = Array.from(document.querySelectorAll('.club-filter:checked')).map(cb => cb.value);
      const selectedLocations = Array.from(document.querySelectorAll('.location-filter:checked')).map(cb => cb.value);
      const selectedRSVP = Array.from(document.querySelectorAll('.rsvp-filter:checked')).map(cb => cb.value);
      const featuredOnly = document.getElementById('featuredOnly').checked;

      filteredEvents = allEvents.filter(event => {
        // Search
        if (searchTerm && !event.name.toLowerCase().includes(searchTerm) && 
            !event.club_name.toLowerCase().includes(searchTerm) &&
            !event.description.toLowerCase().includes(searchTerm)) {
          return false;
        }

        // Category
        if (!selectedCategories.includes('all') && !selectedCategories.includes(event.club_category)) {
          return false;
        }

        // Club
        if (selectedClubs.includes('all')) {
          // All clubs selected
        } else if (selectedClubs.includes('my-clubs')) {
          if (!myClubIds.includes(event.club_id)) return false;
        } else {
          if (!selectedClubs.includes(String(event.club_id))) return false;
        }

        // Location
        const isOnline = event.location && (event.location.toLowerCase().includes('online') || event.location.toLowerCase().includes('zoom'));
        const isOnCampus = event.location && !isOnline && (event.location.toLowerCase().includes('room') || event.location.toLowerCase().includes('building') || event.location.toLowerCase().includes('hall'));
        
        if (selectedLocations.includes('on-campus') && isOnCampus) {
          // OK
        } else if (selectedLocations.includes('online') && isOnline) {
          // OK
        } else if (selectedLocations.includes('off-campus') && !isOnline && !isOnCampus) {
          // OK
        } else {
          return false;
        }

        // RSVP
        if (!selectedRSVP.includes('all') && !selectedRSVP.includes(event.rsvp_status)) {
          return false;
        }

        // Featured (placeholder - would need featured field in DB)
        if (featuredOnly) {
          // For now, skip this filter
        }

        return true;
      });

      sortEvents(document.getElementById('sortSelect').value);
      renderEvents();
    }

    // Sort events
    function sortEvents(sortBy) {
      filteredEvents.sort((a, b) => {
        if (sortBy === 'date') {
          const dateA = a.date ? new Date(a.date) : new Date('9999-12-31');
          const dateB = b.date ? new Date(b.date) : new Date('9999-12-31');
          return dateA - dateB;
        } else if (sortBy === 'name') {
          return a.name.localeCompare(b.name);
        } else if (sortBy === 'club') {
          return a.club_name.localeCompare(b.club_name);
        } else if (sortBy === 'popularity') {
          return (b.going_count + b.interested_count) - (a.going_count + a.interested_count);
        }
        return 0;
      });
    }

    // Clear all filters
    function clearAllFilters() {
      document.getElementById('searchInput').value = '';
      document.querySelectorAll('.category-filter, .club-filter, .location-filter, .rsvp-filter').forEach(cb => {
        if (cb.value === 'all') {
          cb.checked = true;
        } else {
          cb.checked = false;
        }
      });
      document.getElementById('featuredOnly').checked = false;
      applyFilters();
    }

    // Group events by date
    function groupEventsByDate(events) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      const nextWeekEnd = new Date(weekEnd);
      nextWeekEnd.setDate(weekEnd.getDate() + 7);

      const groups = {
        today: [],
        thisWeek: [],
        nextWeek: [],
        later: []
      };

      events.forEach(event => {
        if (!event.date) {
          groups.later.push(event);
          return;
        }

        const eventDate = new Date(event.date);
        eventDate.setHours(0, 0, 0, 0);

        if (eventDate.getTime() === today.getTime()) {
          groups.today.push(event);
        } else if (eventDate >= weekStart && eventDate <= weekEnd) {
          groups.thisWeek.push(event);
        } else if (eventDate > weekEnd && eventDate <= nextWeekEnd) {
          groups.nextWeek.push(event);
        } else {
          groups.later.push(event);
        }
      });

      return groups;
    }

    // Render events
    function renderEvents() {
      const container = document.getElementById('eventsList');
      const groups = groupEventsByDate(filteredEvents);
      
      document.getElementById('eventsCount').textContent = filteredEvents.length;

      let html = '';

      // Today
      if (groups.today.length > 0) {
        html += `<div id="today-events" class="mb-8">
          <div class="date-group-header">TODAY ‚Ä¢ ${formatDate(new Date())}</div>`;
        html += renderEventGroup(groups.today);
        html += '</div>';
      }

      // This Week
      if (groups.thisWeek.length > 0) {
        html += `<div class="mb-8">
          <div class="date-group-header">THIS WEEK ‚Ä¢ ${formatWeekRange()}</div>`;
        html += renderEventGroup(groups.thisWeek);
        html += '</div>';
      }

      // Next Week
      if (groups.nextWeek.length > 0) {
        html += `<div class="mb-8">
          <div class="date-group-header">NEXT WEEK ‚Ä¢ ${formatNextWeekRange()}</div>`;
        html += renderEventGroup(groups.nextWeek);
        html += '</div>';
      }

      // Later
      if (groups.later.length > 0) {
        html += `<div class="mb-8">
          <div class="date-group-header">LATER</div>`;
        html += renderEventGroup(groups.later);
        html += '</div>';
      }

      if (html === '') {
        html = '<div class="text-center py-12"><p class="text-white/60">No events match your filters</p></div>';
      }

      container.innerHTML = html;
    }

    // Render event group
    function renderEventGroup(events) {
      if (currentDisplay === 'grid') {
        return events.map(event => renderEventCard(event)).join('');
      } else {
        return events.map(event => renderEventCard(event)).join('');
      }
    }

    // Render single event card
    function renderEventCard(event) {
      const eventDate = event.date ? new Date(event.date) : null;
      const isGoing = event.rsvp_status === 'going';
      
      return `
        <div class="event-card mb-4" data-event-id="${event.id}">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                ${eventDate ? `<span class="text-xs text-white/60">${formatEventDate(eventDate)}</span>` : ''}
              </div>
              <h3 class="text-lg font-bold text-white mb-2">${escapeHtml(event.name)}</h3>
              <p class="text-sm text-white/70 mb-2">${escapeHtml(event.club_name)}</p>
              <p class="text-sm text-white/60 mb-3">üìç ${escapeHtml(event.location)}</p>
              <p class="text-sm text-white/70 mb-3">üë• ${event.going_count} going ‚Ä¢ ${event.interested_count} interested</p>
              <p class="text-sm text-white/60 line-clamp-2">${escapeHtml(event.description || '')}</p>
            </div>
            <div class="flex flex-col gap-2">
              <button class="rsvp-btn ${event.rsvp_status === 'going' ? 'going' : ''}" 
                      onclick="handleRSVP(${event.id}, '${event.rsvp_status === 'going' ? 'cancel' : 'going'}')">
                ${event.rsvp_status === 'going' ? '‚úì Going' : 'RSVP'}
              </button>
              <a href="/student/club/${event.club_id}" class="text-sm text-white/70 hover:text-white text-center">View Details ‚Üí</a>
            </div>
          </div>
        </div>
      `;
    }

    // Format date
    function formatDate(date) {
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatEventDate(date) {
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${days[date.getDay()].toUpperCase()} ‚Ä¢ ${months[date.getMonth()].toUpperCase()} ${date.getDate()}`;
    }

    function formatWeekRange() {
      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      return `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
    }

    function formatNextWeekRange() {
      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay() + 7);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      return `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Show notification toast
    function showNotification(message, type = 'info') {
      // Remove existing notification if any
      const existing = document.getElementById('rsvp-notification');
      if (existing) {
        existing.remove();
      }

      // Create notification element
      const notification = document.createElement('div');
      notification.id = 'rsvp-notification';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 12px;
      `;

      // Set colors based on type and theme
      const isLightMode = document.body.classList.contains('light-mode');
      
      if (type === 'error') {
        if (isLightMode) {
          notification.style.backgroundColor = '#fee2e2';
          notification.style.color = '#991b1b';
          notification.style.borderLeft = '4px solid #dc2626';
        } else {
          notification.style.backgroundColor = '#7f1d1d';
          notification.style.color = '#fecaca';
          notification.style.borderLeft = '4px solid #ef4444';
        }
        notification.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" style="flex-shrink: 0;">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <span>${escapeHtml(message)}</span>
        `;
      } else if (type === 'success') {
        if (isLightMode) {
          notification.style.backgroundColor = '#d1fae5';
          notification.style.color = '#065f46';
          notification.style.borderLeft = '4px solid #10b981';
        } else {
          notification.style.backgroundColor = '#064e3b';
          notification.style.color = '#6ee7b7';
          notification.style.borderLeft = '4px solid #10b981';
        }
        notification.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" style="flex-shrink: 0;">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <span>${escapeHtml(message)}</span>
        `;
      } else {
        if (isLightMode) {
          notification.style.backgroundColor = '#dbeafe';
          notification.style.color = '#1e40af';
          notification.style.borderLeft = '4px solid #3b82f6';
        } else {
          notification.style.backgroundColor = '#1e3a8a';
          notification.style.color = '#93c5fd';
          notification.style.borderLeft = '4px solid #3b82f6';
        }
        notification.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" style="flex-shrink: 0;">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
          </svg>
          <span>${escapeHtml(message)}</span>
        `;
      }

      // Add animation
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes slideOut {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(100%);
            opacity: 0;
          }
        }
      `;
      if (!document.getElementById('rsvp-notification-styles')) {
        style.id = 'rsvp-notification-styles';
        document.head.appendChild(style);
      }

      // Add to page
      document.body.appendChild(notification);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }, 5000);

      // Allow manual close on click
      notification.addEventListener('click', () => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      });
    }

    // Handle RSVP
    async function handleRSVP(eventId, action) {
      try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        if (!csrfToken) {
          alert('Security token not found. Please refresh the page and try again.');
          return;
        }

        // Disable button during request
        const eventCard = document.querySelector(`.event-card[data-event-id="${eventId}"]`);
        const button = eventCard ? eventCard.querySelector('.rsvp-btn') : null;
        if (button) {
          button.disabled = true;
          const originalText = button.textContent;
          button.textContent = 'Processing...';
          button.setAttribute('data-original-text', originalText);
        }

        const response = await fetch(`/student/events/${eventId}/rsvp`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            action: action,
            status: action === 'going' ? 'going' : 'interested',
            _csrf: csrfToken
          })
        });

        // Check if response is JSON before parsing
        const contentType = response.headers.get('content-type');
        let data;
        
        if (contentType && contentType.includes('application/json')) {
          try {
            data = await response.json();
          } catch (jsonError) {
            // If JSON parsing fails, it might be an HTML error page
            const textResponse = await response.text();
            console.error('Failed to parse JSON response:', textResponse.substring(0, 200));
            throw new Error('The server returned an unexpected response. Please refresh the page and try again.');
          }
        } else {
          // Response is not JSON (likely HTML error page)
          const textResponse = await response.text();
          console.error('Non-JSON response received:', textResponse.substring(0, 200));
          
          if (response.status === 401 || response.status === 403) {
            throw new Error('Your session has expired. Please refresh the page and log in again.');
          } else if (response.status === 404) {
            throw new Error('Event not found. It may have been removed.');
          } else if (response.status >= 500) {
            throw new Error('Server error occurred. Please try again later.');
          } else {
            throw new Error('Unable to process your RSVP request. Please refresh the page and try again.');
          }
        }

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Failed to process RSVP');
        }

        // Update the event in the events array
        const eventIndex = events.findIndex(e => e.id === eventId);
        if (eventIndex !== -1) {
          const event = events[eventIndex];
          const oldStatus = event.rsvp_status || 'not_responded';
          const newStatus = data.rsvp_status || 'not_responded';
          
          // Update RSVP status
          event.rsvp_status = newStatus;
          
          // Update counts based on status change
          if (oldStatus === 'going' && newStatus !== 'going') {
            // Was going, now not going - decrease going count
            event.going_count = Math.max(0, (event.going_count || 0) - 1);
          } else if (oldStatus === 'interested' && newStatus !== 'interested') {
            // Was interested, now not interested - decrease interested count
            event.interested_count = Math.max(0, (event.interested_count || 0) - 1);
          }
          
          if (newStatus === 'going' && oldStatus !== 'going') {
            // Now going, wasn't before - increase going count
            event.going_count = (event.going_count || 0) + 1;
            // If was interested, decrease interested count
            if (oldStatus === 'interested') {
              event.interested_count = Math.max(0, (event.interested_count || 0) - 1);
            }
          } else if (newStatus === 'interested' && oldStatus !== 'interested') {
            // Now interested, wasn't before - increase interested count
            event.interested_count = (event.interested_count || 0) + 1;
            // If was going, decrease going count
            if (oldStatus === 'going') {
              event.going_count = Math.max(0, (event.going_count || 0) - 1);
            }
          }
        }

        // Update button state immediately
        if (button) {
          button.disabled = false;
          const event = events.find(e => e.id === eventId);
          if (event) {
            button.textContent = event.rsvp_status === 'going' ? '‚úì Going' : 'RSVP';
            button.className = `rsvp-btn ${event.rsvp_status === 'going' ? 'going' : ''}`;
            // Update onclick to reflect new state
            button.setAttribute('onclick', `handleRSVP(${eventId}, '${event.rsvp_status === 'going' ? 'cancel' : 'going'}')`);
          }
        }

        // Re-render events to reflect changes (updates counts and filters)
        renderEvents();

        // Show success message
        if (action === 'cancel') {
          showNotification('RSVP removed successfully', 'success');
        } else {
          showNotification(data.message || 'RSVP updated successfully!', 'success');
        }
      } catch (error) {
        console.error('RSVP error:', error);
        
        // Show user-friendly error message
        let errorMessage = 'An error occurred while processing your RSVP.';
        
        if (error.message) {
          errorMessage = error.message;
        } else if (error.name === 'TypeError' && error.message.includes('JSON')) {
          errorMessage = 'Unable to connect to the server. Please check your internet connection and try again.';
        } else if (error.name === 'NetworkError' || error.message.includes('fetch')) {
          errorMessage = 'Network error. Please check your internet connection and try again.';
        }
        
        // Show styled error notification
        showNotification(errorMessage, 'error');
        
        // Re-enable button
        const eventCard = document.querySelector(`.event-card[data-event-id="${eventId}"]`);
        const button = eventCard ? eventCard.querySelector('.rsvp-btn') : null;
        if (button) {
          button.disabled = false;
          const event = events.find(e => e.id === eventId);
          if (event) {
            button.textContent = event.rsvp_status === 'going' ? '‚úì Going' : 'RSVP';
            button.className = `rsvp-btn ${event.rsvp_status === 'going' ? 'going' : ''}`;
            // Update onclick to reflect new state
            button.setAttribute('onclick', `handleRSVP(${eventId}, '${event.rsvp_status === 'going' ? 'cancel' : 'going'}')`);
          } else {
            // Fallback to original text
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
              button.textContent = originalText;
            }
          }
        }
      }
    }

    // Initial render
    sortEvents('date');
    renderEvents();
  </script>
</body>
</html>

