<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title || 'Communication Center | UniClub' %></title>
  <link rel="icon" href="https://phshirt.com/wp-content/uploads/2022/01/UM-Tagum-College-1950.png" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    const renderLucideIcons = (options) => {
      if (window.lucide?.createIcons) {
        window.lucide.createIcons(options);
      } else if (window.lucide?.replace) {
        window.lucide.replace(options);
      }
    };

    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'sans-serif'] },
          colors: {
            primary: { 700: '#7a0e0e', 800: '#6a0c0c', 900: '#5b0a0a' }
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="font-sans antialiased bg-gradient-to-br from-gray-50 to-gray-100">
  <% const safeAnnouncements = (typeof announcements !== 'undefined' && Array.isArray(announcements)) ? announcements : []; %>
  <% const safeActivityLog = (typeof activityLog !== 'undefined' && Array.isArray(activityLog)) ? activityLog : []; %>
  <% const isAdminView = typeof admin !== 'undefined' && !officer; %>
  <% const profileName = isAdminView ? ((admin && admin.username) || 'Admin') : ((typeof officer !== 'undefined' && officer && officer.name) ? officer.name : 'Student'); %>
  <% const profileRole = isAdminView ? 'Administrator' : ((typeof officer !== 'undefined' && officer && officer.role) ? officer.role : 'Club Officer'); %>
  <% const homeHref = isAdminView ? '/admin/dashboard' : '/officer'; %>
  <% const homeLabel = isAdminView ? 'Admin Home' : 'Back to Dashboard'; %>
  <div class="flex h-screen">
    <!-- Sidebar -->
    <% if (isAdminView) { %>
      <div id="sidebar" class="hidden lg:block w-64 bg-white shadow-xl overflow-y-auto">
        <%- include('../layouts/adminSidebar', {
          currentPath: (typeof currentPath !== 'undefined' ? currentPath : '/admin/communication'),
          messages: (typeof messages !== 'undefined' ? messages : [])
        }) %>
      </div>
    <% } else { %>
      <%- include('./partials/sidebar', {
        activePage: 'communication',
        club: (typeof club !== 'undefined' ? club : null)
      }) %>
            <% } %>

    <!-- Main -->
    <main class="flex-1 overflow-auto">
      <header class="bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60 border-b border-gray-200 sticky top-0 z-10">
        <div class="flex items-center justify-between px-6 md:px-8 py-4">
          <div>
            <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 tracking-tight">Communication Center</h1>
            <p class="text-gray-500 mt-1 text-sm"><%= isAdminView ? 'Plan, send, and monitor announcements across all clubs.' : 'Plan, send, and review updates for your club.' %></p>
          </div>
          <div class="relative flex items-center gap-3 md:gap-5">
            <!-- Notifications -->
            <div class="relative">
              <button id="notifBtn" class="relative p-2 hover:bg-gray-100 rounded-lg transition-colors" aria-haspopup="true" aria-expanded="false" aria-controls="notifMenu">
                <i data-lucide="bell" class="w-5 h-5 text-gray-700"></i>
                <% if ((typeof pendingCount !== 'undefined' ? pendingCount : 0) > 0) { %>
                  <span class="absolute -top-0.5 -right-0.5 min-w-4 h-4 px-1 bg-red-600 text-white text-[10px] leading-4 rounded-full text-center"><%= pendingCount %></span>
                <% } %>
              </button>
              <div id="notifMenu" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-xl border border-gray-200 shadow-lg overflow-hidden z-[9999]">
                <div class="px-3 py-2 border-b">
                  <p class="text-sm font-semibold text-gray-800">Notifications</p>
                </div>
                <ul class="max-h-80 overflow-auto">
                  <%
                    var notifItems = [];
                    if (safeAnnouncements.length) {
                      notifItems = safeAnnouncements.slice(0, 5).map(function(a){ return { title: a.title, meta: new Date(a.created_at).toLocaleDateString() }; });
                    } else if ((typeof pendingCount !== 'undefined' ? pendingCount : 0) > 0) {
                      notifItems = [{ title: 'Pending membership applications', meta: (pendingCount + ' awaiting review') }];
                    }
                  %>
                  <% if (notifItems.length) { %>
                    <% notifItems.forEach(function(n){ %>
                      <li class="px-3 py-3 hover:bg-gray-50">
                        <p class="text-sm font-medium text-gray-800"><%= n.title %></p>
                        <p class="text-xs text-gray-500"><%= n.meta %></p>
                      </li>
                    <% }) %>
                  <% } else { %>
                    <li class="px-3 py-6 text-center text-sm text-gray-500">No new notifications</li>
                  <% } %>
                </ul>
                <div class="px-3 py-2 border-t bg-gray-50">
                  <button class="w-full text-left text-sm text-gray-700 hover:text-gray-900">View all</button>
                </div>
              </div>
            </div>
            <!-- Profile -->
            <div class="relative pl-2 md:pl-4 border-l border-gray-200">
              <button id="profileBtn" class="flex items-center gap-3 hover:bg-gray-100 px-2 py-1.5 rounded-lg" aria-haspopup="true" aria-expanded="false" aria-controls="profileMenu">
                <div class="text-right hidden sm:block">
                  <p class="text-sm font-semibold text-gray-900"><%= profileName %></p>
                  <p class="text-xs text-gray-600"><%= profileRole %></p>
                </div>
                <% if (!isAdminView && typeof officer !== 'undefined' && officer && officer.photo_url) { %>
                  <img src="<%= officer.photo_url %>" alt="Profile" class="w-11 h-11 rounded-full ring-2 ring-red-600 object-cover">
                <% } else { %>
                  <div class="w-11 h-11 rounded-full ring-2 ring-red-600 bg-gray-200 flex items-center justify-center text-xs text-gray-600">
                    <%= isAdminView ? 'AD' : 'UC' %>
                  </div>
                <% } %>
              </button>
              <div id="profileMenu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-xl border border-gray-200 shadow-lg overflow-hidden z-[9999]">
                <div class="p-4 bg-gray-50 border-b">
                  <p class="font-semibold text-gray-800"><%= profileName %></p>
                  <p class="text-sm text-gray-500"><%= profileRole %></p>
                  <% if (!isAdminView && typeof club !== 'undefined' && club) { %>
                    <p class="text-xs text-gray-500 mt-1"><%= club.name %></p>
                  <% } %>
                </div>
                <div class="p-2">
                  <% if (isAdminView) { %>
                    <a href="/admin/profile" class="block px-3 py-2 rounded-lg hover:bg-gray-50 text-sm">Admin Profile</a>
                    <a href="/admin/settings" class="block px-3 py-2 rounded-lg hover:bg-gray-50 text-sm">Settings</a>
                  <% } else { %>
                    <a href="/officer/profile" class="block px-3 py-2 rounded-lg hover:bg-gray-50 text-sm">View Profile</a>
                    <a href="/officer/settings" class="block px-3 py-2 rounded-lg hover:bg-gray-50 text-sm">Settings</a>
                  <% } %>
                  <a href="/help" class="block px-3 py-2 rounded-lg hover:bg-gray-50 text-sm">Help & Support</a>
                </div>
                <div class="border-t p-2 bg-gray-50">
                  <% if (isAdminView) { %>
                    <form action="/admin/logout" method="POST">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button type="submit" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm text-red-600">Logout</button>
                    </form>
                  <% } else { %>
                    <form action="/officer/logout" method="POST">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button type="submit" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm text-red-600">Logout</button>
                    </form>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="p-6 md:p-8 space-y-8">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
          <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex flex-col gap-4">
            <div class="flex items-center gap-3">
              <span class="w-10 h-10 rounded-2xl bg-primary-800/10 text-primary-900 flex items-center justify-center">
                <i data-lucide="megaphone" class="w-5 h-5"></i>
              </span>
              <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Total Announcements</p>
                <p class="text-xs text-gray-400">This month</p>
              </div>
            </div>
            <div class="flex items-end justify-between">
              <h3 class="text-3xl font-extrabold text-gray-900"><%= (stats && stats.total) ? stats.total : 0 %></h3>
              <span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 font-semibold">Last 30 days</span>
            </div>
            <% if (!stats || !stats.total) { %>
              <p class="text-xs text-gray-400">You’ll see metrics here after you send your first announcement.</p>
            <% } %>
          </div>

          <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex flex-col gap-4">
            <div class="flex items-center gap-3">
              <span class="w-10 h-10 rounded-2xl bg-indigo-100 text-indigo-700 flex items-center justify-center">
                <i data-lucide="target" class="w-5 h-5"></i>
              </span>
              <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Targeted Sends</p>
                <p class="text-xs text-gray-400">Last 30 days</p>
              </div>
            </div>
            <div class="flex items-end justify-between">
              <h3 class="text-3xl font-extrabold text-gray-900"><%= (stats && stats.targeted) ? stats.targeted : 0 %></h3>
              <span class="text-xs px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 font-semibold">
                <%= (stats && stats.total) ? Math.round(((stats.targeted || 0) / stats.total) * 100) : 0 %>% of total
              </span>
            </div>
            <% if (!stats || !stats.total) { %>
              <p class="text-xs text-gray-400">Use audience targeting to keep updates relevant.</p>
            <% } %>
          </div>

          <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex flex-col gap-4">
            <div class="flex items-center gap-3">
              <span class="w-10 h-10 rounded-2xl bg-amber-100 text-amber-700 flex items-center justify-center">
                <i data-lucide="clock-3" class="w-5 h-5"></i>
              </span>
              <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Scheduled</p>
                <p class="text-xs text-gray-400">Next 7 days</p>
              </div>
            </div>
            <div class="flex items-end justify-between">
              <h3 class="text-3xl font-extrabold text-gray-900"><%= (stats && stats.scheduled) ? stats.scheduled : 0 %></h3>
              <span class="text-xs px-2 py-1 rounded-full bg-amber-50 text-amber-700 font-semibold">Upcoming</span>
            </div>
            <% if (!stats || !stats.scheduled) { %>
              <p class="text-xs text-gray-400">Schedule messages to stay ahead of busy weeks.</p>
              <% } %>
          </div>

          <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex flex-col gap-4">
            <div class="flex items-center gap-3">
              <span class="w-10 h-10 rounded-2xl bg-emerald-100 text-emerald-700 flex items-center justify-center">
                <i data-lucide="mail" class="w-5 h-5"></i>
              </span>
              <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Email Reach</p>
                <p class="text-xs text-gray-400">Last 30 days</p>
              </div>
            </div>
            <div class="flex items-end justify-between">
              <h3 class="text-3xl font-extrabold text-gray-900"><%= (stats && stats.emailReach) ? stats.emailReach : 0 %></h3>
              <span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 font-semibold">Members</span>
            </div>
            <% if (!stats || !stats.emailReach) { %>
              <p class="text-xs text-gray-400">Enable email sends to boost visibility.</p>
            <% } %>
          </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-[minmax(0,520px)_1fr] gap-6 items-start">
          <!-- Composer -->
          <section class="space-y-6">
            <div class="bg-white rounded-3xl shadow-xl border border-gray-200">
              <div class="flex items-center justify-between gap-4 px-6 py-4 border-b border-gray-200 bg-gray-50 rounded-t-3xl">
                <div>
                  <p class="text-xs font-semibold tracking-[0.2em] text-primary-800 uppercase">Compose</p>
                  <h2 class="text-xl font-semibold text-gray-900">Compose Announcement</h2>
                  <p class="text-sm text-gray-500">Your job here is to write and send updates—review them on the right.</p>
                </div>
                <span class="text-xs font-semibold text-emerald-700 bg-emerald-50 px-3 py-1 rounded-full">Primary Action</span>
              </div>
              <form id="newAnnouncementForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label for="announcementTitle" class="block text-sm font-medium text-gray-800">Subject</label>
                    <p class="text-xs text-gray-500 mb-2">Appears in the feed and email subject line.</p>
                    <input id="announcementTitle" type="text" required maxlength="120" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-800" placeholder="e.g. Officers meeting tomorrow">
                </div>
                <div>
                    <label for="announcementAudience" class="block text-sm font-medium text-gray-800">Audience</label>
                    <p class="text-xs text-gray-500 mb-2">Choose who should see this update.</p>
                    <select id="announcementAudience" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-800">
                    <% (audienceOptions || ['All Members', 'Officers Only', 'New Members']).forEach(function(option) { %>
                      <option value="<%= option %>"><%= option %></option>
                    <% }); %>
                  </select>
                </div>
                </div>

                <div>
                  <label for="announcementMessage" class="block text-sm font-medium text-gray-800">Message</label>
                  <p class="text-xs text-gray-500 mb-2">Details, reminders, and next steps the recipients need.</p>
                  <textarea id="announcementMessage" rows="5" maxlength="600" required class="w-full px-3 py-2 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary-800" placeholder="Details, reminder, and any next steps the recipient needs to take. Include dates, locations, or links."></textarea>
                  <div class="flex items-center justify-between mt-1">
                    <p class="text-xs text-gray-400" id="messageCounter">0 / 600 characters</p>
                    <div class="text-[11px] text-gray-400 flex gap-4">
                      <span>Be specific</span>
                      <span>Add dates & links</span>
                      <span>Include call to action</span>
                    </div>
                  </div>
                </div>

                <button type="button" id="advancedOptionsToggle" class="w-full flex items-center justify-between px-4 py-2 text-sm font-semibold text-primary-800 bg-primary-50 rounded-2xl border border-primary-100">
                  <span>Advanced options</span>
                  <span class="flex items-center gap-2 text-xs font-normal text-primary-600">
                    <span id="advancedToggleLabel">Show</span>
                    <span id="advancedChevron" class="transition-transform">
                      <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </span>
                  </span>
                </button>

                <div id="advancedOptions" class="space-y-4 hidden">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <label for="prioritySelect" class="block text-sm font-medium text-gray-800">Priority</label>
                      <select id="prioritySelect" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-800">
                        <option value="normal" selected>Normal</option>
                        <option value="important">Important</option>
                        <option value="urgent">Urgent</option>
                      </select>
                    </div>
                    <div>
                      <label for="categorySelect" class="block text-sm font-medium text-gray-800">Category</label>
                      <select id="categorySelect" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-800">
                        <option value="general">General update</option>
                        <option value="event">Event reminder</option>
                        <option value="deadline">Deadline</option>
                        <option value="announcement">Announcement</option>
                      </select>
                    </div>
                  </div>

                  <div class="flex flex-col gap-4 border border-gray-100 rounded-2xl p-4 bg-gray-50">
                    <label class="flex items-center justify-between gap-3">
                      <div>
                        <p class="text-sm font-medium text-gray-800">Also send as email</p>
                        <p class="text-xs text-gray-500">Recommended for time-sensitive updates.</p>
                      </div>
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="sendEmail" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-primary-800 transition"></div>
                        <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-5"></span>
                      </label>
                    </label>

                    <div class="flex flex-wrap gap-4 text-sm text-gray-700">
                      <label class="inline-flex items-center gap-2">
                        <input type="checkbox" id="pinAnnouncement" class="rounded border-gray-300 text-primary-800 focus:ring-primary-800">
                        Pin announcement to feed top
                      </label>
                      <label class="inline-flex items-center gap-2">
                        <input type="checkbox" id="markImportant" class="rounded border-gray-300 text-primary-800 focus:ring-primary-800">
                        Mark as important (red badge)
                      </label>
                    </div>
                  </div>

                  <div class="space-y-3 border border-gray-100 rounded-2xl p-4">
                    <p class="text-sm font-semibold text-gray-800">Schedule</p>
                    <div class="flex flex-col gap-3 text-sm text-gray-600">
                      <label class="inline-flex items-center gap-2">
                        <input type="radio" name="scheduleOption" value="now" class="text-primary-800 focus:ring-primary-800" checked>
                        Send now
                      </label>
                      <label class="inline-flex items-center gap-3">
                        <input type="radio" name="scheduleOption" value="later" class="text-primary-800 focus:ring-primary-800">
                        <span>Schedule for later</span>
                        <input type="datetime-local" id="scheduleDatetime" class="flex-1 px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-800 hidden">
                      </label>
                    </div>
                  </div>

                  <div class="space-y-3 border border-dashed rounded-2xl p-4 text-center">
                    <p class="text-sm font-semibold text-gray-800">Attachments</p>
                    <p class="text-xs text-gray-500">Attach PDFs, images, or other files for more context.</p>
                    <label class="inline-flex items-center gap-2 px-4 py-2 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 cursor-pointer hover:bg-gray-50">
                      <i data-lucide="paperclip" class="w-4 h-4"></i>
                      Attach file
                      <input type="file" id="announcementAttachment" class="hidden" multiple>
                  </label>
                    <p id="attachmentList" class="text-xs text-gray-500"></p>
                  </div>
                </div>

                <div class="flex flex-wrap gap-3 items-center">
                  <button type="submit" class="inline-flex items-center gap-2 px-5 py-3 rounded-2xl bg-primary-800 text-white font-semibold hover:bg-primary-900 focus:ring-2 focus:ring-offset-2 focus:ring-primary-800" data-action="publish">
                    <i data-lucide="send" class="w-4 h-4"></i>
                    Publish
                  </button>
                  <button type="button" class="inline-flex items-center gap-2 px-4 py-3 rounded-2xl bg-white border border-gray-200 text-gray-800 font-semibold hover:bg-gray-50" id="saveDraftBtn">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    Save Draft
                  </button>
                  <button type="button" class="inline-flex items-center gap-2 px-4 py-3 rounded-2xl border border-transparent text-primary-800 hover:bg-primary-50 font-semibold" id="previewBtn">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    Preview
                  </button>
                </div>
                <p class="text-xs text-gray-400">Drafts can be edited and sent later from Recent Announcements.</p>

                <div class="flex flex-wrap gap-3 text-xs text-gray-500 border-t border-dashed pt-3">
                  <span class="inline-flex items-center gap-1">
                    <i data-lucide="check" class="w-3 h-3 text-emerald-500"></i> Keep it action-oriented.
                  </span>
                  <span class="inline-flex items-center gap-1">
                    <i data-lucide="check" class="w-3 h-3 text-emerald-500"></i> Add dates & links.
                  </span>
                  <span class="inline-flex items-center gap-1">
                    <i data-lucide="check" class="w-3 h-3 text-emerald-500"></i> Mention who needs to respond.
                  </span>
                </div>
              </form>
            </div>
          </section>

          <!-- Timeline -->
          <section class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 space-y-6">
            <div class="flex flex-wrap gap-3 items-center justify-between">
              <div>
                <p class="text-xs font-semibold tracking-[0.2em] text-primary-800 uppercase">History</p>
                <h2 class="text-xl font-semibold text-gray-900">Manage communications</h2>
                <p class="text-sm text-gray-500">Review drafts, scheduled sends, and recent activity.</p>
              </div>
              <div class="flex items-center gap-2 bg-gray-50 rounded-full p-1 text-sm">
                <button class="px-4 py-1.5 rounded-full bg-primary-800 text-white font-semibold" data-tab-trigger="announcements">Announcements</button>
                <button class="px-4 py-1.5 rounded-full text-gray-600 hover:bg-white rounded-full" data-tab-trigger="activity">Activity Log</button>
              </div>
            </div>

            <div data-tab-panel="announcements" class="space-y-4">
              <div class="flex flex-wrap gap-3 items-center justify-between">
              <div class="flex flex-wrap gap-2">
                  <div class="relative">
                    <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-3.5"></i>
                    <input id="announcementSearch" type="search" placeholder="Search subject..." class="pl-9 pr-3 py-2 border rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-800">
                  </div>
                  <select id="audienceFilter" class="px-3 py-2 border rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-800">
                  <option value="all">All audiences</option>
                  <% (audienceOptions || ['All Members', 'Officers Only', 'New Members']).forEach(function(option) { %>
                    <option value="<%= option.toLowerCase() %>"><%= option %></option>
                  <% }); %>
                </select>
                  <select id="statusFilter" class="px-3 py-2 border rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-800">
                    <option value="all">All statuses</option>
                    <option value="draft">Draft</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="sent">Sent</option>
                </select>
              </div>
                <select id="dateRangeFilter" class="px-3 py-2 border rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-800">
                  <option value="30">Last 30 days</option>
                  <option value="90">Last 90 days</option>
                  <option value="all">All time</option>
                </select>
            </div>

              <ul id="announcementList" class="space-y-4 max-h-[calc(100vh-360px)] overflow-y-auto pr-2">
                <% if (safeAnnouncements && safeAnnouncements.length) { %>
                  <% safeAnnouncements.forEach(function(announcement) { %>
                    <% const status = (announcement.status || 'sent').toLowerCase(); %>
                    <li class="border border-gray-100 rounded-2xl p-5 hover:border-gray-200 transition flex gap-4" data-audience="<%= (announcement.audience || 'all').toLowerCase() %>" data-title="<%= (announcement.title || '').toLowerCase() %>" data-status="<%= status %>">
                      <div class="flex-shrink-0">
                        <span class="w-10 h-10 rounded-2xl flex items-center justify-center <%= status === 'draft' ? 'bg-gray-100 text-gray-600' : status === 'scheduled' ? 'bg-amber-100 text-amber-700' : 'bg-primary-800/10 text-primary-900' %>">
                          <i data-lucide="<%= announcement.icon || 'megaphone' %>" class="w-5 h-5"></i>
                        </span>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="flex flex-wrap gap-2 items-center">
                          <p class="text-xs uppercase tracking-wide text-primary-700 font-semibold"><%= announcement.audience || 'All Members' %></p>
                          <span class="text-xs px-2 py-0.5 rounded-full <%= status === 'draft' ? 'bg-gray-100 text-gray-600' : status === 'scheduled' ? 'bg-amber-100 text-amber-800' : 'bg-emerald-100 text-emerald-800' %>"><%= status.charAt(0).toUpperCase() + status.slice(1) %></span>
                          <% if (announcement.email) { %>
                            <span class="text-[11px] text-gray-500 inline-flex items-center gap-1">
                              <i data-lucide="mail" class="w-3 h-3"></i> Email
                            </span>
                          <% } %>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 truncate"><%= announcement.title || 'Untitled announcement' %></h3>
                        <p class="text-sm text-gray-600 mt-1 line-clamp-2"><%= announcement.message || '' %></p>
                        <p class="text-xs text-gray-500 mt-2">By <%= announcement.author || 'Officer' %> •
                          <%= announcement.created_at ? new Date(announcement.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' }) : 'Just now' %>
                          <% if (announcement.deliveryInfo) { %>
                            • <%= announcement.deliveryInfo %>
                          <% } %>
                        </p>
                      </div>
                      <div class="flex flex-col gap-2">
                        <% if (status === 'draft') { %>
                          <button class="text-sm font-semibold text-primary-800 hover:underline">Edit & Publish</button>
                        <% } else if (status === 'scheduled') { %>
                          <button class="text-sm font-semibold text-primary-800 hover:underline">Edit</button>
                          <button class="text-sm text-gray-500 hover:text-gray-700">Cancel</button>
                        <% } else { %>
                          <button class="text-sm font-semibold text-primary-800 hover:underline">View</button>
                        <% } %>
                      </div>
                    </li>
                  <% }) %>
                <% } else { %>
                  <li class="text-center text-gray-500 text-sm py-16 flex flex-col items-center gap-3">
                    <i data-lucide="megaphone" class="w-8 h-8 text-gray-400"></i>
                    <p class="font-semibold text-gray-700">No announcements yet</p>
                    <p class="text-sm text-gray-500 max-w-sm">Compose your first message using the panel on the left to see it listed here.</p>
                    <button class="text-sm font-semibold text-primary-800 hover:underline" id="jumpToCompose">Compose now</button>
                  </li>
                <% } %>
              </ul>
            </div>

            <div data-tab-panel="activity" class="hidden space-y-4">
              <ul id="activityLog" class="space-y-3 max-h-[calc(100vh-360px)] overflow-y-auto pr-2">
                <% if (safeActivityLog && safeActivityLog.length) { %>
                  <% safeActivityLog.forEach(function(item) { %>
                    <li class="flex items-start gap-3 border border-gray-100 rounded-2xl p-4">
                      <span class="w-8 h-8 rounded-2xl bg-gray-50 flex items-center justify-center text-gray-600">
                        <i data-lucide="<%= item.icon || 'activity' %>" class="w-4 h-4"></i>
                      </span>
                      <div class="flex-1">
                        <p class="text-sm text-gray-800"><strong><%= item.actor || 'Officer' %></strong> <%= item.action || 'updated an announcement' %> <span class="font-semibold text-gray-900">“<%= item.subject || 'Untitled' %>”</span>.</p>
                        <p class="text-xs text-gray-500 mt-1"><%= item.time || 'Just now' %></p>
                    </div>
                  </li>
                <% }) %>
              <% } else { %>
                  <li class="text-center text-gray-500 text-sm py-12 flex flex-col items-center gap-2">
                    <i data-lucide="activity" class="w-8 h-8 text-gray-400"></i>
                    <p class="font-semibold text-gray-700">No activity logged yet</p>
                    <p class="text-sm text-gray-500">You’ll see publish, edit, and schedule changes here.</p>
                  </li>
              <% } %>
            </ul>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Ensure sidebar stays expanded + Records section available
    const sidebar = document.getElementById('sidebar');
    function expandSidebar() {
      if (!sidebar) return;
      sidebar.classList.remove('w-20');
      sidebar.classList.add('w-64');
      document.querySelectorAll('.sidebar-label').forEach((el) => el.classList.remove('hidden'));
      const brandText = document.getElementById('sidebarBrandText');
      const brandLogo = document.getElementById('sidebarBrandLogo');
      if (brandText) brandText.classList.remove('hidden');
      if (brandLogo) brandLogo.classList.remove('hidden');
      try { localStorage.removeItem('sidebarCollapsed'); } catch (err) {}
    }
    expandSidebar();

    const recordsToggle = document.getElementById('recordsToggle');
    const recordsGroup = document.getElementById('recordsGroup');
    const recordsChevron = document.getElementById('recordsChevron');
    if (recordsToggle && recordsGroup) {
      recordsToggle.addEventListener('click', () => {
        const isHidden = recordsGroup.classList.contains('hidden');
        recordsGroup.classList.toggle('hidden');
        if (recordsChevron) {
          recordsChevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
        }
      });
    }

    const messageField = document.getElementById('announcementMessage');
    const counter = document.getElementById('messageCounter');
    if (messageField && counter) {
      messageField.addEventListener('input', () => {
        const val = messageField.value || '';
        counter.textContent = `${val.length} / 600 characters`;
      });
    }

    const announcementList = document.getElementById('announcementList');
    const form = document.getElementById('newAnnouncementForm');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const previewBtn = document.getElementById('previewBtn');
    const attachmentInput = document.getElementById('announcementAttachment');
    const attachmentList = document.getElementById('attachmentList');
    const advancedToggle = document.getElementById('advancedOptionsToggle');
    const advancedSection = document.getElementById('advancedOptions');
    const advancedToggleLabel = document.getElementById('advancedToggleLabel');
    const advancedChevronWrapper = document.getElementById('advancedChevron');
    const toastContainer = document.createElement('div');
    toastContainer.className = 'fixed bottom-6 right-6 space-y-2 z-50';
    document.body.appendChild(toastContainer);

    function showToast(message, type = 'success') {
      const colors = type === 'success'
        ? 'bg-emerald-600 text-white'
        : 'bg-amber-500 text-white';
      const toast = document.createElement('div');
      toast.className = `${colors} px-4 py-3 rounded-2xl shadow-lg flex items-center gap-2 text-sm`;
      toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-4 h-4"></i>${message}`;
      toastContainer.appendChild(toast);
      renderLucideIcons({ root: toast });
      setTimeout(() => toast.remove(), 4000);
    }

    function toggleSubmitting(isSubmitting) {
      const publishBtn = form?.querySelector('button[data-action="publish"]');
      if (!publishBtn) return;
      publishBtn.disabled = isSubmitting;
      publishBtn.innerHTML = isSubmitting
        ? '<svg class="animate-spin h-4 w-4 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a12 12 0 00-12 12h4z"></path></svg> Publishing…'
        : '<i data-lucide="send" class="w-4 h-4"></i>Publish';
      if (!isSubmitting) renderLucideIcons({ root: publishBtn });
    }

    if (attachmentInput && attachmentList) {
      attachmentInput.addEventListener('change', () => {
        const files = Array.from(attachmentInput.files || []);
        attachmentList.textContent = files.length
          ? files.map(file => file.name).join(', ')
          : '';
      });
    }

    advancedToggle?.addEventListener('click', () => {
      const isHidden = advancedSection?.classList.toggle('hidden');
      if (advancedToggleLabel) advancedToggleLabel.textContent = isHidden ? 'Show' : 'Hide';
      if (advancedChevronWrapper) {
        advancedChevronWrapper.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
      }
    });

    const scheduleRadios = document.querySelectorAll('input[name="scheduleOption"]');
    const scheduleDatetime = document.getElementById('scheduleDatetime');
    scheduleRadios.forEach((radio) => {
      radio.addEventListener('change', () => {
        if (radio.value === 'later' && radio.checked) {
          scheduleDatetime.classList.remove('hidden');
          scheduleDatetime.required = true;
        } else {
          scheduleDatetime.classList.add('hidden');
          scheduleDatetime.required = false;
          scheduleDatetime.value = '';
        }
      });
    });

    function getFormPayload(defaultStatus = 'sent') {
        const title = document.getElementById('announcementTitle').value.trim();
        const audience = document.getElementById('announcementAudience').value.trim();
        const message = (document.getElementById('announcementMessage').value || '').trim();
      const email = document.getElementById('sendEmail').checked;
      const scheduleOption = document.querySelector('input[name="scheduleOption"]:checked')?.value || 'now';
      const scheduledAt = scheduleOption === 'later' ? scheduleDatetime?.value : null;
      const status = scheduleOption === 'later' && defaultStatus === 'sent' ? 'scheduled' : defaultStatus;
      return { title, audience, message, email, status, scheduledAt };
    }

    function prependAnnouncementCard(payload) {
      const { title, audience, message, status } = payload;
        const li = document.createElement('li');
      li.className = 'border border-gray-100 rounded-2xl p-5 hover:border-gray-200 transition flex gap-4';
        li.dataset.audience = (audience || 'all').toLowerCase();
        li.dataset.title = title.toLowerCase();
      li.dataset.status = status;
        li.innerHTML = `
        <div class="flex-shrink-0">
          <span class="w-10 h-10 rounded-2xl flex items-center justify-center ${status === 'draft' ? 'bg-gray-100 text-gray-600' : status === 'scheduled' ? 'bg-amber-100 text-amber-700' : 'bg-primary-800/10 text-primary-900'}">
            <i data-lucide="megaphone" class="w-5 h-5"></i>
          </span>
            </div>
        <div class="flex-1 min-w-0">
          <div class="flex flex-wrap gap-2 items-center">
            <p class="text-xs uppercase tracking-wide text-primary-700 font-semibold">${audience || 'All Members'}</p>
            <span class="text-xs px-2 py-0.5 rounded-full ${status === 'draft' ? 'bg-gray-100 text-gray-600' : status === 'scheduled' ? 'bg-amber-100 text-amber-800' : 'bg-emerald-100 text-emerald-800'}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 truncate">${title}</h3>
          <p class="text-sm text-gray-600 mt-1 line-clamp-2">${message}</p>
          <p class="text-xs text-gray-500 mt-2">By You • Just now</p>
        </div>
        <div class="flex flex-col gap-2">
          ${status === 'draft'
            ? '<button class="text-sm font-semibold text-primary-800 hover:underline">Edit & Publish</button>'
            : status === 'scheduled'
              ? '<button class="text-sm font-semibold text-primary-800 hover:underline">Edit</button><button class="text-sm text-gray-500 hover:text-gray-700">Cancel</button>'
              : '<button class="text-sm font-semibold text-primary-800 hover:underline">View</button>'}
          </div>
        `;
      announcementList?.prepend(li);
      renderLucideIcons({ root: li });
    }

    if (form && announcementList) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const payload = getFormPayload('sent');
        if (!payload.title) {
          showToast('Please enter a subject.', 'warn');
          return;
        }
        if (!payload.message) {
          showToast('Please add a message for your audience.', 'warn');
          return;
        }
        if (payload.status === 'scheduled' && !payload.scheduledAt) {
          showToast('Choose a date and time to schedule this announcement.', 'warn');
          return;
        }
        toggleSubmitting(true);
        setTimeout(() => {
          prependAnnouncementCard(payload);
          showToast(`Announcement ${payload.status === 'scheduled' ? 'scheduled' : 'published'} • ${payload.status === 'scheduled' ? `Planned for ${payload.scheduledAt || 'later'}` : `Sent to ${payload.audience || 'All Members'}`}.`);
        form.reset();
          if (attachmentList) attachmentList.textContent = '';
        if (counter) counter.textContent = '0 / 600 characters';
          scheduleDatetime?.classList.add('hidden');
          scheduleDatetime.value = '';
          toggleSubmitting(false);
        }, 900);
      });
    }

    saveDraftBtn?.addEventListener('click', () => {
      const payload = getFormPayload('draft');
      if (!payload.title) {
        showToast('Please enter a subject before saving a draft.', 'warn');
        return;
      }
      prependAnnouncementCard(payload);
      showToast('Draft saved • Find it under Recent Announcements → Draft.');
    });

    previewBtn?.addEventListener('click', () => {
      const payload = getFormPayload('preview');
      if (!payload.title || !payload.message) {
        showToast('Add a subject and message before previewing.', 'warn');
        return;
      }
      showToast(`Preview: ${payload.title}\n${payload.message}`, 'info', 'Announcement Preview');
    });

    // Simple filters
    const audienceFilter = document.getElementById('audienceFilter');
    const searchInput = document.getElementById('announcementSearch');
    const statusFilter = document.getElementById('statusFilter');

    function applyFilters() {
      const audience = (audienceFilter?.value || 'all').toLowerCase();
      const query = (searchInput?.value || '').toLowerCase();
      const status = (statusFilter?.value || 'all').toLowerCase();
      announcementList?.querySelectorAll('li[data-audience]').forEach((li) => {
        const matchesAudience = audience === 'all' || li.dataset.audience === audience;
        const matchesSearch = !query || (li.dataset.title || '').includes(query);
        const matchesStatus = status === 'all' || (li.dataset.status || 'sent') === status;
        li.style.display = matchesAudience && matchesSearch && matchesStatus ? '' : 'none';
      });
    }

    if (audienceFilter) audienceFilter.addEventListener('change', applyFilters);
    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (statusFilter) statusFilter.addEventListener('change', applyFilters);

    // Tabs
    const tabButtons = document.querySelectorAll('[data-tab-trigger]');
    const tabPanels = document.querySelectorAll('[data-tab-panel]');
    tabButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.tabTrigger;
        tabButtons.forEach((b) => b.classList.remove('bg-primary-800', 'text-white'));
        btn.classList.add('bg-primary-800', 'text-white');
        tabPanels.forEach((panel) => panel.classList.toggle('hidden', panel.dataset.tabPanel !== target));
      });
    });

    document.getElementById('jumpToCompose')?.addEventListener('click', () => {
      document.getElementById('announcementTitle')?.scrollIntoView({ behavior: 'smooth' });
    });

    // Header dropdowns
    const notifBtn = document.getElementById('notifBtn');
    const notifMenu = document.getElementById('notifMenu');
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu = document.getElementById('profileMenu');

    function hideMenus() {
      if (notifMenu) notifMenu.classList.add('hidden');
      if (profileMenu) profileMenu.classList.add('hidden');
      if (notifBtn) notifBtn.setAttribute('aria-expanded', 'false');
      if (profileBtn) profileBtn.setAttribute('aria-expanded', 'false');
    }

    if (notifBtn && notifMenu) {
      notifBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isHidden = notifMenu.classList.contains('hidden');
        hideMenus();
        if (isHidden) {
          notifMenu.classList.remove('hidden');
          notifBtn.setAttribute('aria-expanded', 'true');
        }
      });
    }

    if (profileBtn && profileMenu) {
      profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isHidden = profileMenu.classList.contains('hidden');
        hideMenus();
        if (isHidden) {
          profileMenu.classList.remove('hidden');
          profileBtn.setAttribute('aria-expanded', 'true');
        }
      });
    }

    document.addEventListener('click', (e) => {
      const withinNotif = notifMenu && notifMenu.contains(e.target);
      const withinNotifBtn = notifBtn && notifBtn.contains(e.target);
      const withinProfile = profileMenu && profileMenu.contains(e.target);
      const withinProfileBtn = profileBtn && profileBtn.contains(e.target);
      if (!withinNotif && !withinNotifBtn && !withinProfile && !withinProfileBtn) {
        hideMenus();
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideMenus();
    });

    document.addEventListener('DOMContentLoaded', () => {
      renderLucideIcons();
    });
  </script>
</body>
</html>

