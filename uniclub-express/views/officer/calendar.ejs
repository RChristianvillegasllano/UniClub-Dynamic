<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title || 'Calendar | UniClub' %></title>
  <link rel="icon" href="https://phshirt.com/wp-content/uploads/2022/01/UM-Tagum-College-1950.png" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    const renderLucideIcons = (options) => {
      if (window.lucide?.createIcons) {
        window.lucide.createIcons(options);
      } else if (window.lucide?.replace) {
        window.lucide.replace(options);
      }
    };

    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'sans-serif'] },
          colors: {
            primary: { 700: '#7a0e0e', 800: '#6a0c0c', 900: '#5b0a0a' }
          }
        }
      }
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="font-sans antialiased bg-gradient-to-br from-gray-50 to-gray-100">
  <div class="flex h-screen">
    <%- include('./partials/sidebar', {
      activePage: 'calendar',
      club: (typeof club !== 'undefined' ? club : null),
      accessiblePages: (typeof accessiblePages !== 'undefined' ? accessiblePages : []),
      officer: (typeof officer !== 'undefined' ? officer : null)
    }) %>

    <main class="flex-1 overflow-auto">
      <header class="bg-white/90 backdrop-blur border-b border-gray-200 sticky top-0 z-10">
        <div class="px-6 md:px-8 py-4 flex items-center justify-between">
          <div>
            <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 tracking-tight">Event Calendar</h1>
            <p class="text-gray-500 mt-1 text-sm">View and manage club events</p>
          </div>
          <div class="flex flex-wrap gap-3">
            <% if (canCreateEvents) { %>
              <button onclick="openCreateEventModal()" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-xl bg-red-700 text-white hover:bg-red-800 transition-colors">
                <i data-lucide="plus" class="w-4 h-4"></i>
                Create Event
              </button>
            <% } %>
            <div class="flex items-center gap-2">
              <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i>
              </button>
              <span class="px-4 py-2 text-sm font-semibold text-gray-700 min-w-[150px] text-center">
                <%= new Date(currentYear, currentMonth - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) %>
              </span>
              <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i>
              </button>
            </div>
          </div>
        </div>
      </header>

      <div class="p-6 md:p-8">
        <!-- Calendar Grid -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
          <div class="grid grid-cols-7 gap-px bg-gray-200">
            <!-- Day headers -->
            <% const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; %>
            <% dayNames.forEach(function(day) { %>
              <div class="bg-gray-50 p-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wide">
                <%= day %>
              </div>
            <% }) %>
            
            <!-- Calendar days -->
            <% 
              const firstDay = new Date(currentYear, currentMonth - 1, 1);
              const lastDay = new Date(currentYear, currentMonth, 0);
              const daysInMonth = lastDay.getDate();
              const startDayOfWeek = firstDay.getDay();
              
              // Get events grouped by date
              const eventsByDate = {};
              if (typeof events !== 'undefined' && events) {
                events.forEach(function(event) {
                  if (event.date) {
                    const eventDate = new Date(event.date);
                    const dateKey = eventDate.toISOString().split('T')[0];
                    if (!eventsByDate[dateKey]) {
                      eventsByDate[dateKey] = [];
                    }
                    eventsByDate[dateKey].push(event);
                  }
                });
              }
              
              // Create array of days for the month
              const days = [];
              // Add empty cells for days before month starts
              for (let i = 0; i < startDayOfWeek; i++) {
                days.push(null);
              }
              // Add days of the month
              for (let day = 1; day <= daysInMonth; day++) {
                days.push(day);
              }
            %>
            
            <% days.forEach(function(day, index) { %>
              <% if (day === null) { %>
                <div class="bg-gray-50 min-h-[100px] p-2"></div>
              <% } else { %>
                <% 
                  const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                  const dayEvents = eventsByDate[dateStr] || [];
                  const isToday = new Date().toDateString() === new Date(currentYear, currentMonth - 1, day).toDateString();
                %>
                <div class="bg-white min-h-[100px] p-2 border-r border-b border-gray-100 hover:bg-gray-50 transition-colors <%= isToday ? 'bg-blue-50 ring-2 ring-blue-500' : '' %>">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-sm font-semibold text-gray-900 <%= isToday ? 'text-blue-700' : '' %>"><%= day %></span>
                    <% if (dayEvents.length > 0) { %>
                      <span class="px-1.5 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700">
                        <%= dayEvents.length %>
                      </span>
                    <% } %>
                  </div>
                  <div class="space-y-1 max-h-16 overflow-y-auto">
                    <% dayEvents.slice(0, 2).forEach(function(event) { %>
                      <div onclick="viewEvent(<%= event.id %>)" class="text-xs px-2 py-1 rounded bg-red-100 text-red-800 hover:bg-red-200 cursor-pointer truncate" title="<%= event.name %>">
                        <%= event.name %>
                      </div>
                    <% }) %>
                    <% if (dayEvents.length > 2) { %>
                      <div class="text-xs text-gray-500 px-2">+<%= dayEvents.length - 2 %> more</div>
                    <% } %>
                  </div>
                </div>
              <% } %>
            <% }) %>
          </div>
        </div>

        <!-- Upcoming Events List -->
        <div class="mt-8 bg-white rounded-2xl border border-gray-100 shadow-sm p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Upcoming Events</h2>
          <div class="space-y-3">
            <% if (typeof events !== 'undefined' && events && events.length > 0) { %>
              <% events.slice(0, 10).forEach(function(event) { %>
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-200 hover:bg-gray-100 transition-colors">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <h3 class="font-semibold text-gray-900"><%= event.name %></h3>
                      <% if (event.name && event.name.includes('[CANCELLED]')) { %>
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700">Cancelled</span>
                      <% } %>
                    </div>
                    <div class="flex flex-wrap gap-3 text-sm text-gray-600">
                      <span class="flex items-center gap-1">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        <%= new Date(event.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
                      </span>
                      <% if (event.location) { %>
                        <span class="flex items-center gap-1">
                          <i data-lucide="map-pin" class="w-4 h-4"></i>
                          <%= event.location %>
                        </span>
                      <% } %>
                    </div>
                    <% if (event.description) { %>
                      <p class="text-sm text-gray-500 mt-2 line-clamp-2"><%= event.description %></p>
                    <% } %>
                  </div>
                  <div class="flex items-center gap-2 ml-4">
                    <% if (canEditEvents && !event.name?.includes('[CANCELLED]')) { %>
                      <button onclick="editEvent(<%= event.id %>)" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                      </button>
                    <% } %>
                    <% if (canCancelEvents && !event.name?.includes('[CANCELLED]')) { %>
                      <button onclick="cancelEvent(<%= event.id %>)" class="p-2 text-amber-600 hover:bg-amber-50 rounded-lg transition-colors" title="Cancel">
                        <i data-lucide="x-circle" class="w-4 h-4"></i>
                      </button>
                    <% } %>
                    <% if (canDeleteEvents) { %>
                      <button onclick="deleteEvent(<%= event.id %>)" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                      </button>
                    <% } %>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <p class="text-gray-500 text-center py-8">No events scheduled for this month.</p>
            <% } %>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create/Edit Event Modal -->
  <div id="eventModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h2 id="modalTitle" class="text-xl font-bold text-gray-900">Create Event</h2>
          <button onclick="closeEventModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
            <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
          </button>
        </div>
      </div>
      <form id="eventForm" class="p-6 space-y-4">
        <input type="hidden" id="eventId" name="eventId">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Event Name *</label>
          <input type="text" id="eventName" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600">
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
          <input type="date" id="eventDate" name="date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600">
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
          <input type="text" id="eventLocation" name="location" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600">
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
          <textarea id="eventDescription" name="description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-600"></textarea>
        </div>
        
        <div class="flex gap-3 pt-4">
          <button type="button" onclick="closeEventModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition-colors">
            Cancel
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-red-700 text-white rounded-lg font-semibold hover:bg-red-800 transition-colors">
            Save Event
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const csrfToken = '<%= typeof csrfToken !== "undefined" ? csrfToken : "" %>';
    const canCreateEvents = <%= canCreateEvents ? 'true' : 'false' %>;
    const canEditEvents = <%= canEditEvents ? 'true' : 'false' %>;
    const canCancelEvents = <%= canCancelEvents ? 'true' : 'false' %>;
    const canDeleteEvents = <%= canDeleteEvents ? 'true' : 'false' %>;
    const currentYear = <%= currentYear %>;
    const currentMonth = <%= currentMonth %>;
    
    // Change month
    function changeMonth(direction) {
      let newMonth = currentMonth + direction;
      let newYear = currentYear;
      
      if (newMonth < 1) {
        newMonth = 12;
        newYear--;
      } else if (newMonth > 12) {
        newMonth = 1;
        newYear++;
      }
      
      window.location.href = `/officer/calendar?year=${newYear}&month=${newMonth}`;
    }
    
    // Event modal functions
    function openCreateEventModal() {
      document.getElementById('modalTitle').textContent = 'Create Event';
      document.getElementById('eventForm').reset();
      document.getElementById('eventId').value = '';
      document.getElementById('eventModal').classList.remove('hidden');
      renderLucideIcons();
    }
    
    function closeEventModal() {
      document.getElementById('eventModal').classList.add('hidden');
    }
    
    function editEvent(eventId) {
      // Fetch event details and populate form
      fetch(`/officer/calendar/event/${eventId}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById('modalTitle').textContent = 'Edit Event';
            document.getElementById('eventId').value = eventId;
            document.getElementById('eventName').value = data.event.name || '';
            document.getElementById('eventDate').value = data.event.date ? data.event.date.split('T')[0] : '';
            document.getElementById('eventLocation').value = data.event.location || '';
            document.getElementById('eventDescription').value = data.event.description || '';
            document.getElementById('eventModal').classList.remove('hidden');
            renderLucideIcons();
          }
        })
        .catch(err => {
          console.error('Error fetching event:', err);
          alert('Failed to load event details');
        });
    }
    
    function viewEvent(eventId) {
      editEvent(eventId); // For now, viewing opens edit modal (read-only for non-editors)
    }
    
    // Form submission
    document.getElementById('eventForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const eventId = document.getElementById('eventId').value;
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      
      const url = eventId 
        ? `/officer/calendar/event/${eventId}/update`
        : '/officer/calendar/event/create';
      
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          credentials: 'same-origin',
          body: JSON.stringify({ ...data, _csrf: csrfToken })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Event saved successfully!');
          location.reload();
        } else {
          alert('Error: ' + (result.error || 'Failed to save event'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while saving the event.');
      }
    });
    
    // Cancel event
    async function cancelEvent(eventId) {
      if (!confirm('Are you sure you want to cancel this event?')) return;
      
      try {
        const response = await fetch(`/officer/calendar/event/${eventId}/cancel`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          credentials: 'same-origin',
          body: JSON.stringify({ _csrf: csrfToken })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Event cancelled successfully!');
          location.reload();
        } else {
          alert('Error: ' + (result.error || 'Failed to cancel event'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while cancelling the event.');
      }
    }
    
    // Delete event
    async function deleteEvent(eventId) {
      if (!confirm('Are you sure you want to permanently delete this event? This action cannot be undone.')) return;
      
      try {
        const response = await fetch(`/officer/calendar/event/${eventId}/delete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          credentials: 'same-origin',
          body: JSON.stringify({ _csrf: csrfToken })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Event deleted successfully!');
          location.reload();
        } else {
          alert('Error: ' + (result.error || 'Failed to delete event'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while deleting the event.');
      }
    }
    
    // Initialize icons
    document.addEventListener('DOMContentLoaded', () => {
      renderLucideIcons();
    });
  </script>
</body>
</html>

