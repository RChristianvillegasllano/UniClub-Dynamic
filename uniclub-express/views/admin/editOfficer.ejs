<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Officer | UniClub Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="https://phshirt.com/wp-content/uploads/2022/01/UM-Tagum-College-1950.png" type="image/x-icon">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* Mobile sidebar toggle */
    @media (max-width: 1024px) {
      .sidebar-hidden {
        transform: translateX(-100%);
      }
    }

    /* Tab Navigation */
    .tab-button {
      display: inline-flex;
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
      line-height: 1.25rem;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }
    .tab-button.active {
      color: #a10109d1;
      border-bottom-color: #a10109d1;
    }
    .tab-button:hover:not(.active) {
      color: #475569;
      border-bottom-color: #cbd5f5;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Toast Notification Styles */
    #toastContainer {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      min-width: 320px;
      max-width: 420px;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3), 0 4px 10px rgba(0, 0, 0, 0.2);
      z-index: 10000;
      animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex;
      align-items: center;
      gap: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      pointer-events: auto;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(calc(100% + 24px));
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(calc(100% + 24px));
        opacity: 0;
      }
    }

    .toast-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-color: rgba(16, 185, 129, 0.3);
    }

    .toast-error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border-color: rgba(239, 68, 68, 0.3);
    }

    .toast-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border-color: rgba(245, 158, 11, 0.3);
    }

    .toast-info {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-color: rgba(59, 130, 246, 0.3);
    }

    .toast-icon {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .toast-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .toast-title {
      font-weight: 600;
      font-size: 14px;
      line-height: 1.4;
    }

    .toast-message {
      font-size: 13px;
      opacity: 0.95;
      line-height: 1.4;
    }

    .toast-close {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s ease;
      border-radius: 4px;
      font-size: 16px;
    }

    .toast-close:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.2);
    }

    /* Sticky Header */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: white;
      border-bottom: 1px solid #e5e7eb;
      margin: -1.5rem -1.5rem 1.5rem -1.5rem;
      padding: 1rem 1.5rem;
    }

    /* Floating Action Bar */
    .floating-action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: white;
      border-top: 2px solid #e5e7eb;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    @media (max-width: 768px) {
      .floating-action-bar {
        flex-direction: column;
        padding: 1rem;
      }
      .floating-action-bar .action-buttons {
        width: 100%;
        display: flex;
        gap: 0.75rem;
      }
      .floating-action-bar .action-buttons button {
        flex: 1;
      }
    }
    
    /* Right-side Quick Navigation - Sticky */
    .quick-nav-sidebar {
      position: sticky !important;
      top: 20px !important;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      width: 220px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem;
      align-self: flex-start;
      z-index: 10;
    }
    @media (max-width: 1024px) {
      .quick-nav-sidebar {
        display: none !important;
      }
    }
    .quick-nav-item {
      display: block;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      line-height: 1.25rem;
      border-radius: 0.5rem;
      margin-bottom: 0.25rem;
      transition: color 0.2s ease, background-color 0.2s ease;
      cursor: pointer;
    }
    .quick-nav-item:hover {
      background-color: #eff6ff;
      color: #1d4ed8;
    }
    .quick-nav-item.active {
      background-color: #dbeafe;
      color: #1e40af;
      font-weight: 600;
    }
    
    /* Category chips in summary */
    .category-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.75rem;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #bfdbfe;
    }
    .category-chip:hover {
      background: #bfdbfe;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .category-chip.danger {
      background: #fee2e2;
      color: #991b1b;
      border-color: #fecaca;
    }
    .category-chip.danger:hover {
      background: #fecaca;
    }

    /* Enhanced Permission Cards */
    .permission-category {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
    }
    .permission-category:hover {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }
    .permission-category-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .permission-category-header h2 {
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .permission-category-header .icon {
      width: 1.25rem;
      height: 1.25rem;
    }

    /* Tri-state Checkbox - Standard checkbox with indeterminate support */
    .tristate-checkbox {
      width: 1.25rem;
      height: 1.25rem;
      cursor: pointer;
      accent-color: #2563eb;
    }
    /* Indeterminate state styling */
    .tristate-checkbox:indeterminate {
      background-color: #60a5fa;
      border-color: #60a5fa;
    }

    /* Permission Checkbox - Standard with enhanced styling */
    .permission-checkbox {
      width: 1.25rem;
      height: 1.25rem;
      cursor: pointer;
      accent-color: #2563eb;
      flex-shrink: 0;
    }

    /* Danger Indicator */
    .danger-permission {
      position: relative;
    }
    .danger-permission .permission-label {
      color: #b91c1c;
      font-weight: 600;
    }
    .danger-icon {
      display: inline-block;
      margin-left: 0.5rem;
      color: #f97316;
    }

    /* Permission Preview Chips */
    .permission-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      background-color: #dbeafe;
      color: #1e3a8a;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .permission-chip.danger {
      background-color: #fee2e2;
      color: #991b1b;
    }

    /* Tooltip */
    .tooltip-container {
      position: relative;
      display: inline-block;
    }
    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translate(-50%, 0);
      margin-bottom: 0.5rem;
      padding: 0.5rem 0.75rem;
      background-color: #111827;
      color: #ffffff;
      font-size: 0.75rem;
      border-radius: 0.5rem;
      white-space: normal;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 50;
      max-width: 250px;
    }
    .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 4px;
      border-style: solid;
      border-color: #111827 transparent transparent transparent;
    }
    .tooltip-container:hover .tooltip {
      opacity: 1;
    }

    /* Search Input */
    .search-input {
      width: 100%;
      padding: 0.5rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .search-input:focus {
      border-color: #a10109d1;
      box-shadow: 0 0 0 2px rgba(161, 1, 9, 0.2);
      outline: none;
    }

    /* Improved spacing - consistent sizing with 2-3 columns */
    .permission-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
      padding: 1.25rem;
    }
    @media (min-width: 768px) {
      .permission-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (min-width: 1024px) {
      .permission-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    .permission-item {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      transition: background-color 0.2s;
      min-height: 48px;
    }
    .permission-item:hover {
      background-color: #f9fafb;
    }
    .permission-item label {
      flex: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .permission-label {
      font-size: 0.875rem;
      font-weight: 500;
      line-height: 1.3;
      color: #374151;
    }
    
    /* Accordion/Collapsible Categories - collapsed by default */
    .permission-category {
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      overflow: hidden;
    }
    .permission-category-header {
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }
    .permission-category-header:hover {
      opacity: 0.95;
    }
    .permission-category-content {
      display: none !important;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.2s ease;
      max-height: 0;
      opacity: 0;
    }
    .permission-category-content.expanded {
      display: block !important;
      max-height: 5000px;
      opacity: 1;
    }
    .category-toggle-icon {
      transition: transform 0.3s ease;
      display: inline-block;
    }
    .permission-category.expanded .category-toggle-icon {
      transform: rotate(90deg);
    }
    
    /* Body padding for floating action bar */
    body {
      padding-bottom: 80px;
    }
    
    /* Ensure categories are collapsed on page load */
    #permissionsContainer .permission-category-content:not(.expanded) {
      display: none !important;
    }
    
    /* Category header with count */
    .category-header-text {
      font-weight: 500;
      font-size: 0.9375rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .category-count-badge {
      display: none;
    }
    
    /* Info icon for tooltips */
    .info-icon {
      width: 1rem;
      height: 1rem;
      color: #9ca3af;
      cursor: help;
      transition: color 0.2s ease;
      flex-shrink: 0;
    }
    .info-icon:hover {
      color: #4b5563;
    }

    /* Max width for better readability */
    .form-container {
      width: 100%;
      max-width: none;
      margin: 0 auto;
    }

    /* Input width constraints */
    #studentid {
      max-width: 150px;
    }
    #password, #confirm_password {
      max-width: 300px;
    }

    /* Keyboard navigation */
    .permission-item:focus-within {
      box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #3b82f6;
      border-radius: 0.5rem;
    }

    /* ------------ Activity Logs Styles ------------ */
    .activity-layout {
      display: grid;
      grid-template-columns: 220px minmax(0, 1fr);
      gap: 1.5rem;
    }
    @media (max-width: 1024px) {
      .activity-layout {
        grid-template-columns: 1fr;
      }
    }

    .activity-filter-card {
      background: #f9fafb;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      padding: 1rem;
    }

    .activity-filter-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.25rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      color: #4b5563;
      cursor: pointer;
      transition: background-color 0.15s, color 0.15s;
    }
    .activity-filter-item:hover {
      background-color: #e5edff;
      color: #1d4ed8;
    }
    .activity-filter-item.active {
      background-color: #dbeafe;
      color: #1d4ed8;
      font-weight: 600;
    }

    .activity-log-card {
      background: #ffffff;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      padding: 1rem 1.25rem 1.25rem;
    }

    .activity-log-item {
      display: flex;
      gap: 0.75rem;
      padding: 0.6rem 0.25rem;
      border-radius: 0.5rem;
      align-items: flex-start;
      transition: background-color 0.15s;
    }
    .activity-log-item:hover {
      background-color: #f9fafb;
    }

    .activity-log-icon {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #eff6ff;
      color: #1d4ed8;
      flex-shrink: 0;
    }

    .activity-log-title {
      font-size: 0.9rem;
      font-weight: 500;
      color: #111827;
    }

    .activity-log-meta {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .activity-log-empty {
      text-align: center;
      padding: 3rem 1rem;
      color: #9ca3af;
      font-size: 0.9rem;
    }
  </style>
</head>

<body class="bg-gray-50 font-sans text-slate-800">
  <!-- Mobile menu button -->
  <button id="mobileMenuBtn" class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-white rounded-lg shadow-md hover:bg-gray-100 transition">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
  </button>
  <div class="min-h-screen lg:grid lg:grid-cols-[260px_1fr] gap-6 p-6">
    <!-- Sidebar -->
    <div id="sidebar" class="lg:block sidebar-hidden fixed lg:static inset-y-0 left-0 z-40 transition-transform duration-300 ease-in-out w-64 lg:w-auto">
      <%- include('../layouts/adminSidebar', { currentPath: (typeof currentPath !== 'undefined' ? currentPath : '/admin/officers'), messages: (typeof messages !== 'undefined' ? messages : []) }) %>
    </div>
    <!-- Overlay for mobile -->
    <div id="sidebarOverlay" class="lg:hidden hidden fixed inset-0 bg-black bg-opacity-50 z-30" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <main class="flex flex-col gap-4 lg:mt-0 mt-16">
      <!-- Header -->
      <header class="mb-6 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-slate-800">Edit Officer</h1>
          <p class="text-sm text-slate-500">Update officer details below</p>
        </div>
        <a href="/admin/officers"
           class="flex items-center gap-2 px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
          <i data-lucide="arrow-left"></i> Back
        </a>
      </header>

      <!-- Form Section -->
      <section class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm form-container">
        <%
          const safeFormData = (typeof formData !== 'undefined' && formData) ? formData : null;
          const current = Object.assign({}, officer, safeFormData || {});
          const selectedClubId = current.club_id ? Number(current.club_id) : null;
          const selectedDepartment = current.department || "";
          const selectedProgram = current.program || "";
          // Parse permissions - handle both string and object formats
          let permissionsData = {};
          try {
            if (officer.permissions) {
              if (typeof officer.permissions === 'string') {
                permissionsData = JSON.parse(officer.permissions);
              } else if (typeof officer.permissions === 'object') {
                permissionsData = officer.permissions;
              }
              // If old format was just an array, wrap it
              if (Array.isArray(permissionsData)) {
                permissionsData = { permissions: permissionsData };
              }
            }
          } catch (err) {
            console.warn("Error parsing permissions in view:", err);
            permissionsData = {};
          }
          
          // Handle form data if present
          if (safeFormData && safeFormData.permissions) {
            try {
              const parsed = typeof safeFormData.permissions === 'string' 
                ? JSON.parse(safeFormData.permissions) 
                : safeFormData.permissions;
              if (parsed && parsed.permissions) {
                permissionsData = parsed;
              } else if (Array.isArray(parsed)) {
                permissionsData = { permissions: parsed };
              }
            } catch (err) {
              console.warn("Error parsing form permissions:", err);
            }
          }
          
          // Ensure permissions is in the correct format
          if (Array.isArray(permissionsData)) {
            permissionsData = { permissions: permissionsData };
          }
          if (!permissionsData.permissions || !Array.isArray(permissionsData.permissions) || permissionsData.permissions.length === 0) {
            // If still empty, the server should have auto-loaded based on role
            // But if it didn't, we'll let the JavaScript handle it on the client side
            permissionsData = { permissions: [] };
            console.warn('[Edit Officer View] No permissions found for officer, server should auto-load based on role');
          }

          const logs = (typeof activityLogs !== 'undefined' && activityLogs) ? activityLogs : [];
        %>
        <form action="/admin/officers/edit/<%= officer.id %>" method="POST" id="officerEditForm" data-dept-program>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <!-- Tab Navigation -->
          <div class="sticky-header">
            <div class="flex gap-1 border-b border-gray-200">
              <button type="button" class="tab-button active" onclick="switchTab('profile')" id="tab-profile">
                <i data-lucide="user" class="inline w-4 h-4 mr-2"></i> Profile Details
              </button>
              <button type="button" class="tab-button" onclick="switchTab('permissions')" id="tab-permissions">
                <i data-lucide="shield" class="inline w-4 h-4 mr-2"></i> Permissions
                <span id="permission-count-badge" class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-800 rounded-full text-xs"></span>
              </button>
              <button type="button" class="tab-button" onclick="switchTab('activity')" id="tab-activity">
                <i data-lucide="activity" class="inline w-4 h-4 mr-2"></i> Activity Logs
              </button>
            </div>
          </div>

          <!-- Profile Details Tab -->
          <div id="tab-content-profile" class="tab-content active space-y-5">
            <!-- (profile content unchanged) -->
            <!-- ... your existing Profile Details content ... -->
            <!-- I’m leaving it as-is to avoid blowing this answer up even more -->
            <!-- everything from here down to the end of tab-content-profile is the same as your code -->
            <!-- ---------------- PROFILE TAB CONTENT (unchanged) ---------------- -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">First Name <span class="text-red-500">*</span></label>
                <input type="text" name="first_name" id="firstName" required value="<%= current.first_name || '' %>"
                       class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]"
                       placeholder="Enter first name"
                       pattern="[A-Za-z\s'-]+"
                       title="Only letters, spaces, hyphens, and apostrophes are allowed"
                       oninput="validateName('firstName', 'firstNameWarning')">
                <p class="text-xs text-gray-500 mt-1">Only letters, spaces, hyphens (-), and apostrophes (') allowed</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Last Name <span class="text-red-500">*</span></label>
                <input type="text" name="last_name" id="lastName" required value="<%= current.last_name || '' %>"
                       class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]"
                       placeholder="Enter last name"
                       pattern="[A-Za-z\s'-]+"
                       title="Only letters, spaces, hyphens, and apostrophes are allowed"
                       oninput="validateName('lastName', 'lastNameWarning')">
                <p class="text-xs text-gray-500 mt-1">Only letters, spaces, hyphens (-), and apostrophes (') allowed</p>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">Student ID</label>
              <input type="text" name="studentid" id="studentid" required value="<%= current.studentid || '' %>"
                     class="border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]"
                     placeholder="e.g., 111222 (6 digits only)"
                     maxlength="6"
                     oninput="validateStudentId()">
              <p class="text-xs text-gray-500 mt-1">Must be exactly 6 digits</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">Email</label>
              <input type="email" name="email" id="email" value="<%= current.email || '' %>"
                     class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]"
                     placeholder="officer@umindanao.edu.ph">
              <p class="text-xs text-gray-500 mt-1">Officer's email address</p>
            </div>

            <!-- Validation Warnings -->
            <div id="validationWarnings" class="hidden">
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-start">
                  <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600 mr-2 mt-0.5"></i>
                  <div class="flex-1">
                    <h4 class="text-sm font-semibold text-yellow-800 mb-2">Validation Warnings:</h4>
                    <ul id="warningList" class="text-sm text-yellow-700 list-disc list-inside space-y-1"></ul>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">Club</label>
              <select name="club_id" required
                      class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]">
                <% if (clubs && clubs.length > 0) { %>
                  <% clubs.forEach(c => { %>
                    <option value="<%= c.id %>" <%= selectedClubId !== null && Number(selectedClubId) === Number(c.id) ? 'selected' : '' %>><%= c.name %></option>
                  <% }) %>
                <% } else { %>
                  <option disabled>No clubs available</option>
                <% } %>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1">Role</label>
              <select name="role" required
                      class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]">
                <option value="">Select Role</option>
                <optgroup label="Presidents">
                  <option value="President" <%= current.role === 'President' ? 'selected' : '' %>>President</option>
                  <option value="Supremo" <%= current.role === 'Supremo' ? 'selected' : '' %>>Supremo</option>
                  <option value="Grand Peer" <%= current.role === 'Grand Peer' ? 'selected' : '' %>>Grand Peer</option>
                </optgroup>
                <optgroup label="Vice-Presidents">
                  <option value="Vice President" <%= current.role === 'Vice President' ? 'selected' : '' %>>Vice President</option>
                  <option value="Vice-President Internal" <%= current.role === 'Vice-President Internal' ? 'selected' : '' %>>Vice-President Internal</option>
                  <option value="Vice-President External" <%= current.role === 'Vice-President External' ? 'selected' : '' %>>Vice-President External</option>
                </optgroup>
                <optgroup label="Secretaries">
                  <option value="Secretary" <%= current.role === 'Secretary' ? 'selected' : '' %>>Secretary</option>
                  <option value="Assistant Secretary" <%= current.role === 'Assistant Secretary' ? 'selected' : '' %>>Assistant Secretary</option>
                </optgroup>
                <optgroup label="Treasurers">
                  <option value="Treasurer" <%= current.role === 'Treasurer' ? 'selected' : '' %>>Treasurer</option>
                  <option value="Assistant Treasurer" <%= current.role === 'Assistant Treasurer' ? 'selected' : '' %>>Assistant Treasurer</option>
                </optgroup>
                <optgroup label="Auditors">
                  <option value="Auditor" <%= current.role === 'Auditor' ? 'selected' : '' %>>Auditor</option>
                  <option value="Assistant Auditor" <%= current.role === 'Assistant Auditor' ? 'selected' : '' %>>Assistant Auditor</option>
                </optgroup>
                <optgroup label="Public Relations">
                  <option value="Public Information Officer (PIO)" <%= current.role === 'Public Information Officer (PIO)' ? 'selected' : '' %>>Public Information Officer (PIO)</option>
                  <option value="Public Relations Officer (PRO)" <%= current.role === 'Public Relations Officer (PRO)' ? 'selected' : '' %>>Public Relations Officer (PRO)</option>
                  <option value="Assistant Public Relations Officer" <%= current.role === 'Assistant Public Relations Officer' ? 'selected' : '' %>>Assistant Public Relations Officer</option>
                </optgroup>
                <optgroup label="Management">
                  <option value="Creatives Member" <%= current.role === 'Creatives Member' ? 'selected' : '' %>>Creatives Member</option>
                  <option value="Business Manager" <%= current.role === 'Business Manager' ? 'selected' : '' %>>Business Manager</option>
                  <option value="Assistant Business Manager" <%= current.role === 'Assistant Business Manager' ? 'selected' : '' %>>Assistant Business Manager</option>
                </optgroup>
                <optgroup label="Year Representatives">
                  <option value="1st Year Representative" <%= current.role === '1st Year Representative' ? 'selected' : '' %>>1st Year Representative</option>
                  <option value="2nd Year Representative" <%= current.role === '2nd Year Representative' ? 'selected' : '' %>>2nd Year Representative</option>
                  <option value="3rd Year Representative" <%= current.role === '3rd Year Representative' ? 'selected' : '' %>>3rd Year Representative</option>
                  <option value="4th Year Representative" <%= current.role === '4th Year Representative' ? 'selected' : '' %>>4th Year Representative</option>
                </optgroup>
              </select>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" data-dept-program>
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Current Password</label>
                <div class="relative">
                  <input type="password" name="current_password" id="current_password" autocomplete="current-password" placeholder="Enter current password"
                         class="w-full border border-slate-300 rounded-lg px-3 py-2 pr-10 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]">
                  <button type="button" onclick="togglePasswordVisibility('current_password', 'current-password-toggle')" 
                          class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none"
                          id="current-password-toggle">
                    <i data-lucide="eye" class="w-5 h-5"></i>
                  </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Required if changing password</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">New Password</label>
                <div class="relative">
                  <input type="password" name="password" id="password" autocomplete="new-password" placeholder="Enter new password"
                         class="w-full border border-slate-300 rounded-lg px-3 py-2 pr-10 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]">
                  <button type="button" onclick="togglePasswordVisibility('password', 'password-toggle')" 
                          class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none"
                          id="password-toggle">
                    <i data-lucide="eye" class="w-5 h-5"></i>
                  </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Leave blank to keep current</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Confirm Password</label>
                <div class="relative">
                  <input type="password" name="confirm_password" id="confirm_password" autocomplete="new-password" placeholder="Confirm new password"
                         class="w-full border border-slate-300 rounded-lg px-3 py-2 pr-10 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]">
                  <button type="button" onclick="togglePasswordVisibility('confirm_password', 'confirm-password-toggle')" 
                          class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none"
                          id="confirm-password-toggle">
                    <i data-lucide="eye" class="w-5 h-5"></i>
                  </button>
                </div>
                <p id="password-match-error" class="text-xs text-red-500 mt-1 hidden">Passwords do not match</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Department</label>
                <select name="department" data-dept-select
                       class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]">
                  <option value="">Select Department</option>
                  <option value="Department of Accounting Education" <%= selectedDepartment === 'Department of Accounting Education' ? 'selected' : '' %>>Department of Accounting Education</option>
                  <option value="Department of Arts and Sciences Education" <%= selectedDepartment === 'Department of Arts and Sciences Education' ? 'selected' : '' %>>Department of Arts and Sciences Education</option>
                  <option value="Department of Business Administration Education" <%= selectedDepartment === 'Department of Business Administration Education' ? 'selected' : '' %>>Department of Business Administration Education</option>
                  <option value="Department of Computing Education" <%= selectedDepartment === 'Department of Computing Education' ? 'selected' : '' %>>Department of Computing Education</option>
                  <option value="Department of Criminal Justice Education" <%= selectedDepartment === 'Department of Criminal Justice Education' ? 'selected' : '' %>>Department of Criminal Justice Education</option>
                  <option value="Department of Engineering Education" <%= selectedDepartment === 'Department of Engineering Education' ? 'selected' : '' %>>Department of Engineering Education</option>
                  <option value="Department of Hospitality Education" <%= selectedDepartment === 'Department of Hospitality Education' ? 'selected' : '' %>>Department of Hospitality Education</option>
                  <option value="Department of Teacher Education" <%= selectedDepartment === 'Department of Teacher Education' ? 'selected' : '' %>>Department of Teacher Education</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Program</label>
                <select name="program" data-program-select data-current="<%= selectedProgram %>"
                       class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]">
                  <option value="">Select Program</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Permissions Tab -->
          <div id="tab-content-permissions" class="tab-content">
            <div class="flex flex-col lg:flex-row gap-6">
              <section class="flex-1 space-y-6">
                <!-- Actions + Search -->
                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                  <div class="flex flex-wrap gap-3">
                    <button type="button"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium shadow-sm"
                            onclick="selectAllPermissions()">
                      Select All
                    </button>
                    <button type="button"
                            class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition text-sm font-medium"
                            onclick="deselectAllPermissions()">
                      Deselect All
                    </button>
                  </div>
                  <div class="w-full md:w-72">
                    <label for="permission-search" class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wide">
                      Search Permissions
                    </label>
                    <input id="permission-search"
                           type="text"
                           class="search-input"
                           placeholder="Type to filter…"
                           oninput="filterPermissions()">
                  </div>
                </div>

                <!-- Permission Categories -->
                <div id="permissionsContainer" class="space-y-4">
                  <!-- Dashboard & Reports -->
                  <div class="permission-category" id="category-dashboard" data-category="dashboard">
                    <div class="permission-category-header" role="button" onclick="toggleCategoryAccordion('dashboard')">
                      <div class="category-header-text">
                        <i data-lucide="layout-dashboard" class="icon text-blue-600"></i>
                        <span>Dashboard & Reports</span>
                        <span id="count-dashboard" class="category-count-badge"></span>
                      </div>
                      <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 text-xs text-slate-500" onclick="event.stopPropagation();">
                          <input type="checkbox"
                                 class="tristate-checkbox category-checkbox"
                                 data-category="dashboard"
                                 onchange="toggleCategory('dashboard', this); event.stopPropagation();">
                          <span>Select all</span>
                        </label>
                        <span class="category-toggle-icon text-slate-400">&rsaquo;</span>
                      </div>
                    </div>
                    <div class="permission-category-content" id="content-dashboard">
                      <div class="permission-grid">
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox dashboard-perm" data-category="dashboard" data-perm="view_dashboard">
                          <span class="permission-label">View Dashboard</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox dashboard-perm" data-category="dashboard" data-perm="view_org_reports">
                          <span class="permission-label">View Organization Reports</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox dashboard-perm" data-category="dashboard" data-perm="export_reports">
                          <span class="permission-label">Export Reports</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox dashboard-perm" data-category="dashboard" data-perm="view_analytics">
                          <span class="permission-label">View Analytics</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox dashboard-perm" data-category="dashboard" data-perm="generate_custom_reports">
                          <span class="permission-label">Generate Custom Reports</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Members & Officers -->
                  <div class="permission-category" id="category-members" data-category="members">
                    <div class="permission-category-header" role="button" onclick="toggleCategoryAccordion('members')">
                      <div class="category-header-text">
                        <i data-lucide="users" class="icon text-green-600"></i>
                        <span>Members & Officers</span>
                        <span id="count-members" class="category-count-badge"></span>
                      </div>
                      <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 text-xs text-slate-500" onclick="event.stopPropagation();">
                          <input type="checkbox"
                                 class="tristate-checkbox category-checkbox"
                                 data-category="members"
                                 onchange="toggleCategory('members', this); event.stopPropagation();">
                          <span>Select all</span>
                        </label>
                        <span class="category-toggle-icon text-slate-400">&rsaquo;</span>
                      </div>
                    </div>
                    <div class="permission-category-content" id="content-members">
                      <div class="permission-grid">
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox members-perm" data-category="members" data-perm="view_members">
                          <span class="permission-label">View Members</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox members-perm" data-category="members" data-perm="add_members">
                          <span class="permission-label">Add Members</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox members-perm" data-category="members" data-perm="edit_members">
                          <span class="permission-label">Edit Member Details</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox members-perm" data-category="members" data-perm="remove_members">
                          <span class="permission-label">Remove Members</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox members-perm" data-category="members" data-perm="approve_applications">
                          <span class="permission-label">Approve Applications</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox members-perm" data-category="members" data-perm="manage_officer_roles">
                          <span class="permission-label">Manage Officer Roles</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Financial -->
                  <div class="permission-category" id="category-finance" data-category="finance">
                    <div class="permission-category-header" role="button" onclick="toggleCategoryAccordion('finance')">
                      <div class="category-header-text">
                        <i data-lucide="dollar-sign" class="icon text-yellow-600"></i>
                        <span>Financial Management</span>
                        <span id="count-finance" class="category-count-badge"></span>
                      </div>
                      <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 text-xs text-slate-500" onclick="event.stopPropagation();">
                          <input type="checkbox"
                                 class="tristate-checkbox category-checkbox"
                                 data-category="finance"
                                 onchange="toggleCategory('finance', this); event.stopPropagation();">
                          <span>Select all</span>
                        </label>
                        <span class="category-toggle-icon text-slate-400">&rsaquo;</span>
                      </div>
                    </div>
                    <div class="permission-category-content" id="content-finance">
                      <div class="permission-grid">
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox finance-perm" data-category="finance" data-perm="view_financial_records">
                          <span class="permission-label">View Financial Records</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox finance-perm" data-category="finance" data-perm="record_transactions">
                          <span class="permission-label">Record Transactions</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox finance-perm" data-category="finance" data-perm="approve_expenses">
                          <span class="permission-label">Approve Expenses</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox finance-perm" data-category="finance" data-perm="generate_financial_reports">
                          <span class="permission-label">Generate Financial Reports</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox finance-perm" data-category="finance" data-perm="manage_budget">
                          <span class="permission-label">Manage Budget</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox finance-perm" data-category="finance" data-perm="audit_finances">
                          <span class="permission-label">Audit Finances</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Events -->
                  <div class="permission-category" id="category-events" data-category="events">
                    <div class="permission-category-header" role="button" onclick="toggleCategoryAccordion('events')">
                      <div class="category-header-text">
                        <i data-lucide="calendar" class="icon text-purple-600"></i>
                        <span>Events & Activities</span>
                        <span id="count-events" class="category-count-badge"></span>
                      </div>
                      <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 text-xs text-slate-500" onclick="event.stopPropagation();">
                          <input type="checkbox"
                                 class="tristate-checkbox category-checkbox"
                                 data-category="events"
                                 onchange="toggleCategory('events', this); event.stopPropagation();">
                          <span>Select all</span>
                        </label>
                        <span class="category-toggle-icon text-slate-400">&rsaquo;</span>
                      </div>
                    </div>
                    <div class="permission-category-content" id="content-events">
                      <div class="permission-grid">
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox events-perm" data-category="events" data-perm="view_events">
                          <span class="permission-label">View Events</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox events-perm" data-category="events" data-perm="create_events">
                          <span class="permission-label">Create Events</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox events-perm" data-category="events" data-perm="edit_events">
                          <span class="permission-label">Edit Events</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox events-perm" data-category="events" data-perm="cancel_events">
                          <span class="permission-label">Cancel Events</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox events-perm" data-category="events" data-perm="delete_events">
                          <span class="permission-label">Delete Events</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox events-perm" data-category="events" data-perm="manage_attendance">
                          <span class="permission-label">Manage Attendance</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox events-perm" data-category="events" data-perm="export_event_reports">
                          <span class="permission-label">Export Event Reports</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Documents -->
                  <div class="permission-category" id="category-documents" data-category="documents">
                    <div class="permission-category-header" role="button" onclick="toggleCategoryAccordion('documents')">
                      <div class="category-header-text">
                        <i data-lucide="file-text" class="icon text-indigo-600"></i>
                        <span>Documents & Records</span>
                        <span id="count-documents" class="category-count-badge"></span>
                      </div>
                      <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 text-xs text-slate-500" onclick="event.stopPropagation();">
                          <input type="checkbox"
                                 class="tristate-checkbox category-checkbox"
                                 data-category="documents"
                                 onchange="toggleCategory('documents', this); event.stopPropagation();">
                          <span>Select all</span>
                        </label>
                        <span class="category-toggle-icon text-slate-400">&rsaquo;</span>
                      </div>
                    </div>
                    <div class="permission-category-content" id="content-documents">
                      <div class="permission-grid">
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox documents-perm" data-category="documents" data-perm="view_documents">
                          <span class="permission-label">View Documents</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox documents-perm" data-category="documents" data-perm="upload_documents">
                          <span class="permission-label">Upload Documents</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox documents-perm" data-category="documents" data-perm="edit_documents">
                          <span class="permission-label">Edit Documents</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox documents-perm" data-category="documents" data-perm="delete_documents">
                          <span class="permission-label">Delete Documents</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox documents-perm" data-category="documents" data-perm="download_documents">
                          <span class="permission-label">Download Documents</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox documents-perm" data-category="documents" data-perm="manage_minutes">
                          <span class="permission-label">Manage Meeting Minutes</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Communications -->
                  <div class="permission-category" id="category-comms" data-category="comms">
                    <div class="permission-category-header" role="button" onclick="toggleCategoryAccordion('comms')">
                      <div class="category-header-text">
                        <i data-lucide="message-square" class="icon text-pink-600"></i>
                        <span>Communications & Announcements</span>
                        <span id="count-comms" class="category-count-badge"></span>
                      </div>
                      <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 text-xs text-slate-500" onclick="event.stopPropagation();">
                          <input type="checkbox"
                                 class="tristate-checkbox category-checkbox"
                                 data-category="comms"
                                 onchange="toggleCategory('comms', this); event.stopPropagation();">
                          <span>Select all</span>
                        </label>
                        <span class="category-toggle-icon text-slate-400">&rsaquo;</span>
                      </div>
                    </div>
                    <div class="permission-category-content" id="content-comms">
                      <div class="permission-grid">
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox comms-perm" data-category="comms" data-perm="view_announcements">
                          <span class="permission-label">View Announcements</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox comms-perm" data-category="comms" data-perm="post_announcements">
                          <span class="permission-label">Post Announcements</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox comms-perm" data-category="comms" data-perm="edit_announcements">
                          <span class="permission-label">Edit Announcements</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox comms-perm" data-category="comms" data-perm="delete_announcements">
                          <span class="permission-label">Delete Announcements</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox comms-perm" data-category="comms" data-perm="send_notifications">
                          <span class="permission-label">Send Notifications</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox comms-perm" data-category="comms" data-perm="manage_social_media">
                          <span class="permission-label">Manage Social Media</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- System Administration -->
                  <div class="permission-category" id="category-admin" data-category="admin">
                    <div class="permission-category-header" role="button" onclick="toggleCategoryAccordion('admin')">
                      <div class="category-header-text">
                        <i data-lucide="settings" class="icon text-red-600"></i>
                        <span>System Administration</span>
                        <span id="count-admin" class="category-count-badge"></span>
                      </div>
                      <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 text-xs text-slate-500" onclick="event.stopPropagation();">
                          <input type="checkbox"
                                 class="tristate-checkbox category-checkbox"
                                 data-category="admin"
                                 onchange="toggleCategory('admin', this); event.stopPropagation();">
                          <span>Select all</span>
                        </label>
                        <span class="category-toggle-icon text-slate-400">&rsaquo;</span>
                      </div>
                    </div>
                    <div class="permission-category-content" id="content-admin">
                      <div class="permission-grid">
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox admin-perm" data-category="admin" data-perm="view_system_settings">
                          <span class="permission-label">View System Settings</span>
                        </label>
                        <label class="permission-item danger-permission">
                          <input type="checkbox" class="permission-checkbox admin-perm" data-category="admin" data-perm="modify_system_settings">
                          <span class="permission-label">Modify System Settings</span>
                          <span class="danger-icon">!</span>
                        </label>
                        <label class="permission-item danger-permission">
                          <input type="checkbox" class="permission-checkbox admin-perm" data-category="admin" data-perm="manage_permissions">
                          <span class="permission-label">Manage Permissions</span>
                          <span class="danger-icon">!</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox admin-perm" data-category="admin" data-perm="view_audit_logs">
                          <span class="permission-label">View Audit Logs</span>
                        </label>
                        <label class="permission-item">
                          <input type="checkbox" class="permission-checkbox admin-perm" data-category="admin" data-perm="backup_system">
                          <span class="permission-label">Backup System</span>
                        </label>
                        <label class="permission-item danger-permission">
                          <input type="checkbox" class="permission-checkbox admin-perm" data-category="admin" data-perm="system_maintenance">
                          <span class="permission-label">Perform System Maintenance</span>
                          <span class="danger-icon">!</span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Use unescaped output so JSON remains valid for JS parsing -->
                <input type="hidden" name="permissions" id="permissionsEditField" value='<%- JSON.stringify(permissionsData) %>'>
                <!-- Debug: Output permissions for verification -->
                <script>
                  window.__officerPermissions = <%- JSON.stringify(permissionsData) %>;
                  console.log('[Edit Officer] Permissions passed to view:', window.__officerPermissions);
                  console.log('[Edit Officer] Permission count:', window.__officerPermissions?.permissions?.length || 0);
                </script>
              </section>

              <!-- Quick Navigation -->
              <aside class="quick-nav-sidebar">
                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Jump to Category</p>
                <nav class="flex flex-col">
                  <a href="#category-dashboard" class="quick-nav-item active" onclick="scrollToCategory('dashboard'); return false;">Dashboard & Reports</a>
                  <a href="#category-members" class="quick-nav-item" onclick="scrollToCategory('members'); return false;">Members & Officers</a>
                  <a href="#category-finance" class="quick-nav-item" onclick="scrollToCategory('finance'); return false;">Financial Management</a>
                  <a href="#category-events" class="quick-nav-item" onclick="scrollToCategory('events'); return false;">Events & Activities</a>
                  <a href="#category-documents" class="quick-nav-item" onclick="scrollToCategory('documents'); return false;">Documents & Records</a>
                  <a href="#category-comms" class="quick-nav-item" onclick="scrollToCategory('comms'); return false;">Communications</a>
                  <a href="#category-admin" class="quick-nav-item" onclick="scrollToCategory('admin'); return false;">System Administration</a>
                </nav>
              </aside>
            </div>
          </div>

          <!-- Activity Logs Tab -->
          <div id="tab-content-activity" class="tab-content">
            <div class="activity-layout">
              <!-- Left: filters -->
              <aside class="activity-filter-card">
                <h3 class="text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                  <i data-lucide="list" class="w-4 h-4 text-gray-500"></i>
                  Activity Filters
                </h3>
                <div class="space-y-1">
                  <button type="button"
                          class="activity-filter-item active"
                          data-filter="all"
                          onclick="setActivityFilter('all')">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                    <span>All</span>
                  </button>
                  <button type="button"
                          class="activity-filter-item"
                          data-filter="events"
                          onclick="setActivityFilter('events')">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>Events</span>
                  </button>
                  <button type="button"
                          class="activity-filter-item"
                          data-filter="documents"
                          onclick="setActivityFilter('documents')">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    <span>Documents</span>
                  </button>
                  <button type="button"
                          class="activity-filter-item"
                          data-filter="financial"
                          onclick="setActivityFilter('financial')">
                    <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                    <span>Financial</span>
                  </button>
                  <button type="button"
                          class="activity-filter-item"
                          data-filter="system"
                          onclick="setActivityFilter('system')">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    <span>System / Permissions</span>
                  </button>
                </div>
              </aside>

              <!-- Right: log list -->
              <section class="activity-log-card">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <h2 class="text-base font-semibold text-gray-900 flex items-center gap-2">
                      <i data-lucide="activity" class="w-4 h-4 text-blue-600"></i>
                      Activity Logs
                    </h2>
                    <p class="text-xs text-gray-500 mt-0.5">
                      Most recent changes related to this officer account.
                    </p>
                  </div>
                </div>

                <ul id="activity-log-list" class="space-y-1">
                  <% if (!logs || logs.length === 0) { %>
                    <li class="activity-log-empty">
                      <p>No activity recorded for this officer yet.</p>
                      <p class="mt-1 text-xs">Once changes are made (permissions, events, documents, etc.), they will appear here.</p>
                    </li>
                  <% } else { %>
                    <% logs.forEach(function(log) { 
                      const type = log.type || 'system'; 
                    %>
                      <li class="activity-log-item" data-type="<%= type %>">
                        <div class="activity-log-icon">
                          <% if (type === 'events') { %>
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                          <% } else if (type === 'documents') { %>
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                          <% } else if (type === 'financial') { %>
                            <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                          <% } else { %>
                            <i data-lucide="shield" class="w-4 h-4"></i>
                          <% } %>
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="activity-log-title">
                            <%= log.title || 'Activity' %>
                          </p>
                          <p class="activity-log-meta">
                            <%= log.actor || officer.first_name + ' ' + officer.last_name %>
                            ·
                            <%= log.time_ago || log.timestamp || '' %>
                          </p>
                        </div>
                      </li>
                    <% }); %>
                  <% } %>
                </ul>
              </section>
            </div>
          </div>

          <!-- Update Button (shown in profile tab only) -->
          <div id="update-button-container" class="flex justify-end mt-6 pt-6 border-t">
            <button type="submit"
                    class="px-6 py-2 bg-[#a10109d1] text-white rounded-lg hover:bg-[#870107] transition font-medium">
              <i data-lucide="save" class="inline w-4 h-4 mr-1"></i> Update Officer
            </button>
          </div>
        </form>

        <!-- Floating Action Bar (shown on permissions tab) -->
        <div id="floating-action-bar" class="floating-action-bar" style="display: none;">
          <div class="text-sm text-gray-600 font-medium">
            <span id="action-bar-count">0 permissions selected</span>
          </div>
          <div class="action-buttons flex gap-3">
            <a href="/admin/officers" class="px-6 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium shadow-sm">
              <i data-lucide="x" class="inline w-4 h-4 mr-1"></i> Cancel
            </a>
            <button type="submit" form="officerEditForm"
                    class="px-6 py-2.5 bg-[#a10109d1] text-white rounded-lg hover:bg-[#870107] transition font-medium shadow-md">
              <i data-lucide="save" class="inline w-4 h-4 mr-1"></i> Save Changes
            </button>
          </div>
        </div>

        <% if (typeof error !== 'undefined' && error) { %>
          <p class="text-red-500 text-sm mt-4"><%= error %></p>
        <% } %>
      </section>

      <!-- Footer -->
      <footer class="text-center text-xs text-slate-400 py-4 border-t mt-8">
        &copy; <%= new Date().getFullYear() %> UniClub Management System. All rights reserved.
      </footer>
    </main>
  </div>

  <script>
    window.lucide && window.lucide.replace();
    
    // Permission category IDs for tri-state checkbox logic
    const permissionCategoryIds = ['dashboard', 'members', 'finance', 'events', 'documents', 'comms', 'admin'];

    // Attach event listeners to permission checkboxes
    function attachPermissionListeners() {
      document.querySelectorAll('.permission-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
          updatePermissionsField();
          updateCategoryCheckboxes();
          updateCategoryCounts();
          updatePermissionSummary();
        });
        
        // Keyboard navigation
        cb.addEventListener('keydown', function(e) {
          if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            this.checked = !this.checked;
            this.dispatchEvent(new Event('change'));
          }
        });
      });
    }

    // Accordion toggle
    function toggleCategoryAccordion(categoryId) {
      const category = document.querySelector(`[data-category="${categoryId}"]`);
      const content = document.getElementById(`content-${categoryId}`);
      if (!category || !content) return;
      
      const isExpanded = content.classList.contains('expanded');
      if (isExpanded) {
        category.classList.remove('expanded');
        content.classList.remove('expanded');
      } else {
        category.classList.add('expanded');
        content.classList.add('expanded');
      }
      
      if (window.lucide) window.lucide.replace();
    }
    
    // Scroll to category
    function scrollToCategory(categoryId) {
      const category = document.getElementById(`category-${categoryId}`);
      if (category) {
        if (!category.classList.contains('expanded')) {
          toggleCategoryAccordion(categoryId);
        }
        setTimeout(() => {
          category.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
        
        document.querySelectorAll('.quick-nav-item').forEach(item => item.classList.remove('active'));
        const navItem = document.querySelector(`.quick-nav-item[href="#category-${categoryId}"]`);
        if (navItem) navItem.classList.add('active');
      }
    }
    
    // Update category counts
    function updateCategoryCounts() {
      permissionCategoryIds.forEach(categoryId => {
        const checkboxes = document.querySelectorAll(`.${categoryId}-perm`);
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        const countBadge = document.getElementById(`count-${categoryId}`);
        if (countBadge) {
          countBadge.textContent = `(${checked.length}/${checkboxes.length} selected)`;
        }
      });
    }

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      const activeTab = document.getElementById(`tab-${tabName}`);
      if (activeTab) {
        activeTab.classList.add('active');
      }
      
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      const activeContent = document.getElementById(`tab-content-${tabName}`);
      if (activeContent) {
        activeContent.classList.add('active');
      }
      
      const floatingBar = document.getElementById('floating-action-bar');
      if (floatingBar) {
        if (tabName === 'permissions') {
          floatingBar.style.display = 'flex';
          document.body.style.paddingBottom = '80px';
          // Ensure permissions are initialized when switching to permissions tab
          setTimeout(() => {
            const checkedCount = document.querySelectorAll('.permission-checkbox:checked').length;
            const permField = document.getElementById('permissionsEditField');
            if (checkedCount === 0 && permField && permField.value && permField.value !== '{}') {
              console.log('[Edit Officer] Permissions tab opened, re-initializing permissions...');
              initializePermissions();
            }
          }, 100);
        } else {
          floatingBar.style.display = 'none';
          document.body.style.paddingBottom = '0';
        }
      }
      
      const updateBtnContainer = document.getElementById('update-button-container');
      if (updateBtnContainer) {
        if (tabName === 'permissions' || tabName === 'activity') {
          updateBtnContainer.style.display = 'none';
        } else {
          updateBtnContainer.style.display = 'flex';
        }
      }
      
      setTimeout(() => {
        window.lucide && window.lucide.replace();
      }, 100);
    }

    // Tri-state checkbox logic
    function updateCategoryCheckboxes() {
      permissionCategoryIds.forEach(categoryId => {
        const checkboxes = document.querySelectorAll(`.${categoryId}-perm`);
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        const categoryCheckbox = document.querySelector(`.category-checkbox[data-category="${categoryId}"]`);
        
        if (categoryCheckbox) {
          if (checked.length === 0) {
            categoryCheckbox.checked = false;
            categoryCheckbox.indeterminate = false;
          } else if (checked.length === checkboxes.length) {
            categoryCheckbox.checked = true;
            categoryCheckbox.indeterminate = false;
          } else {
            categoryCheckbox.checked = false;
            categoryCheckbox.indeterminate = true;
          }
        }
      });
    }

    function toggleCategory(categoryId, checkbox) {
      const checkboxes = document.querySelectorAll(`.${categoryId}-perm`);
      const shouldCheck = checkbox.checked || checkbox.indeterminate;
      checkboxes.forEach(cb => cb.checked = shouldCheck);
      checkbox.indeterminate = false;
      updatePermissionsField();
      updatePermissionSummary();
    }

    function selectCategory(categoryId) {
      const checkboxes = document.querySelectorAll(`.${categoryId}-perm`);
      checkboxes.forEach(cb => cb.checked = true);
      updateCategoryCheckboxes();
      updatePermissionsField();
      updatePermissionSummary();
    }

    // Permission search
    function filterPermissions() {
      const searchTerm = document.getElementById('permission-search').value.toLowerCase();
      const categories = document.querySelectorAll('.permission-category');
      
      categories.forEach(category => {
        const items = category.querySelectorAll('.permission-item');
        let hasVisible = false;
        
        items.forEach(item => {
          const label = item.textContent.toLowerCase();
          if (label.includes(searchTerm)) {
            item.style.display = 'flex';
            hasVisible = true;
          } else {
            item.style.display = 'none';
          }
        });
        
        category.style.display = hasVisible ? 'block' : 'none';
      });
    }

    // Permission summary with category chips
    function updatePermissionSummary() {
      const selected = Array.from(document.querySelectorAll('.permission-checkbox:checked'));
      const chipsContainer = document.getElementById('permission-chips');
      const selectedCount = document.getElementById('selected-count');
      const actionBarCount = document.getElementById('action-bar-count');
      const tabBadge = document.getElementById('permission-count-badge');
      
      const categoryCounts = {};
      permissionCategoryIds.forEach(catId => {
        const checked = Array.from(document.querySelectorAll(`.${catId}-perm:checked`));
        if (checked.length > 0) {
          categoryCounts[catId] = checked.length;
        }
      });
      
      // Update action bar and tab badge if they exist
      if (actionBarCount) {
        actionBarCount.textContent = selected.length === 0 ? '0 permissions selected' : `${selected.length} permission${selected.length !== 1 ? 's' : ''} selected`;
      }
      if (tabBadge) {
        tabBadge.textContent = String(selected.length);
      }
      
      // Update chips container and selected count if they exist (removed from UI but keeping code for potential future use)
      if (chipsContainer) {
        if (selected.length === 0) {
          chipsContainer.innerHTML = '<span class="text-sm text-gray-500 italic">No permissions selected yet. Click category headers to expand and select permissions.</span>';
        } else {
          chipsContainer.innerHTML = '';
          
          const categoryNames = {
            dashboard: 'Dashboard',
            members: 'Members',
            finance: 'Financial',
            events: 'Events',
            documents: 'Documents',
            comms: 'Communication',
            admin: 'System Admin'
          };
          
          Object.keys(categoryCounts).forEach(catId => {
            const chip = document.createElement('span');
            chip.className = 'category-chip';
            chip.innerHTML = `<i data-lucide="${catId === 'dashboard' ? 'layout-dashboard' : catId === 'members' ? 'users' : catId === 'finance' ? 'dollar-sign' : catId === 'events' ? 'calendar' : catId === 'documents' ? 'file-text' : catId === 'comms' ? 'message-square' : 'settings'}" class="w-3 h-3"></i> ${categoryNames[catId]} (${categoryCounts[catId]})`;
            chip.onclick = () => scrollToCategory(catId);
            chipsContainer.appendChild(chip);
          });
          
          if (window.lucide) window.lucide.replace();
        }
      }
      
      if (selectedCount) {
        selectedCount.textContent = selected.length;
      }
      
      updateCategoryCounts();
    }

    // Permission management functions
    function selectAllPermissions() {
      document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = true);
      updateCategoryCheckboxes();
      updatePermissionsField();
      updatePermissionSummary();
    }

    function deselectAllPermissions() {
      document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = false);
      updateCategoryCheckboxes();
      updatePermissionsField();
      updatePermissionSummary();
    }

    function updatePermissionsField() {
      const permField = document.getElementById('permissionsEditField');
      const selected = [];
      document.querySelectorAll('.permission-checkbox:checked').forEach(cb => {
        selected.push(cb.dataset.perm);
      });
      permField.value = JSON.stringify({ permissions: selected });
    }

    // -------- Activity Logs Filtering --------
    function setActivityFilter(type) {
      const buttons = document.querySelectorAll('.activity-filter-item');
      buttons.forEach(btn => {
        const filter = btn.getAttribute('data-filter');
        if (filter === type) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      const logs = document.querySelectorAll('.activity-log-item');
      logs.forEach(item => {
        const itemType = item.getAttribute('data-type') || 'system';
        if (type === 'all' || itemType === type) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Initialize permissions system - runs immediately when DOM is ready
    function initializePermissions() {
      const form = document.getElementById('officerEditForm');
      const permField = document.getElementById('permissionsEditField');
      
      if (!form || !permField) {
        setTimeout(initializePermissions, 100);
        return;
      }

      // Check if permissions checkboxes exist
      const permissionCheckboxes = document.querySelectorAll('.permission-checkbox');
      if (permissionCheckboxes.length === 0) {
        setTimeout(initializePermissions, 100);
        return;
      }

      let existingPermissions = {};
      
      // First try to use the global permissions if available (from server)
      if (window.__officerPermissions && window.__officerPermissions.permissions) {
        existingPermissions = window.__officerPermissions;
        console.log('[Edit Officer] Using permissions from window.__officerPermissions:', existingPermissions);
      } else {
        // Fallback to parsing from field
        try {
          const permValue = permField.value || '{}';
          if (permValue && permValue.trim() && permValue !== '{}') {
            existingPermissions = JSON.parse(permValue);
            console.log('[Edit Officer] Loaded permissions from field:', existingPermissions);
            console.log('[Edit Officer] Permission count:', existingPermissions.permissions?.length || 0);
          } else {
            console.warn('[Edit Officer] No permissions found in field (value is empty or {}), checking if we need to fetch from role...');
            // If field is empty, try to get role and fetch permissions
            const roleSelect = document.querySelector('select[name="role"]');
            const currentRole = roleSelect ? roleSelect.value : '';
            if (currentRole && currentRole.toLowerCase().includes('president')) {
              console.warn('[Edit Officer] President role detected but no permissions in field - this should have been auto-loaded by server');
            }
            existingPermissions = {};
          }
        } catch (e) {
          console.error('[Edit Officer] Error parsing permissions:', e, 'Raw value:', permField.value);
          existingPermissions = {};
        }
      }

      // Reset all checkboxes first
      document.querySelectorAll('.permission-checkbox').forEach(cb => {
        cb.checked = false;
      });

      // Reset all category states
      document.querySelectorAll('.permission-category-content').forEach(content => {
        content.classList.remove('expanded');
      });
      document.querySelectorAll('.permission-category').forEach(category => {
        category.classList.remove('expanded');
      });
      
      // Load permissions from the field
      if (existingPermissions.permissions && Array.isArray(existingPermissions.permissions) && existingPermissions.permissions.length > 0) {
        const loadedCategories = new Set();
        let checkedCount = 0;
        let notFoundCount = 0;
        const notFoundPerms = [];
        
        // Specific member permissions to check
        const memberPerms = ['view_members', 'add_members', 'edit_members', 'remove_members', 'approve_applications'];
        const memberPermsInData = memberPerms.filter(p => existingPermissions.permissions.includes(p));
        console.log(`[Edit Officer] Member permissions in data:`, memberPermsInData);
        console.log(`[Edit Officer] All permissions count:`, existingPermissions.permissions.length);
        
        existingPermissions.permissions.forEach(perm => {
          const checkbox = document.querySelector(`[data-perm="${perm}"]`);
          if (checkbox) {
            checkbox.checked = true;
            checkedCount++;
            const categoryId = checkbox.dataset.category;
            if (categoryId) {
              loadedCategories.add(categoryId);
              const category = document.querySelector(`[data-category="${categoryId}"]`);
              const content = document.getElementById(`content-${categoryId}`);
              if (category && content) {
                category.classList.add('expanded');
                content.classList.add('expanded');
              }
            }
          } else {
            notFoundCount++;
            notFoundPerms.push(perm);
            console.warn(`[Edit Officer] Permission checkbox not found for: ${perm}`);
          }
        });
        
        // Check specifically for member permissions
        memberPerms.forEach(perm => {
          const checkbox = document.querySelector(`[data-perm="${perm}"]`);
          const isInData = existingPermissions.permissions.includes(perm);
          console.log(`[Edit Officer] Member permission "${perm}": in data=${isInData}, checkbox exists=${!!checkbox}, checked=${checkbox?.checked || false}`);
        });
        
        console.log(`[Edit Officer] Successfully checked ${checkedCount} permissions across ${loadedCategories.size} categories`);
        if (notFoundCount > 0) {
          console.warn(`[Edit Officer] ${notFoundCount} permissions were not found in the form:`, notFoundPerms);
        }
        
        // Verify the checkboxes are actually checked
        const verifiedChecked = document.querySelectorAll('.permission-checkbox:checked').length;
        if (verifiedChecked !== checkedCount) {
          console.warn(`[Edit Officer] Mismatch: Expected ${checkedCount} checked, but found ${verifiedChecked} actually checked`);
        }
        
        // Double-check member permissions are checked
        const memberCheckboxesChecked = memberPerms.filter(perm => {
          const cb = document.querySelector(`[data-perm="${perm}"]`);
          return cb && cb.checked;
        });
        console.log(`[Edit Officer] Member permissions actually checked:`, memberCheckboxesChecked);
        if (memberCheckboxesChecked.length < memberPermsInData.length) {
          console.error(`[Edit Officer] ERROR: Some member permissions are missing! Expected ${memberPermsInData.length}, found ${memberCheckboxesChecked.length}`);
        }
      } else {
        console.warn('[Edit Officer] No permissions to load or permissions array is empty');
        console.warn('[Edit Officer] Permissions data:', existingPermissions);
        
        // If no permissions but we have a role, log it for debugging
        const roleSelect = document.querySelector('select[name="role"]');
        const currentRole = roleSelect ? roleSelect.value : '';
        if (currentRole) {
          console.warn(`[Edit Officer] Officer role is: "${currentRole}" - permissions should have been auto-loaded by server`);
        }
      }
      
      // Attach event listeners
      attachPermissionListeners();
      
      // Update UI state
      updateCategoryCheckboxes();
      updateCategoryCounts();
      updatePermissionSummary();
      updatePermissionsField();

      // Mark permissions as initialized (permission update is handled in main form submit handler)
      if (!form.hasAttribute('data-permissions-initialized')) {
        form.setAttribute('data-permissions-initialized', 'true');
      }
      
      if (window.lucide) {
        window.lucide.replace();
      }

      // Default Activity Logs filter
      if (typeof setActivityFilter === 'function') {
        setActivityFilter('all');
      }
    }

    // Initialize permissions when DOM is ready
    function startPermissionInitialization() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(initializePermissions, 200);
        });
      } else {
        setTimeout(initializePermissions, 200);
      }
      
      // Also try after a longer delay to ensure all elements are rendered
      setTimeout(function() {
        const permField = document.getElementById('permissionsEditField');
        const permissionCheckboxes = document.querySelectorAll('.permission-checkbox');
        
        if (permField && permissionCheckboxes.length > 0) {
          try {
            const permValue = permField.value || '{}';
            if (permValue && permValue.trim() && permValue !== '{}') {
              const existingPermissions = JSON.parse(permValue);
              if (existingPermissions.permissions && existingPermissions.permissions.length > 0) {
                // Re-check if permissions weren't loaded initially
                const checkedCount = document.querySelectorAll('.permission-checkbox:checked').length;
                if (checkedCount === 0) {
                  console.log('[Edit Officer] Permissions found but not loaded, re-initializing...');
                  initializePermissions();
                } else {
                  console.log(`[Edit Officer] Permissions already loaded (${checkedCount} checked)`);
                }
              }
            }
          } catch (e) {
            console.error('[Edit Officer] Error checking permissions:', e);
          }
        }
      }, 800);
    }
    
    startPermissionInitialization();

    // Student ID validation: exactly 6 digits
    function validateStudentId() {
      const idInput = document.getElementById('studentid');
      let id = idInput.value.trim();
      
      id = id.replace(/\D/g, '');
      idInput.value = id;
      
      const warningsDiv = document.getElementById('validationWarnings');
      const warningList = document.getElementById('warningList');
      
      if (id && id.length !== 6) {
        idInput.classList.add('border-red-500');
        idInput.classList.remove('border-slate-300');
        
        let idWarning = document.getElementById('idWarning');
        if (!idWarning) {
          idWarning = document.createElement('li');
          idWarning.id = 'idWarning';
          warningList.appendChild(idWarning);
        }
        idWarning.textContent = 'Student ID must be exactly 6 digits';
        
        warningsDiv.classList.remove('hidden');
        return false;
      } else {
        idInput.classList.remove('border-red-500');
        idInput.classList.add('border-slate-300');
        
        const idWarning = document.getElementById('idWarning');
        if (idWarning) {
          idWarning.remove();
        }
        
        if (warningList.children.length === 0) {
          warningsDiv.classList.add('hidden');
        }
        return true;
      }
    }

    // Name validation
    function validateName(inputId, warningId) {
      const nameInput = document.getElementById(inputId);
      const name = nameInput.value.trim();
      const warningsDiv = document.getElementById('validationWarnings');
      const warningList = document.getElementById('warningList');
      
      const namePattern = /^[A-Za-z\s'-]+$/;
      const dangerousPatterns = /[<>\"&;{}[\]()=+*$%#@!`~|\\]/;
      
      if (name && (dangerousPatterns.test(name) || !namePattern.test(name))) {
        nameInput.classList.add('border-red-500');
        nameInput.classList.remove('border-slate-300');
        
        let nameWarning = document.getElementById(warningId);
        if (!nameWarning) {
          nameWarning = document.createElement('li');
          nameWarning.id = warningId;
          warningList.appendChild(nameWarning);
        }
        nameWarning.textContent = `${inputId === 'firstName' ? 'First' : 'Last'} name contains invalid characters. Only letters, spaces, hyphens (-), and apostrophes (') are allowed.`;
        
        warningsDiv.classList.remove('hidden');
        return false;
      } else {
        nameInput.classList.remove('border-red-500');
        nameInput.classList.add('border-slate-300');
        
        const nameWarning = document.getElementById(warningId);
        if (nameWarning) {
          nameWarning.remove();
        }
        
        if (warningList.children.length === 0) {
          warningsDiv.classList.add('hidden');
        }
        return true;
      }
    }


    // Form submission validation and permission update
    const form = document.getElementById('officerEditForm');
    if (form) {
      form.addEventListener('submit', function(e) {
        // Always update permissions field before submission
        if (typeof updatePermissionsField === 'function') {
          updatePermissionsField();
          const finalPerms = document.getElementById('permissionsEditField');
          if (finalPerms) {
            console.log('[Edit Officer] Form submitting with permissions:', finalPerms.value);
          }
        }
        
        // Validate form fields
        const idValid = validateStudentId();
        const firstNameValid = validateName('firstName', 'firstNameWarning');
        const lastNameValid = validateName('lastName', 'lastNameWarning');
        
        // Validate role
        const roleSelect = document.querySelector('select[name="role"]');
        if (roleSelect && !roleSelect.value) {
          e.preventDefault();
          showToast('Please select a role.', 'error', 'Validation Error');
          return false;
        }
        
        // Validate password change
        const currentPasswordField = document.getElementById('current_password');
        const passwordField = document.getElementById('password');
        const confirmPasswordField = document.getElementById('confirm_password');
        const passwordMatchError = document.getElementById('password-match-error');
        
        if (passwordField && confirmPasswordField) {
          const currentPassword = currentPasswordField ? currentPasswordField.value.trim() : '';
          const password = passwordField.value.trim();
          const confirmPassword = confirmPasswordField.value.trim();
          
          if (password.length > 0) {
            // If changing password, current password is required
            if (!currentPassword || currentPassword.length === 0) {
              e.preventDefault();
              showToast('Current password is required to change password.', 'error', 'Validation Error');
              return false;
            }
            
            if (confirmPassword.length === 0) {
              e.preventDefault();
              showToast('Please confirm your new password.', 'error', 'Validation Error');
              if (passwordMatchError) {
                passwordMatchError.textContent = 'Please confirm your new password';
                passwordMatchError.classList.remove('hidden');
              }
              return false;
            }
            
            if (password !== confirmPassword) {
              e.preventDefault();
              showToast('New passwords do not match.', 'error', 'Validation Error');
              if (passwordMatchError) {
                passwordMatchError.textContent = 'New passwords do not match';
                passwordMatchError.classList.remove('hidden');
              }
              return false;
            }
          }
          
          // Clear error if passwords match
          if (passwordMatchError && password === confirmPassword) {
            passwordMatchError.classList.add('hidden');
          }
        }
        
        if (!idValid || !firstNameValid || !lastNameValid) {
          e.preventDefault();
          showToast('Please fix the validation errors before submitting.', 'error', 'Validation Error');
          return false;
        }
        
        // Show loading state
        const submitButtons = form.querySelectorAll('button[type="submit"]');
        submitButtons.forEach(btn => {
          btn.disabled = true;
          btn.innerHTML = '<i data-lucide="loader-2" class="inline w-4 h-4 mr-1 animate-spin"></i> Saving...';
          if (window.lucide) window.lucide.replace();
        });
        
        // Allow form to submit
        return true;
      });
    }

    // Password confirmation validation (real-time)
    const currentPasswordField = document.getElementById('current_password');
    const passwordField = document.getElementById('password');
    const confirmPasswordField = document.getElementById('confirm_password');
    const passwordMatchError = document.getElementById('password-match-error');
    
    if (passwordField && confirmPasswordField && passwordMatchError) {
      function validatePasswordMatch() {
        const currentPassword = currentPasswordField ? currentPasswordField.value.trim() : '';
        const password = passwordField.value.trim();
        const confirmPassword = confirmPasswordField.value.trim();
        
        if (password.length === 0 && confirmPassword.length === 0) {
          passwordMatchError.classList.add('hidden');
          return;
        }
        
        if (password.length > 0) {
          if (currentPassword && currentPassword.length === 0) {
            passwordMatchError.textContent = 'Current password is required';
            passwordMatchError.classList.remove('hidden');
            return;
          }
          
          if (confirmPassword.length === 0) {
            passwordMatchError.textContent = 'Please confirm your new password';
            passwordMatchError.classList.remove('hidden');
            return;
          }
          
          if (password !== confirmPassword) {
            passwordMatchError.textContent = 'New passwords do not match';
            passwordMatchError.classList.remove('hidden');
          } else {
            passwordMatchError.classList.add('hidden');
          }
        }
      }
      
      if (currentPasswordField) {
        currentPasswordField.addEventListener('input', validatePasswordMatch);
      }
      passwordField.addEventListener('input', validatePasswordMatch);
      confirmPasswordField.addEventListener('input', validatePasswordMatch);
    }

    // Mobile sidebar toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (sidebar && overlay) {
        sidebar.classList.toggle('sidebar-hidden');
        overlay.classList.toggle('hidden');
      }
    }
    document.getElementById('mobileMenuBtn')?.addEventListener('click', toggleSidebar);
    document.getElementById('sidebarOverlay')?.addEventListener('click', toggleSidebar);

    // Password visibility toggle function
    function togglePasswordVisibility(inputId, buttonId) {
      const input = document.getElementById(inputId);
      const button = document.getElementById(buttonId);
      if (input && button) {
        if (input.type === 'password') {
          input.type = 'text';
          button.innerHTML = '<i data-lucide="eye-off" class="w-5 h-5"></i>';
        } else {
          input.type = 'password';
          button.innerHTML = '<i data-lucide="eye" class="w-5 h-5"></i>';
        }
        if (window.lucide) window.lucide.replace();
      }
    }
  </script>
  <script src="/js/departmentPrograms.js"></script>
  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <script>
    // Toast Notification Function
    function showToast(message, type = 'error', title = null) {
      const container = document.getElementById('toastContainer');
      if (!container) {
        const newContainer = document.createElement('div');
        newContainer.id = 'toastContainer';
        newContainer.style.cssText = 'position: fixed; top: 24px; right: 24px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; pointer-events: none;';
        document.body.appendChild(newContainer);
        container = newContainer;
      }

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;

      const icons = {
        success: '<i class="fas fa-check-circle"></i>',
        error: '<i class="fas fa-exclamation-circle"></i>',
        warning: '<i class="fas fa-exclamation-triangle"></i>',
        info: '<i class="fas fa-info-circle"></i>'
      };

      const icon = icons[type] || icons.error;

      toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-content">
          ${title ? `<div class="toast-title">${title}</div>` : ''}
          <div class="toast-message">${message}</div>
        </div>
        <div class="toast-close" onclick="this.parentElement.remove()">×</div>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 300);
      }, 5000);
    }
  </script>
</body>
</html>
