<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="https://phshirt.com/wp-content/uploads/2022/01/UM-Tagum-College-1950.png" type="image/x-icon">
  <title><%= title || 'Requirements | UniClub' %></title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { brand: { 700:'#b91c1c' }}}}}
  </script>
  <style>
    /* Mobile sidebar toggle */
    @media (max-width: 1024px) {
      .sidebar-hidden {
        transform: translateX(-100%);
      }
    }
    /* Line clamping for long text */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
  </head>
<body class="bg-gray-50 text-gray-900">
  <!-- Mobile menu button -->
  <button id="mobileMenuBtn" class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-white rounded-lg shadow-md hover:bg-gray-100 transition">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
  </button>
  <div class="min-h-screen lg:grid lg:grid-cols-[260px_1fr] gap-6 p-6">
    <!-- Sidebar -->
    <div id="sidebar" class="lg:block sidebar-hidden fixed lg:static inset-y-0 left-0 z-40 transition-transform duration-300 ease-in-out w-64 lg:w-auto">
      <%- include('../layouts/adminSidebar', { currentPath: (typeof currentPath !== 'undefined' ? currentPath : '/admin/requirements'), messages: [] }) %>
    </div>
    <!-- Overlay for mobile -->
    <div id="sidebarOverlay" class="lg:hidden hidden fixed inset-0 bg-black bg-opacity-50 z-30" onclick="toggleSidebar()"></div>

    <!-- Main -->
    <main class="flex flex-col gap-6 lg:mt-0 mt-16">
      <!-- Page Header with Actions -->
      <div class="mb-2">
        <div class="flex items-center justify-between mb-2">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-1">Requirements & Activities</h1>
            <p class="text-base text-gray-600">Manage officer submissions and scheduled activities</p>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin/requirements/create" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold transition-colors shadow-sm hover:shadow">
              Create Requirement
            </a>
            <a href="/admin/events/create" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold transition-colors shadow-sm hover:shadow">
              Schedule Activity
            </a>
          </div>
        </div>
      </div>

      <!-- Officer Submissions (Primary Section) -->
      <section class="bg-white border border-gray-200 rounded-xl shadow-sm">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Officer Submissions</h2>
        </div>

        <div class="p-6">
          <% const _requirements = (typeof requirements !== 'undefined' && Array.isArray(requirements)) ? requirements : []; %>
          <% if (_requirements.length === 0) { %>
            <div class="py-12 px-4 text-center">
              <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-100 flex items-center justify-center">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-gray-900 mb-2">No submissions yet</h3>
              <p class="text-sm text-gray-600 mb-6 max-w-md mx-auto">Officers will submit requirements here once they upload from their dashboard. You can also create requirements proactively to guide their submissions.</p>
              <a href="/admin/requirements/create" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold transition-colors shadow-sm">
                <i data-lucide="plus" class="w-4 h-4"></i> Create First Requirement
              </a>
            </div>
          <% } else { %>
            <div class="overflow-auto rounded-lg border border-gray-200">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-4 py-2.5 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">Requirement</th>
                    <th class="px-4 py-2.5 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">Club</th>
                    <th class="px-4 py-2.5 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">Due Date</th>
                    <th class="px-4 py-2.5 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">Status</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 bg-white">
                  <% _requirements.forEach((r, index) => { %>
                    <tr class="hover:bg-blue-50 transition-colors <%= index % 2 === 0 ? 'bg-white' : 'bg-gray-50' %>">
                      <td class="px-4 py-2.5 text-sm text-gray-900">
                        <div class="line-clamp-2" title="<%= r.requirement %>"><%= r.requirement %></div>
                      </td>
                      <td class="px-4 py-2.5">
                        <% if (r.club_name) { %>
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">
                            <%= r.club_name %>
                          </span>
                        <% } else { %>
                          <span class="text-gray-400 text-sm">—</span>
                        <% } %>
                      </td>
                      <td class="px-4 py-2.5 text-sm text-gray-600"><%= r.due_date || '—' %></td>
                      <td class="px-4 py-2.5">
                        <% 
                          const rs = (r.status || 'Pending').toLowerCase();
                          const rClasses =
                            rs === 'confirmed' ? 'bg-green-100 text-green-700' :
                            rs === 'scheduled' ? 'bg-blue-100 text-blue-700' :
                            rs === 'cancelled' || rs === 'canceled' ? 'bg-red-100 text-red-700' :
                            'bg-yellow-100 text-yellow-700';
                        %>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold <%= rClasses %>">
                          <%= r.status || 'Pending' %>
                        </span>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </section>

      <!-- Scheduled Activities -->
      <section class="bg-white border border-gray-200 rounded-xl shadow-sm">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Scheduled Activities</h2>
        </div>

        <div class="p-6">
          <% const _activities = (typeof activities !== 'undefined' && Array.isArray(activities)) ? activities : []; %>
          
          <!-- Search and Filter Toolbar -->
          <div class="mb-4 flex flex-wrap items-center gap-3">
            <div class="flex-1 min-w-[200px]">
              <input 
                type="text" 
                id="activitySearch" 
                placeholder="Search activities..." 
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
              />
            </div>
            <select id="activityFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
              <option value="all">All Clubs</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="scheduled">Scheduled</option>
            </select>
            <select id="activitySort" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
              <option value="date-desc">Date (Newest)</option>
              <option value="date-asc">Date (Oldest)</option>
              <option value="name-asc">Name (A-Z)</option>
              <option value="name-desc">Name (Z-A)</option>
            </select>
          </div>

          <% if (_activities.length === 0) { %>
            <div class="py-12 px-4 text-center">
              <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-100 flex items-center justify-center">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-gray-900 mb-2">No activities scheduled</h3>
              <p class="text-sm text-gray-600 mb-6 max-w-md mx-auto">Start planning club activities and events. Scheduled activities will help officers and students stay informed about upcoming events.</p>
              <a href="/admin/events/create" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold transition-colors shadow-sm">
                <i data-lucide="calendar-plus" class="w-4 h-4"></i> Schedule Activity
              </a>
            </div>
          <% } else { %>
            <div class="overflow-auto rounded-lg border border-gray-200">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-4 py-2.5 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">Activity</th>
                    <th class="px-4 py-2.5 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">Club</th>
                    <th class="px-4 py-2.5 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">Date</th>
                    <th class="px-4 py-2.5 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">Location</th>
                    <th class="px-4 py-2.5 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">Status</th>
                    <th class="px-4 py-2.5 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 bg-white" id="activitiesTableBody">
                  <% _activities.forEach((a, index) => { 
                       const s = (a.status || 'Scheduled').toLowerCase();
                       const sClass = s === 'confirmed' ? 'bg-green-100 text-green-700'
                                     : s === 'scheduled' ? 'bg-blue-100 text-blue-700'
                                     : s === 'cancelled' || s === 'canceled' ? 'bg-red-100 text-red-700'
                                     : 'bg-yellow-100 text-yellow-700';
                  %>
                    <tr class="activity-row hover:bg-blue-50 transition-colors <%= index % 2 === 0 ? 'bg-white' : 'bg-gray-50' %>" data-club="<%= (a.club_name || '').toLowerCase() %>" data-status="<%= s %>" data-activity="<%= (a.activity || '').toLowerCase() %>" data-date="<%= a.date || '' %>">
                      <td class="px-4 py-2.5 text-sm font-medium text-gray-900"><%= a.activity %></td>
                      <td class="px-4 py-2.5">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">
                          <%= a.club_name || '—' %>
                        </span>
                      </td>
                      <td class="px-4 py-2.5 text-sm text-gray-600"><%= a.date || '—' %></td>
                      <td class="px-4 py-2.5 text-sm text-gray-600"><%= a.location || '—' %></td>
                      <td class="px-4 py-2.5">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold <%= sClass %>">
                          <%= a.status || 'Scheduled' %>
                        </span>
                      </td>
                      <td class="px-4 py-2.5">
                        <div class="flex items-center gap-2">
                          <a href="/admin/events/edit/<%= a.id %>"
                             class="inline-flex items-center px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold transition-colors">
                            Edit
                          </a>
                          <form method="post" action="/admin/events/delete/<%= a.id %>" class="inline">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <button type="submit"
                              class="inline-flex items-center px-3 py-1.5 rounded-lg bg-red-600 hover:bg-red-700 text-white text-xs font-semibold transition-colors"
                              onclick="return confirm('Delete this activity?');">
                              Delete
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </section>
    </main>
  </div>
  <script>
    // Mobile sidebar toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (sidebar && overlay) {
        sidebar.classList.toggle('sidebar-hidden');
        overlay.classList.toggle('hidden');
      }
    }
    document.getElementById('mobileMenuBtn')?.addEventListener('click', toggleSidebar);
    document.getElementById('sidebarOverlay')?.addEventListener('click', toggleSidebar);

    // Activities search and filter
    const activitySearch = document.getElementById('activitySearch');
    const activityFilter = document.getElementById('activityFilter');
    const activitySort = document.getElementById('activitySort');
    const activitiesTableBody = document.getElementById('activitiesTableBody');

    if (activitiesTableBody && activitySearch && activityFilter && activitySort) {
      const activityRows = Array.from(activitiesTableBody.querySelectorAll('.activity-row'));

      function filterAndSortActivities() {
        const searchTerm = (activitySearch.value || '').toLowerCase();
        const filterValue = activityFilter.value;
        const sortValue = activitySort.value;

        // Filter
        let filtered = activityRows.filter(row => {
          const matchesSearch = !searchTerm || 
            (row.dataset.activity || '').includes(searchTerm) ||
            (row.dataset.club || '').includes(searchTerm);
          
          const matchesFilter = filterValue === 'all' || 
            (filterValue === 'pending' && row.dataset.status === 'pending') ||
            (filterValue === 'confirmed' && row.dataset.status === 'confirmed') ||
            (filterValue === 'scheduled' && row.dataset.status === 'scheduled');

          return matchesSearch && matchesFilter;
        });

        // Sort
        filtered.sort((a, b) => {
          if (sortValue === 'date-desc') {
            return (b.dataset.date || '') > (a.dataset.date || '') ? 1 : -1;
          } else if (sortValue === 'date-asc') {
            return (a.dataset.date || '') > (b.dataset.date || '') ? 1 : -1;
          } else if (sortValue === 'name-asc') {
            return (a.dataset.activity || '') > (b.dataset.activity || '') ? 1 : -1;
          } else if (sortValue === 'name-desc') {
            return (b.dataset.activity || '') > (a.dataset.activity || '') ? 1 : -1;
          }
          return 0;
        });

        // Update DOM
        activitiesTableBody.innerHTML = '';
        if (filtered.length === 0) {
          activitiesTableBody.innerHTML = `
            <tr>
              <td colspan="6" class="px-4 py-10 text-center text-gray-500 text-sm">
                No activities match your filters.
              </td>
            </tr>
          `;
        } else {
          filtered.forEach(row => activitiesTableBody.appendChild(row));
        }
      }

      activitySearch?.addEventListener('input', filterAndSortActivities);
      activityFilter?.addEventListener('change', filterAndSortActivities);
      activitySort?.addEventListener('change', filterAndSortActivities);
    }
  </script>
</body>
</html>
