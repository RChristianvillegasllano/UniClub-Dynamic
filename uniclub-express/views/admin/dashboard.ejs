<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title><%= title || 'Admin Dashboard | UniClub' %></title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { theme: { extend: { colors: { brand: { 700:'#b91c1c' }}}}}
    </script>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div class="min-h-screen grid grid-cols-[260px_1fr] gap-6 p-6">
      <!-- Sidebar -->
      <%- include('../layouts/adminSidebar', { currentPath: (typeof currentPath !== 'undefined' ? currentPath : '/admin/dashboard'), messages: (typeof messages !== 'undefined' ? messages : []) }) %>

      <!-- Main -->
      <main class="flex flex-col gap-4">
        <!-- Header -->
        <div class="flex items-center justify-between">
          <h1 class="text-2xl font-semibold">Dashboard</h1>
          <p class="text-gray-500">Welcome, <span class="font-semibold"><%= (admin && admin.username) || 'Admin' %></span></p>
        </div>

        <!-- Top stats -->
        <section class="grid md:grid-cols-3 gap-4">
          <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
            <p class="text-gray-500">Total Officers</p>
            <p class="text-3xl font-extrabold text-red-700 mt-1"><%= (officers && officers.length) || 0 %></p>
          </div>
          <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
            <p class="text-gray-500">Total Clubs</p>
            <p class="text-3xl font-extrabold text-red-700 mt-1"><%= clubsCount || 0 %></p>
          </div>
          <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
            <p class="text-gray-500">Reports Exported</p>
            <p class="text-3xl font-extrabold text-red-700 mt-1">0</p>
          </div>
        </section>

        <!-- Middle row -->
        <section class="grid lg:grid-cols-3 gap-4">
          <!-- Quick Analytics -->
          <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
            <h2 class="text-lg font-semibold">Quick Analytics</h2>
            <div class="my-3 h-px bg-gray-200"></div>
            <div class="flex items-center py-1.5">
              <span class="text-gray-500">Active Clubs</span>
              <span class="ml-auto text-xl font-extrabold text-red-700"><%= analytics?.activeClubs || 0 %></span>
            </div>
            <div class="flex items-center py-1.5">
              <span class="text-gray-500">Officers per Club (Avg)</span>
              <span class="ml-auto text-xl font-extrabold text-red-700"><%= analytics?.avgOfficersPerClub || 0 %></span>
            </div>
            <div class="flex items-center py-1.5">
              <span class="text-gray-500">Total Activities</span>
              <span class="ml-auto text-xl font-extrabold text-red-700"><%= analytics?.totalActivities || 0 %></span>
            </div>
            <div class="flex items-center py-1.5">
              <span class="text-gray-500">Most Active Department</span>
              <span class="ml-auto text-xl font-extrabold text-red-700"><%= analytics?.mostActiveDept || '—' %></span>
            </div>
          </div>

          <!-- Quick Communication -->
          <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
            <h2 class="text-lg font-semibold">Quick Communication</h2>
            <div class="my-3 h-px bg-gray-200"></div>
            <% const unread = (messages || []).filter(m => !m.read).length; %>
            <% const pendingCount = (requirements || []).filter(r => {
                 try { return String(r.status || '').toLowerCase() === 'pending'; } catch (_) { return false; }
               }).length; %>
            <div class="flex items-center py-1.5">
              <span class="text-gray-500">Unread Messages</span>
              <span class="ml-auto inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700"><%= unread %></span>
            </div>
            <div class="flex items-center py-1.5">
              <span class="text-gray-500">Pending Notifications</span>
              <span class="ml-auto inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700"><%= pendingCount %></span>
            </div>
            <% if (typeof announceSuccess !== 'undefined' && announceSuccess) { %>
              <div class="mt-3 text-sm rounded-lg border border-green-200 bg-green-50 text-green-700 px-3 py-2">Announcement sent.</div>
            <% } %>
            <form class="mt-3 space-y-3" method="POST" action="/admin/announcements">
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Audience</label>
                <select name="audience" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]">
                  <option value="all">All (Students & Officers)</option>
                  <option value="students">Students</option>
                  <option value="officers">Officers</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Subject</label>
                <input type="text" name="subject" required class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]" placeholder="Subject" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Message</label>
                <textarea name="content" rows="3" required class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a10109d1] focus:border-[#a10109d1]" placeholder="Write your announcement..."></textarea>
              </div>
              <button type="submit"
                class="w-full bg-red-700 hover:bg-red-800 text-white font-semibold rounded-xl px-4 py-2">
                Send Announcement
              </button>
            </form>
          </div>

          <!-- Clubs list -->
          <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-semibold">Clubs and Organizations</h2>
              <a href="/admin/clubs" class="text-sm text-red-700 hover:text-red-800 font-medium">View All</a>
            </div>
            
            <!-- Search input -->
            <div class="mb-3">
              <input 
                type="text" 
                id="clubSearch" 
                placeholder="Search clubs..." 
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500"
              />
            </div>
            
            <!-- Clubs list container -->
            <div id="clubsListContainer">
              <ul class="mt-3 space-y-2 max-h-64 overflow-y-auto">
                <% if ((clubsList || []).length) { %>
                  <% clubsList.slice(0,8).forEach(c => { %>
                    <li class="px-3 py-2 rounded-xl border border-gray-200 bg-gray-50 flex items-center hover:bg-gray-100 transition">
                      <span class="font-semibold flex-1"><%= c.name %></span>
                      <span class="text-gray-500 text-sm"><%= c.department || '—' %></span>
                    </li>
                  <% }) %>
                  <% if (clubsCount > 8) { %>
                    <li class="px-3 py-2 rounded-xl border border-gray-200 bg-gray-50 text-center text-sm text-gray-500">
                      Showing 8 of <%= clubsCount %> clubs
                    </li>
                  <% } %>
                <% } else { %>
                  <li class="text-gray-500 text-center py-2">No clubs to show.</li>
                <% } %>
              </ul>
            </div>
            
            <!-- Loading indicator (hidden by default) -->
            <div id="clubsLoading" class="text-center py-4 text-gray-500 text-sm" style="display: none;">
              Loading...
            </div>
          </div>
          
          <script>
            // Store initial clubs data
            const initialClubsData = <%- JSON.stringify({
              clubs: (clubsList || []).slice(0, 8).map(c => ({
                name: c.name || '',
                department: c.department || '—'
              })),
              totalCount: clubsCount || 0
            }) %>;
            
            // Async club search using API
            const clubSearch = document.getElementById('clubSearch');
            const clubsListContainer = document.getElementById('clubsListContainer');
            const clubsLoading = document.getElementById('clubsLoading');
            let searchTimeout;
            
            function renderClubsList(clubs, totalCount, isSearch = false) {
              if (!clubs || clubs.length === 0) {
                clubsListContainer.innerHTML = `
                  <ul class="mt-3 space-y-2">
                    <li class="text-gray-500 text-center py-2">No clubs to show.</li>
                  </ul>
                `;
                return;
              }
              
              const listItems = clubs.map(club => `
                <li class="px-3 py-2 rounded-xl border border-gray-200 bg-gray-50 flex items-center hover:bg-gray-100 transition">
                  <span class="font-semibold flex-1">${club.name || '—'}</span>
                  <span class="text-gray-500 text-sm">${club.department || '—'}</span>
                </li>
              `).join('');
              
              const footer = isSearch && totalCount > 10 
                ? `<li class="px-3 py-2 rounded-xl border border-gray-200 bg-gray-50 text-center text-sm text-gray-500">
                     Showing ${clubs.length} of ${totalCount} results
                   </li>`
                : !isSearch && totalCount > 8
                ? `<li class="px-3 py-2 rounded-xl border border-gray-200 bg-gray-50 text-center text-sm text-gray-500">
                     Showing 8 of ${totalCount} clubs
                   </li>`
                : '';
              
              clubsListContainer.innerHTML = `
                <ul class="mt-3 space-y-2 max-h-64 overflow-y-auto">
                  ${listItems}
                  ${footer}
                </ul>
              `;
            }
            
            // Initialize with original clubs
            renderClubsList(initialClubsData.clubs, initialClubsData.totalCount);
            
            clubSearch?.addEventListener('input', function(e) {
              const searchTerm = e.target.value.trim();
              
              // Clear previous timeout
              clearTimeout(searchTimeout);
              
              // If search is empty, show original list
              if (!searchTerm) {
                renderClubsList(initialClubsData.clubs, initialClubsData.totalCount);
                return;
              }
              
              // Debounce search
              searchTimeout = setTimeout(async () => {
                clubsListContainer.style.display = 'none';
                clubsLoading.style.display = 'block';
                
                try {
                  const response = await fetch(`/api/clubs?search=${encodeURIComponent(searchTerm)}&limit=10`);
                  const data = await response.json();
                  
                  if (data.success && data.data.length > 0) {
                    renderClubsList(data.data, data.pagination.total, true);
                  } else {
                    clubsListContainer.innerHTML = `
                      <ul class="mt-3 space-y-2">
                        <li class="text-gray-500 text-center py-4">No clubs found matching "${searchTerm}"</li>
                      </ul>
                    `;
                  }
                } catch (error) {
                  console.error('Error searching clubs:', error);
                  clubsListContainer.innerHTML = `
                    <ul class="mt-3 space-y-2">
                      <li class="text-red-500 text-center py-4">Error loading clubs. Please try again.</li>
                    </ul>
                  `;
                } finally {
                  clubsListContainer.style.display = 'block';
                  clubsLoading.style.display = 'none';
                }
              }, 300);
            });
          </script>
        </section>

        <!-- Recent Activity -->
        <section class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4">
          <h2 class="text-lg font-semibold">Recent Activity</h2>
          <ul class="mt-3 space-y-2">
            <% if ((recentActivities || []).length) { %>
              <% recentActivities.forEach(a => { %>
                <li class="px-3 py-2 rounded-xl border border-gray-200 bg-gray-50 flex items-center">
                  <span><%= a.name || a.activity || ('Record #' + a.id) %></span>
                  <span class="ml-auto text-gray-500 text-sm">
                    <%= a.created_at ? new Date(a.created_at).toLocaleString() : '' %>
                  </span>
                </li>
              <% }) %>
            <% } else { %>
              <li class="text-gray-500">No recent activity.</li>
            <% } %>
          </ul>
        </section>
      </main>
    </div>
  </body>
</html>
