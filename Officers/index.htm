<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UniClub Officer Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>UniClub Officer Dashboard</title>
        <link
          href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css"
          rel="stylesheet"
        />
        <link rel="stylesheet" href="style.css" />
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      </head>
      <body>
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
          <div class="menu-toggle" id="menuToggle">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
          </div>
          <a href="#" id="sidebarDashboard" class="active"
            ><i class="ri-dashboard-line"></i> <span>Dashboard</span></a
          >
          <a href="#" id="sidebarMemberApprovals"
            ><i class="ri-user-add-line"></i> <span>Member Approvals</span></a
          >
          <a href="#" id="sidebarAttendance"
            ><i class="ri-calendar-check-line"></i> <span>Attendance</span></a
          >
          <a href="#" id="sidebarClubRecords"
            ><i class="ri-team-line"></i> <span>Club Records</span></a
          >
          <a href="#" id="sidebarOfficerRoles"
            ><i class="ri-user-star-line"></i> <span>Officer Roles</span></a
          >
          <a href="#" id="sidebarAnalytics"
            ><i class="ri-bar-chart-box-line"></i> <span>Analytics</span></a
          >
          <a href="#" id="sidebarRequirementsActivities"
            ><i class="ri-todo-line"></i>
            <span>Requirements/Activities</span></a
          >
          <div class="modal" id="analyticsModal">
            <div class="modal-content">
              <span class="close-btn" onclick="closeAnalyticsModal()">✖</span>
              <h3>Analytics</h3>
              <div id="analyticsModalContent">
                <canvas
                  id="analyticsModalChart"
                  style="width: 100%; height: 300px"
                ></canvas>
                <div style="margin-top: 24px">
                  <h4 style="color: #8e0e00">Analytics Details</h4>
                  <ul style="font-size: 15px; color: #333; margin-bottom: 12px">
                    <li><strong>Highest Attendance:</strong> April (95%)</li>
                    <li><strong>Lowest Attendance:</strong> March (80%)</li>
                    <li><strong>Average Attendance:</strong> 87.6%</li>
                  </ul>
                  <h4 style="color: #8e0e00">Attendance Records</h4>
                  <table
                    style="
                      width: 100%;
                      font-size: 14px;
                      border-collapse: collapse;
                    "
                  >
                    <thead style="background: #8e0e00; color: #fff">
                      <tr>
                        <th>Month</th>
                        <th>Attendance %</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>Jan</td>
                        <td>90%</td>
                      </tr>
                      <tr>
                        <td>Feb</td>
                        <td>85%</td>
                      </tr>
                      <tr>
                        <td>Mar</td>
                        <td>80%</td>
                      </tr>
                      <tr>
                        <td>Apr</td>
                        <td>95%</td>
                      </tr>
                      <tr>
                        <td>May</td>
                        <td>88%</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <a href="#" id="sidebarCommunication"
            ><i class="ri-notification-3-line"></i>
            <span>Communication</span></a
          >
        </div>

        <!-- Main -->
        <div class="main">
          <div class="topbar">
            <h1 id="dashboardHeading">Officer Dashboard</h1>
            <div
              class="topbar-right"
              style="
                margin-left: auto;
                display: flex;
                align-items: center;
                gap: 16px;
              "
            >
              <div class="notif" id="notifBtn" style="position: relative">
                <i class="ri-notification-2-line"></i>
                <span id="notifCount">3</span>
                <div
                  id="notifDropdown"
                  style="
                    display: none;
                    position: absolute;
                    right: 0;
                    top: 40px;
                    background: #fff;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
                    border-radius: 12px;
                    min-width: 320px;
                    z-index: 100;
                    border: 1px solid #e5e7eb;
                  "
                >
                  <div
                    style="
                      padding: 16px 20px;
                      border-bottom: 1px solid #f0f0f0;
                      font-weight: 600;
                      font-size: 17px;
                      color: #222;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                    "
                  >
                    <i
                      class="ri-notification-3-line"
                      style="font-size: 20px; color: #8e0e00"
                    ></i>
                    Announcements
                  </div>
                  <ul
                    id="notifAnnouncements"
                    style="
                      list-style: none;
                      margin: 0;
                      padding: 0;
                      max-height: 320px;
                      overflow-y: auto;
                    "
                  ></ul>
                  <div
                    style="
                      padding: 12px;
                      text-align: center;
                      font-size: 13px;
                      color: #aaa;
                      border-top: 1px solid #f0f0f0;
                      background: #fafbfc;
                      border-radius: 0 0 12px 12px;
                    "
                  >
                    No more announcements
                  </div>
                </div>
              </div>
              <script>
                // ...existing code...
                // Add event listeners to inline filter controls to sync with main table
                setTimeout(() => {
                  const inlineAttnSearch =
                    attendanceInlineSection.querySelector("#attnSearch");
                  const inlineAttnFilter =
                    attendanceInlineSection.querySelector("#attnFilter");
                  if (inlineAttnSearch && inlineAttnFilter) {
                    inlineAttnSearch.addEventListener("input", function () {
                      document.getElementById("attnSearch").value =
                        inlineAttnSearch.value;
                      applyAttendanceFilters();
                    });
                    inlineAttnFilter.addEventListener("change", function () {
                      document.getElementById("attnFilter").value =
                        inlineAttnFilter.value;
                      applyAttendanceFilters();
                    });
                  }
                }, 0);
                // Notification dropdown logic
                const notifBtn = document.getElementById("notifBtn");
                const notifDropdown = document.getElementById("notifDropdown");
                const notifAnnouncements =
                  document.getElementById("notifAnnouncements");
                const notifCountEl = document.getElementById("notifCount");

                // Load announcements from localStorage if available, otherwise seed with defaults
                let announcements = null;
                try {
                  announcements = JSON.parse(
                    localStorage.getItem("announcements")
                  );
                } catch (e) {
                  announcements = null;
                }
                if (
                  !Array.isArray(announcements) ||
                  announcements.length === 0
                ) {
                  announcements = [
                    {
                      title: "Welcome to UniClub",
                      message:
                        "This is your notifications center. You'll see announcements here.",
                    },
                    {
                      title: "General Assembly",
                      message: "Assembly on Sept 15, 2025 at 2PM.",
                    },
                  ];
                  try {
                    localStorage.setItem(
                      "announcements",
                      JSON.stringify(announcements)
                    );
                  } catch (e) {
                    // ignore storage errors (e.g., private mode)
                  }
                }

                function renderAnnouncements() {
                  notifAnnouncements.innerHTML = "";
                  if (announcements.length === 0) {
                    notifAnnouncements.innerHTML =
                      '<li style="padding:24px; text-align:center; color:#888;">No announcements</li>';
                    return;
                  }
                  announcements.forEach((a) => {
                    const li = document.createElement("li");
                    li.style.padding = "16px 20px";
                    li.style.borderBottom = "1px solid #f0f0f0";
                    li.style.transition = "background 0.2s";
                    li.style.cursor = "pointer";
                    li.onmouseover = () => (li.style.background = "#f6f8fa");
                    li.onmouseout = () => (li.style.background = "");
                    li.innerHTML = `
              <div style='display:flex; align-items:center; gap:12px;'>
                <div style='background:#8e0e00; color:#fff; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-size:18px;'>
                  <i class='ri-megaphone-line'></i>
                </div>
                <div style='flex:1;'>
                  <div style='font-weight:500; font-size:15px; color:#222;'>${a.title}</div>
                  <div style='font-size:13px; color:#555; margin-top:2px;'>${a.message}</div>
                </div>
              </div>
            `;
                    notifAnnouncements.appendChild(li);
                  });
                }

                // initialize badge count
                if (notifCountEl)
                  notifCountEl.textContent = announcements.length;

                // show/hide functions
                function showNotifications() {
                  // If there are no announcements for some reason, seed a default one
                  if (
                    !Array.isArray(announcements) ||
                    announcements.length === 0
                  ) {
                    announcements = [
                      {
                        title: "No announcements yet",
                        message:
                          "You have no announcements. Create one from Communication.",
                      },
                    ];
                    try {
                      localStorage.setItem(
                        "announcements",
                        JSON.stringify(announcements)
                      );
                    } catch (e) {}
                    if (notifCountEl)
                      notifCountEl.textContent = announcements.length;
                  }
                  renderAnnouncements();
                  notifDropdown.style.display = "block";
                  if (notifCountEl) notifCountEl.style.opacity = "0.9"; // subtle visual cue
                }

                function hideNotifications() {
                  notifDropdown.style.display = "none";
                }

                // Add a reusable helper to programmatically add notifications
                function addNotification(
                  title,
                  message,
                  opts = { show: false }
                ) {
                  if (!title && !message) return;
                  announcements.unshift({
                    title: title || "Announcement",
                    message: message || "",
                  });
                  try {
                    localStorage.setItem(
                      "announcements",
                      JSON.stringify(announcements)
                    );
                  } catch (e) {}
                  if (notifCountEl)
                    notifCountEl.textContent = announcements.length;
                  if (opts.show) showNotifications();
                }

                // expose addNotification for external use
                window.addNotification = addNotification;

                // expose to global so other code can call it
                window.showNotifications = showNotifications;
                window.hideNotifications = hideNotifications;

                notifBtn.addEventListener("click", (e) => {
                  e.stopPropagation();
                  if (
                    notifDropdown.style.display === "none" ||
                    !notifDropdown.style.display
                  ) {
                    showNotifications();
                  } else {
                    hideNotifications();
                  }
                });

                // Hide dropdown when clicking outside
                document.addEventListener("click", (e) => {
                  if (!notifBtn.contains(e.target)) {
                    notifDropdown.style.display = "none";
                  }
                });
                // Profile panel logic - initialize after DOM is ready
                document.addEventListener(
                  "DOMContentLoaded",
                  function initProfileModule() {
                    const topProfile = document.getElementById("topProfile");
                    const profilePanel =
                      document.getElementById("profilePanel");
                    if (!topProfile || !profilePanel) return;

                    function showProfile() {
                      profilePanel.style.display = "block";
                      requestAnimationFrame(() =>
                        profilePanel.classList.add("show")
                      );
                    }
                    function hideProfile() {
                      profilePanel.classList.remove("show");
                      setTimeout(() => {
                        try {
                          profilePanel.style.display = "none";
                        } catch (e) {}
                      }, 180);
                    }
                    window.showProfile = showProfile;
                    window.hideProfile = hideProfile;

                    topProfile.addEventListener("click", function (e) {
                      e.stopPropagation();
                      if (
                        profilePanel.style.display === "none" ||
                        !profilePanel.style.display
                      )
                        showProfile();
                      else hideProfile();
                    });

                    // Close profile panel when clicking outside
                    document.addEventListener("click", function (e) {
                      if (
                        !profilePanel.contains(e.target) &&
                        !topProfile.contains(e.target)
                      ) {
                        hideProfile();
                      }
                    });

                    // Profile data helpers
                    function loadProfileFromStorage() {
                      let p = null;
                      try {
                        p = JSON.parse(localStorage.getItem("userProfile"));
                      } catch (e) {
                        p = null;
                      }
                      if (!p || !p.name) {
                        p = {
                          name: "Officer",
                          role: "Club Officer",
                          email: "officer@example.com",
                          avatar: "https://i.pravatar.cc/64?u=officer",
                        };
                        try {
                          localStorage.setItem(
                            "userProfile",
                            JSON.stringify(p)
                          );
                        } catch (e) {}
                      } else if (p && p.name === "Officer Name") {
                        // normalize older value
                        p.name = "Officer";
                        try {
                          localStorage.setItem(
                            "userProfile",
                            JSON.stringify(p)
                          );
                        } catch (e) {}
                      }
                      return p;
                    }

                    function setProfile(profile) {
                      try {
                        localStorage.setItem(
                          "userProfile",
                          JSON.stringify(profile)
                        );
                      } catch (e) {}
                      // update UI
                      const topProfileImg =
                        document.querySelector("#topProfile img");
                      const topProfileName =
                        document.querySelector("#topProfile span");
                      if (topProfileImg)
                        topProfileImg.src = profile.avatar || topProfileImg.src;
                      if (topProfileName)
                        topProfileName.textContent =
                          profile.name || topProfileName.textContent;
                      // update panel content
                      const infoDivs =
                        profilePanel.querySelectorAll("div > div > div");
                      if (infoDivs && infoDivs.length >= 3) {
                        infoDivs[0].textContent = profile.name;
                        infoDivs[1].textContent =
                          "Role: " + (profile.role || "");
                        infoDivs[2].textContent = profile.email || "";
                      }
                      const panelImg = profilePanel.querySelector("img");
                      if (panelImg)
                        panelImg.src = profile.avatar || panelImg.src;
                    }

                    function getProfile() {
                      try {
                        return (
                          JSON.parse(localStorage.getItem("userProfile")) ||
                          loadProfileFromStorage()
                        );
                      } catch (e) {
                        return loadProfileFromStorage();
                      }
                    }

                    // Edit profile modal handlers
                    function openEditProfileModal() {
                      const modal = document.getElementById("editProfileModal");
                      const profile = getProfile();
                      // avatar URL removed; preserve stored avatar
                      modal.querySelector("#ep-name").value =
                        profile.name || "";
                      modal.querySelector("#ep-role").value =
                        profile.role || "";
                      modal.querySelector("#ep-email").value =
                        profile.email || "";
                      modal.style.display = "flex";
                    }

                    function closeEditProfileModal() {
                      const modal = document.getElementById("editProfileModal");
                      modal.style.display = "none";
                    }

                    function logout() {
                      if (confirm("Are you sure you want to logout?")) {
                        try {
                          // Clear all session data
                          localStorage.removeItem("userProfile");
                          localStorage.removeItem("isLoggedIn");
                          localStorage.removeItem("userRole");
                          localStorage.removeItem("userUMTCId");
                          localStorage.removeItem("userName");
                          localStorage.removeItem("loginTime");
                          localStorage.removeItem("rememberUMTC");
                          localStorage.removeItem("rememberUMTCId");
                          localStorage.removeItem("rememberRole");
                        } catch (e) {
                          console.warn("Failed to clear session data:", e);
                        }
                        
                        // Redirect to login page
                        window.location.href = "../Login/login.htm";
                      }
                    }

                    // Wire buttons
                    const editProfileBtn =
                      document.getElementById("editProfileBtn");
                    const logoutBtn = document.getElementById("logoutBtn");
                    if (editProfileBtn)
                      editProfileBtn.addEventListener(
                        "click",
                        openEditProfileModal
                      );
                    if (logoutBtn) logoutBtn.addEventListener("click", logout);

                    // Combined Email button (open mail client) and inline copy button
                    const emailBtn = document.getElementById("emailBtn");
                    const emailCopyBtn =
                      document.getElementById("emailCopyBtn");
                    if (emailCopyBtn) {
                      emailCopyBtn.addEventListener("click", function (ev) {
                        ev.preventDefault();
                        ev.stopPropagation();
                        const profile = getProfile();
                        if (navigator.clipboard && profile && profile.email) {
                          navigator.clipboard
                            .writeText(profile.email)
                            .then(() => {
                              toast("Email copied to clipboard", "success");
                            })
                            .catch(() => {
                              toast("Failed to copy email", "error");
                            });
                        } else {
                          toast("Copying not supported", "error");
                        }
                      });
                    }
                    // update mailto link when profile changes
                    function updateMailto() {
                      const profile = getProfile();
                      if (emailBtn && profile && profile.email)
                        emailBtn.href = "mailto:" + profile.email;
                    }
                    // Dark mode toggle
                    const darkModeToggle =
                      document.getElementById("darkModeToggle");
                    // load preference
                    const darkPref = localStorage.getItem("prefDarkMode");
                    if (darkPref === "1") {
                      document.documentElement.classList.add("dark");
                      if (darkModeToggle) darkModeToggle.checked = true;
                    }
                    if (darkModeToggle) {
                      darkModeToggle.addEventListener("change", function () {
                        if (this.checked) {
                          document.documentElement.classList.add("dark");
                          localStorage.setItem("prefDarkMode", "1");
                        } else {
                          document.documentElement.classList.remove("dark");
                          localStorage.setItem("prefDarkMode", "0");
                        }
                      });
                    }

                    // Change password form (client-side placeholder)
                    const changePassBtn =
                      document.getElementById("changePassBtn");
                    const changePassModal =
                      document.getElementById("changePassModal");
                    const changePassForm =
                      document.getElementById("changePassForm");
                    if (changePassBtn)
                      changePassBtn.addEventListener("click", () => {
                        if (changePassModal)
                          changePassModal.style.display = "flex";
                      });
                    const changePasswordBtn =
                      document.getElementById("changePasswordBtn");
                    if (changePasswordBtn)
                      changePasswordBtn.addEventListener("click", () => {
                        if (changePassModal)
                          changePassModal.style.display = "flex";
                      });
                    if (changePassForm) {
                      changePassForm.addEventListener("submit", function (e) {
                        e.preventDefault();
                        const oldp = document.getElementById("cp-old").value;
                        const newp = document.getElementById("cp-new").value;
                        const confirmp =
                          document.getElementById("cp-confirm").value;
                        if (newp.length < 6) {
                          toast(
                            "New password must be at least 6 characters.",
                            "error"
                          );
                          return;
                        }
                        if (newp !== confirmp) {
                          toast("Passwords do not match.", "error");
                          return;
                        }
                        // placeholder behavior
                        toast(
                          "Password changed (local placeholder).",
                          "success"
                        );
                        if (changePassModal)
                          changePassModal.style.display = "none";
                        changePassForm.reset();
                      });
                    }

                    // Persistent "Show passwords" checkbox wiring
                    (function () {
                      const showPasswordsToggle = document.getElementById(
                        "showPasswordsToggle"
                      );
                      const cpOld = document.getElementById("cp-old");
                      const cpNew = document.getElementById("cp-new");
                      const cpConfirm = document.getElementById("cp-confirm");

                      function setPasswordFieldsVisible(visible) {
                        const type = visible ? "text" : "password";
                        if (cpOld) cpOld.type = type;
                        if (cpNew) cpNew.type = type;
                        if (cpConfirm) cpConfirm.type = type;
                      }

                      if (showPasswordsToggle) {
                        showPasswordsToggle.addEventListener(
                          "change",
                          function () {
                            setPasswordFieldsVisible(this.checked);
                          }
                        );
                        // initialize according to checkbox state (in case modal reused)
                        setPasswordFieldsVisible(showPasswordsToggle.checked);
                      }
                    })();

                    // update mailto once on init
                    updateMailto();

                    // Toast helper (simple, lightweight)
                    function toast(message, type = "info", timeout = 3000) {
                      let container = document.getElementById("toastContainer");
                      if (!container) {
                        container = document.createElement("div");
                        container.id = "toastContainer";
                        document.body.appendChild(container);
                      }
                      const t = document.createElement("div");
                      t.className = "toast " + type;
                      t.textContent = message;
                      container.appendChild(t);
                      // animate in
                      requestAnimationFrame(() => t.classList.add("show"));
                      setTimeout(() => {
                        t.classList.remove("show");
                        setTimeout(() => {
                          try {
                            container.removeChild(t);
                          } catch (e) {}
                        }, 220);
                      }, timeout);
                    }

                    // Wire profile close button
                    const profileCloseBtn =
                      document.getElementById("profileCloseBtn");
                    if (profileCloseBtn)
                      profileCloseBtn.addEventListener("click", hideProfile);

                    // initialize profile UI from storage
                    setTimeout(() => {
                      setProfile(loadProfileFromStorage());
                    }, 50);

                    // Expose profile helpers on window for console / external use
                    window.getProfile = getProfile;
                    window.setProfile = setProfile;
                    window.openEditProfileModal = openEditProfileModal;
                    window.logout = logout;
                    window.openProfile = function (opts = { show: true }) {
                      const profile = getProfile();
                      if (opts.show) showProfile();
                      return profile;
                    };
                    console.log(
                      "Profile helpers exposed: getProfile, setProfile, openEditProfileModal, logout, openProfile, showProfile, hideProfile"
                    );
                  }
                );

                // Expose profile helpers on window for console / external use
                window.getProfile = getProfile;
                window.setProfile = setProfile;
                window.openEditProfileModal = openEditProfileModal;
                window.logout = logout;
                // openProfile returns current profile and optionally shows the panel
                window.openProfile = function (opts = { show: true }) {
                  const profile = getProfile();
                  if (opts.show) showProfile();
                  return profile;
                };
                console.log(
                  "Profile helpers exposed: getProfile, setProfile, openEditProfileModal, logout, openProfile, showProfile, hideProfile"
                );
                // Handle edit profile form submit
                const editProfileForm =
                  document.getElementById("editProfileForm");
                if (editProfileForm) {
                  editProfileForm.addEventListener("submit", function (e) {
                    e.preventDefault();
                    // allow replacing avatar with uploaded file data URL
                    const current = getProfile();
                    const avatarImg = document.getElementById("editAvatarImg");
                    const newProfile = {
                      avatar: avatarImg
                        ? avatarImg.src || current.avatar
                        : current.avatar,
                      name:
                        document.getElementById("ep-name").value || "Officer",
                      role:
                        document.getElementById("ep-role").value ||
                        "Club Officer",
                      email:
                        document.getElementById("ep-email").value ||
                        "officer@example.com",
                    };
                    setProfile(newProfile);
                    closeEditProfileModal();
                  });
                }

                // Upload avatar handling
                const uploadAvatarBtn =
                  document.getElementById("uploadAvatarBtn");
                const epAvatarFile = document.getElementById("ep-avatar-file");
                const editAvatarImg = document.getElementById("editAvatarImg");
                if (uploadAvatarBtn && epAvatarFile && editAvatarImg) {
                  uploadAvatarBtn.addEventListener("click", function () {
                    epAvatarFile.click();
                  });
                  epAvatarFile.addEventListener("change", function () {
                    const f = this.files && this.files[0];
                    if (!f) return;

                    // Validate file type
                    if (!f.type.startsWith("image/")) {
                      toast("Please select a valid image file", "error");
                      return;
                    }

                    // Validate file size (max 5MB)
                    if (f.size > 5 * 1024 * 1024) {
                      toast("Image size must be less than 5MB", "error");
                      return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (ev) {
                      editAvatarImg.src = ev.target.result;

                      // Update the profile with new avatar
                      const profile = getProfile();
                      profile.avatar = ev.target.result;
                      setProfile(profile);

                      toast("Avatar updated successfully!", "success");
                    };
                    reader.readAsDataURL(f);
                  });
                }
              </script>
              <div class="profile" id="topProfile">
                <img src="https://i.pravatar.cc/50" alt="Profile" />
                <span>Officer</span>
              </div>
              <!-- Profile quick panel -->
              <div
                id="profilePanel"
                style="
                  display: none;
                  position: absolute;
                  right: 20px;
                  top: 72px;
                  background: #fff;
                  border: 1px solid #e5e7eb;
                  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
                  border-radius: 10px;
                  z-index: 150;
                  min-width: 260px;
                  padding: 12px;
                "
              >
                <button class="close-small" id="profileCloseBtn" title="Close">
                  ✖
                </button>
                <div
                  style="
                    display: flex;
                    gap: 12px;
                    align-items: center;
                    padding: 8px;
                  "
                >
                  <img
                    src="https://i.pravatar.cc/64"
                    alt="Profile"
                    style="width: 48px; height: 48px; border-radius: 50%"
                  />
                  <div>
                    <div style="font-weight: 700; color: #222">Officer</div>
                    <div style="font-size: 13px; color: #666">
                      Role: Club Officer
                    </div>
                    <div style="font-size: 13px; color: #666">
                      officer@example.com
                    </div>
                  </div>
                </div>
                <div
                  style="
                    border-top: 1px solid #f0f0f0;
                    margin-top: 8px;
                    padding-top: 8px;
                    display: flex;
                    gap: 8px;
                    justify-content: space-between;
                  "
                >
                  <button class="btn btn-light" id="editProfileBtn">
                    Edit Profile
                  </button>
                  <button class="btn" id="logoutBtn">Logout</button>
                </div>
                <div
                  style="
                    margin-top: 10px;
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                  "
                >
                  <div style="display: flex; gap: 8px; align-items: center">
                    <a
                      id="emailBtn"
                      class="btn"
                      href="mailto:officer@example.com"
                      style="
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                      "
                    >
                      <span>Email</span>
                      <button
                        id="emailCopyBtn"
                        type="button"
                        title="Copy email"
                        aria-label="Copy email"
                        style="
                          border: none;
                          background: transparent;
                          padding: 4px;
                          display: inline-flex;
                          align-items: center;
                          justify-content: center;
                        "
                      >
                        <i
                          class="ri-file-copy-line"
                          style="font-size: 16px; color: inherit"
                        ></i>
                      </button>
                    </a>
                  </div>
                  <div style="display: flex; gap: 8px; align-items: center">
                    <button
                      id="changePasswordBtn"
                      class="btn btn-light"
                      style="
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        width: 100%;
                        justify-content: center;
                      "
                    >
                      <i class="fas fa-key" style="font-size: 12px"></i>
                      <span>Change Password</span>
                    </button>
                  </div>
                  <div style="display: flex; gap: 8px; align-items: center">
                    <label style="font-size: 13px; color: #444"
                      >Dark Mode</label
                    >
                    <input type="checkbox" id="darkModeToggle" />
                  </div>
                  <div>
                    <button class="btn btn-light" id="changePassBtn">
                      Change Password
                    </button>
                  </div>
                </div>
              </div>
              <!-- Change Password Modal (enhanced) -->
              <div
                class="modal"
                id="changePassModal"
                style="
                  display: none;
                  align-items: center;
                  justify-content: center;
                "
              >
                <div
                  class="modal-content modal-card"
                  style="max-width: 460px; width: 92%"
                >
                  <div class="modal-header">
                    <h3>Change Password</h3>
                    <button
                      class="close-btn"
                      onclick="document.getElementById('changePassModal').style.display='none'"
                    >
                      ✖
                    </button>
                  </div>
                  <div class="modal-body">
                    <form id="changePassForm">
                      <div class="form-group">
                        <label for="cp-old">Current Password</label>
                        <div class="input-with-action">
                          <input id="cp-old" type="password" required />
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="cp-new">New Password</label>
                        <div class="input-with-action">
                          <input id="cp-new" type="password" required />
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="cp-confirm">Confirm New Password</label>
                        <div class="input-with-action">
                          <input id="cp-confirm" type="password" required />
                        </div>
                      </div>
                      <div
                        class="form-group"
                        style="
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          margin-top: 6px;
                        "
                      >
                        <input type="checkbox" id="showPasswordsToggle" />
                        <label
                          for="showPasswordsToggle"
                          style="margin: 0; font-size: 13px; color: #555"
                          >Show passwords</label
                        >
                      </div>
                      <div
                        class="modal-footer"
                        style="justify-content: flex-end"
                      >
                        <button
                          type="button"
                          class="btn btn-light"
                          onclick="document.getElementById('changePassModal').style.display='none'"
                        >
                          Cancel
                        </button>
                        <button type="submit" class="btn">Change</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              <!-- Edit Profile Modal (enhanced) -->
              <div
                class="modal"
                id="editProfileModal"
                style="
                  display: none;
                  align-items: center;
                  justify-content: center;
                "
              >
                <div
                  class="modal-content modal-card"
                  style="max-width: 620px; width: 94%"
                >
                  <div class="modal-header">
                    <h3>Edit Profile</h3>
                    <button
                      class="close-btn"
                      onclick="document.getElementById('editProfileModal').style.display='none'"
                    >
                      ✖
                    </button>
                  </div>
                  <div
                    class="modal-body"
                    style="
                      display: flex;
                      gap: 18px;
                      flex-direction: row;
                      align-items: flex-start;
                    "
                  >
                    <div
                      style="
                        min-width: 140px;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        align-items: center;
                      "
                    >
                      <div
                        class="avatar-preview"
                        id="edit-avatar-display"
                        style="
                          width: 120px;
                          height: 120px;
                          border-radius: 12px;
                          overflow: hidden;
                          background: #f3f3f3;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                      >
                        <img
                          src="https://i.pravatar.cc/128?u=officer"
                          alt="avatar"
                          id="editAvatarImg"
                          style="width: 100%; height: 100%; object-fit: cover"
                        />
                      </div>
                      <input
                        type="file"
                        id="ep-avatar-file"
                        accept="image/*"
                        style="display: none"
                      />
                      <button
                        type="button"
                        class="btn btn-light"
                        id="uploadAvatarBtn"
                        onclick="document.getElementById('ep-avatar-file').click()"
                      >
                        Upload Avatar
                      </button>
                      <small class="muted">Square images work best</small>
                    </div>
                    <div style="flex: 1">
                      <form id="editProfileForm">
                        <div class="form-group">
                          <label for="ep-name">Name</label>
                          <input id="ep-name" type="text" required />
                        </div>
                        <div class="form-group">
                          <label for="ep-role">Role</label>
                          <input id="ep-role" type="text" />
                        </div>
                        <div class="form-group">
                          <label for="ep-email">Email</label>
                          <input id="ep-email" type="email" />
                        </div>
                        <div
                          class="modal-footer"
                          style="
                            display: flex;
                            gap: 8px;
                            justify-content: flex-end;
                            margin-top: 8px;
                          "
                        >
                          <button
                            type="button"
                            class="btn btn-light"
                            onclick="closeEditProfileModal()"
                          >
                            Cancel
                          </button>
                          <button type="submit" class="btn">Save</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card-grid" id="cardGrid">
            <div class="card">
              <h3>Pending Memberships</h3>
              <p id="membershipText">3 new applications awaiting approval.</p>
              <button class="btn" onclick="openMembershipModal()">
                Review
              </button>
            </div>
            <!-- Calendar Card -->
            <div class="card">
              <h3>Events Calendar</h3>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 8px;
                  margin-bottom: 8px;
                "
              >
                <small id="pendingEventsHint" style="color: #666"></small>
                <button
                  class="btn btn-light"
                  id="openCreateEventBtn"
                  title="Create an event and submit for admin approval"
                  style="margin-top: 0"
                >
                  Create Event
                </button>
              </div>
              <div id="calendar"></div>
            </div>
            <div class="card">
              <h3>Analytics</h3>
              <canvas id="analyticsChart"></canvas>
              <button class="btn" onclick="refreshChart()">Refresh Data</button>
            </div>
            <div class="card">
              <h3>Communication</h3>
              <p id="commStatus">Post announcements or event reminders.</p>
              <button class="btn" onclick="createPost()">Create Post</button>
              <ul id="postList"></ul>
            </div>
          </div>

          <div id="analyticsSection" style="display: none; margin-top: 30px">
            <div
              style="
                max-width: 900px;
                margin: auto;
                background: #fff;
                border-radius: 18px;
                box-shadow: 0 4px 32px rgba(142, 14, 0, 0.08);
                padding: 36px 32px 32px 32px;
                border: 1px solid #e5e7eb;
              "
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 24px;
                "
              >
                <h2 style="color: #8e0e00; font-size: 2rem; margin: 0">
                  Analytics Overview
                </h2>
                <span
                  style="
                    background: #8e0e00;
                    color: #fff;
                    font-weight: 600;
                    border-radius: 8px;
                    padding: 8px 18px;
                    font-size: 1.1rem;
                    box-shadow: 0 2px 8px rgba(142, 14, 0, 0.08);
                  "
                  >2024-2025</span
                >
              </div>
              <div
                style="
                  display: flex;
                  gap: 32px;
                  flex-wrap: wrap;
                  margin-bottom: 32px;
                "
              >
                <div
                  style="
                    flex: 1;
                    min-width: 180px;
                    background: #fff3f1;
                    border-radius: 12px;
                    padding: 18px 22px;
                    box-shadow: 0 2px 12px rgba(142, 14, 0, 0.04);
                  "
                >
                  <div
                    style="font-size: 15px; color: #8e0e00; font-weight: 600"
                  >
                    Highest Attendance
                  </div>
                  <div style="font-size: 2rem; color: #222; font-weight: 700">
                    April <span style="color: #8e0e00">95%</span>
                  </div>
                </div>
                <div
                  style="
                    flex: 1;
                    min-width: 180px;
                    background: #f7f7f7;
                    border-radius: 12px;
                    padding: 18px 22px;
                    box-shadow: 0 2px 12px rgba(142, 14, 0, 0.04);
                  "
                >
                  <div
                    style="font-size: 15px; color: #8e0e00; font-weight: 600"
                  >
                    Lowest Attendance
                  </div>
                  <div style="font-size: 2rem; color: #222; font-weight: 700">
                    March <span style="color: #e74c3c">80%</span>
                  </div>
                </div>
                <div
                  style="
                    flex: 1;
                    min-width: 180px;
                    background: #f7f7f7;
                    border-radius: 12px;
                    padding: 18px 22px;
                    box-shadow: 0 2px 12px rgba(142, 14, 0, 0.04);
                  "
                >
                  <div
                    style="font-size: 15px; color: #8e0e00; font-weight: 600"
                  >
                    Average Attendance
                  </div>
                  <div style="font-size: 2rem; color: #222; font-weight: 700">
                    87.6%
                  </div>
                </div>
              </div>
              <div style="margin-bottom: 32px">
                <canvas
                  id="analyticsInlineChart"
                  style="
                    width: 100%;
                    height: 320px;
                    background: #fff;
                    border-radius: 12px;
                    box-shadow: 0 2px 12px rgba(142, 14, 0, 0.04);
                  "
                ></canvas>
              </div>
              <div style="margin-top: 12px">
                <h3 style="color: #8e0e00; margin-bottom: 12px">
                  Attendance Records
                </h3>
                <table
                  style="
                    width: 100%;
                    font-size: 15px;
                    border-collapse: collapse;
                    background: #fff;
                    border-radius: 10px;
                    box-shadow: 0 1px 6px rgba(142, 14, 0, 0.03);
                    overflow: hidden;
                  "
                >
                  <thead style="background: #8e0e00; color: #fff">
                    <tr>
                      <th style="padding: 12px 0">Month</th>
                      <th style="padding: 12px 0">Attendance %</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="padding: 10px 0">Jan</td>
                      <td style="padding: 10px 0">90%</td>
                    </tr>
                    <tr>
                      <td style="padding: 10px 0">Feb</td>
                      <td style="padding: 10px 0">85%</td>
                    </tr>
                    <tr>
                      <td style="padding: 10px 0">Mar</td>
                      <td style="padding: 10px 0">80%</td>
                    </tr>
                    <tr>
                      <td style="padding: 10px 0">Apr</td>
                      <td style="padding: 10px 0">95%</td>
                    </tr>
                    <tr>
                      <td style="padding: 10px 0">May</td>
                      <td style="padding: 10px 0">88%</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="clubRecordsSection" style="display: none; margin-top: 30px">
            <div
              style="
                max-width: 1100px;
                margin: auto;
                background: #fff;
                border-radius: 18px;
                box-shadow: 0 4px 32px rgba(142, 14, 0, 0.08);
                padding: 36px 32px 32px 32px;
                border: 1px solid #e5e7eb;
              "
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 24px;
                "
              >
                <h2 style="color: #8e0e00; font-size: 2rem; margin: 0">
                  Club Records
                </h2>
                <span
                  style="
                    background: #8e0e00;
                    color: #fff;
                    font-weight: 600;
                    border-radius: 8px;
                    padding: 8px 18px;
                    font-size: 1.1rem;
                    box-shadow: 0 2px 8px rgba(142, 14, 0, 0.08);
                  "
                  >2024-2025</span
                >
              </div>
              <div
                id="clubRecordsInlineContent"
                style="overflow-x: auto; max-width: 100%; white-space: nowrap"
              >
                <table
                  style="
                    min-width: 900px;
                    width: 100%;
                    font-size: 15px;
                    border-collapse: collapse;
                    margin-top: 12px;
                    table-layout: auto;
                    word-break: break-word;
                    background: #fff;
                    border-radius: 12px;
                    box-shadow: 0 1px 12px rgba(142, 14, 0, 0.06);
                    overflow: hidden;
                  "
                >
                  <thead style="background: #8e0e00; color: #fff">
                    <tr>
                      <th
                        style="
                          min-width: 50px;
                          padding: 14px 0;
                          text-align: center;
                        "
                      >
                        Logo
                      </th>
                      <th style="min-width: 90px; padding: 14px 0">
                        Club Name
                      </th>
                      <th style="min-width: 120px; padding: 14px 0">
                        Description
                      </th>
                      <th style="min-width: 60px; padding: 14px 0">Members</th>
                      <th style="min-width: 90px; padding: 14px 0">Advisor</th>
                      <th style="min-width: 90px; padding: 14px 0">
                        President
                      </th>
                      <th style="min-width: 60px; padding: 14px 0">Status</th>
                      <th style="min-width: 120px; padding: 14px 0">Meeting</th>
                    </tr>
                  </thead>
                  <tbody id="clubRecordsInlineTableBody">
                    <!-- Populated by JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div
            id="communicationSection"
            style="display: none; margin-top: 30px"
          >
            <div
              style="
                max-width: 900px;
                margin: auto;
                background: #fff;
                border-radius: 18px;
                box-shadow: 0 4px 32px rgba(142, 14, 0, 0.08);
                padding: 36px 32px 32px 32px;
                border: 1px solid #e5e7eb;
              "
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 24px;
                "
              >
                <h2 style="color: #8e0e00; font-size: 2rem; margin: 0">
                  Communication Center
                </h2>
                <span
                  style="
                    background: #8e0e00;
                    color: #fff;
                    font-weight: 600;
                    border-radius: 8px;
                    padding: 8px 18px;
                    font-size: 1.1rem;
                    box-shadow: 0 2px 8px rgba(142, 14, 0, 0.08);
                  "
                  >2024-2025</span
                >
              </div>
              <div
                style="
                  margin-bottom: 24px;
                  color: #444;
                  font-size: 13px;
                  background: linear-gradient(90deg, #fff3f1 80%, #ffe5e0 100%);
                  border-radius: 14px;
                  padding: 18px 22px 18px 22px;
                  box-shadow: 0 2px 12px rgba(142, 14, 0, 0.04);
                  display: flex;
                  align-items: flex-start;
                  gap: 18px;
                "
              >
                <div
                  style="
                    flex-shrink: 0;
                    width: 38px;
                    height: 38px;
                    background: #8e0e00;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 2px 8px rgba(142, 14, 0, 0.08);
                    margin-top: 2px;
                  "
                >
                  <i
                    class="ri-lightbulb-flash-line"
                    style="color: #fff; font-size: 22px"
                  ></i>
                </div>
                <div>
                  <strong style="color: #8e0e00; font-size: 15px"
                    >Guidelines</strong
                  >
                  <ul
                    style="margin-left: 18px; margin-top: 8px; padding-left: 0"
                  >
                    <li style="margin-bottom: 4px">
                      Use clear and concise language for announcements.
                    </li>
                    <li style="margin-bottom: 4px">
                      Include event dates, times, and locations when relevant.
                    </li>
                    <li style="margin-bottom: 4px">
                      Keep posts respectful and relevant to club activities.
                    </li>
                    <li style="margin-bottom: 4px">
                      Check recent posts before posting to avoid duplicates.
                    </li>
                  </ul>
                </div>
              </div>
              <div
                style="
                  background: #fafbfc;
                  border: 1px solid #e5e7eb;
                  border-radius: 12px;
                  padding: 24px 22px;
                  margin-bottom: 24px;
                  box-shadow: 0 2px 12px rgba(142, 14, 0, 0.04);
                "
              >
                <h3 style="color: #8e0e00; margin-top: 0; margin-bottom: 18px">
                  Recent Announcements
                </h3>
                <ul
                  id="communicationInlinePostList"
                  style="margin-bottom: 0"
                ></ul>
                <div
                  id="noPostsMsg"
                  style="
                    color: #aaa;
                    font-size: 15px;
                    margin-top: 8px;
                    display: none;
                  "
                >
                  No announcements yet.
                </div>
              </div>
              <form
                id="inlinePostForm"
                style="
                  margin-top: 18px;
                  background: #fff;
                  border: 1px solid #e5e7eb;
                  border-radius: 12px;
                  padding: 24px 22px;
                  box-shadow: 0 2px 12px rgba(142, 14, 0, 0.04);
                "
              >
                <h3 style="color: #8e0e00; margin-top: 0; margin-bottom: 18px">
                  Create Announcement / Post
                </h3>
                <div class="form-group" style="margin-bottom: 16px">
                  <label
                    for="inlinePostTitle"
                    style="font-weight: 600; color: #8e0e00"
                    >Title</label
                  >
                  <input
                    type="text"
                    id="inlinePostTitle"
                    placeholder="Enter post title"
                    required
                    style="
                      width: 100%;
                      padding: 10px;
                      margin-top: 6px;
                      border-radius: 8px;
                      border: 1px solid #e5e7eb;
                      font-size: 16px;
                    "
                  />
                </div>
                <div class="form-group" style="margin-bottom: 16px">
                  <label
                    for="inlinePostMessage"
                    style="font-weight: 600; color: #8e0e00"
                    >Message</label
                  >
                  <textarea
                    id="inlinePostMessage"
                    rows="4"
                    placeholder="Write your announcement here..."
                    required
                    style="
                      width: 100%;
                      padding: 10px;
                      margin-top: 6px;
                      border-radius: 8px;
                      border: 1px solid #e5e7eb;
                      font-size: 16px;
                    "
                  ></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 16px">
                  <label
                    for="inlinePostAudience"
                    style="font-weight: 600; color: #8e0e00"
                    >Audience</label
                  >
                  <select
                    id="inlinePostAudience"
                    required
                    style="
                      width: 100%;
                      padding: 10px;
                      margin-top: 6px;
                      border-radius: 8px;
                      border: 1px solid #e5e7eb;
                      font-size: 16px;
                    "
                  >
                    <option value="">-- Select Audience --</option>
                    <option value="all">All Members</option>
                    <option value="officers">Officers Only</option>
                    <option value="applicants">Applicants</option>
                  </select>
                </div>
                <button
                  type="submit"
                  class="btn"
                  style="
                    margin-top: 12px;
                    font-size: 16px;
                    padding: 10px 24px;
                    border-radius: 8px;
                  "
                >
                  Post Announcement
                </button>
              </form>
              <div style="font-size: 15px; color: #666; margin-top: 18px">
                <strong>Tip:</strong> Use the form above to share news,
                reminders, or updates with your club. All posts will appear
                above for easy reference.
              </div>
            </div>
          </div>

          <div id="officerRolesSection" style="display: none; margin-top: 30px">
            <div
              style="
                max-width: 900px;
                margin: auto;
                background: #fff;
                border-radius: 18px;
                box-shadow: 0 4px 32px rgba(142, 14, 0, 0.08);
                padding: 36px 32px 32px 32px;
                border: 1px solid #e5e7eb;
              "
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 24px;
                "
              >
                <h2 style="color: #8e0e00; font-size: 2rem; margin: 0">
                  Officer Roles
                </h2>
                <span
                  style="
                    background: #8e0e00;
                    color: #fff;
                    font-weight: 600;
                    border-radius: 8px;
                    padding: 8px 18px;
                    font-size: 1.1rem;
                    box-shadow: 0 2px 8px rgba(142, 14, 0, 0.08);
                  "
                  >2024-2025</span
                >
              </div>
              <div
                style="overflow-x: auto; max-width: 100%; white-space: nowrap"
              >
                <table
                  style="
                    min-width: 900px;
                    width: 100%;
                    font-size: 15px;
                    border-collapse: collapse;
                    margin-top: 12px;
                    table-layout: auto;
                    word-break: break-word;
                    background: #fff;
                    border-radius: 12px;
                    box-shadow: 0 1px 12px rgba(142, 14, 0, 0.06);
                    overflow: hidden;
                  "
                >
                  <thead style="background: #8e0e00; color: #fff">
                    <tr>
                      <th style="min-width: 90px; padding: 14px 0">Position</th>
                      <th style="min-width: 90px; padding: 14px 0">Officer</th>
                      <th style="min-width: 120px; padding: 14px 0">Contact</th>
                      <th style="min-width: 60px; padding: 14px 0">Photo</th>
                      <th style="min-width: 70px; padding: 14px 0">Term</th>
                      <th style="min-width: 60px; padding: 14px 0">Status</th>
                      <th style="min-width: 160px; padding: 14px 0">
                        Responsibilities
                      </th>
                    </tr>
                  </thead>
                  <tbody id="officerRolesInlineTableBody">
                    <!-- Populated by JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div
            id="requirementsActivitiesSection"
            style="display: none !important; margin-top: 30px"
          >
            <div
              style="
                max-width: 700px;
                margin: auto;
                background: #fff;
                border-radius: 18px;
                box-shadow: 0 4px 32px rgba(142, 14, 0, 0.08);
                padding: 36px 32px 32px 32px;
                border: 1px solid #e5e7eb;
              "
            >
              <h2 style="color: #8e0e00; font-size: 2rem; margin-bottom: 18px">
                Requirments
              </h2>
              <form
                id="requirementsActivitiesChecklist"
                class="checklist-small-text"
                style="
                  color: #333;
                  line-height: 2;
                  padding-left: 12px;
                  font-size: 5px;
                "
              >
                <div class="checklist-grid">
                  <div class="checklist-box">
                    <span class="checklist-label-small"
                      >Approved Activity Proposal</span
                    >
                  </div>
                  <div class="checklist-box">
                    <span class="checklist-label-small"
                      >Narrative Report in paragraph</span
                    >
                  </div>
                  <div class="checklist-box">
                    <span class="checklist-label-small"
                      >Documentation (Pictures)</span
                    >
                  </div>
                  <div class="checklist-box">
                    <span class="checklist-label-small">Evaluation Report</span>
                  </div>
                  <div class="checklist-box">
                    <span class="checklist-label-small"
                      >Minutes of Meetings</span
                    >
                  </div>
                  <div class="checklist-box">
                    <span class="checklist-label-small"
                      >Liquidation with OR's</span
                    >
                  </div>
                  <div class="checklist-box">
                    <span class="checklist-label-small"
                      >Financial Due Diligence</span
                    >
                  </div>
                  <div class="checklist-box">
                    <span class="checklist-label-small"
                      >Due Diligence Requirements</span
                    >
                  </div>
                  <div class="checklist-box">
                    <span class="checklist-label-small">Attendance Sheets</span>
                  </div>
                  <div class="checklist-box">
                    <span class="checklist-label-small"
                      >SRFOnline Reference__</span
                    >
                  </div>
                  <!-- Modal for uploading requirement per checklist -->
                  <div
                    id="requirementUploadModal"
                    class="modal"
                    style="display: none"
                  >
                    <div class="modal-content" style="max-width: 400px">
                      <span
                        class="close-btn"
                        id="closeRequirementUploadModal"
                        style="float: right; cursor: pointer; font-size: 22px"
                        >✖</span
                      >
                      <h3 id="requirementUploadTitle" style="font-size: large">
                        Upload Requirement
                      </h3>
                      <input
                        type="file"
                        id="requirementFileInput"
                        multiple
                        accept="image/*,.pdf,.doc,.docx"
                      />
                      <div id="requirementFilePreview"></div>
                      <div
                        id="requirementUploadedFilesModal"
                        style="margin-top: 12px"
                      ></div>
                      <button
                        id="requirementUploadBtn"
                        type="button"
                        class="btn"
                        style="margin-top: 16px"
                      >
                        Upload
                      </button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
          <!-- Confirmation Modal -->
          <!-- File preview modal -->
          <div
            id="filePreviewModal"
            class="modal"
            style="display: none; z-index: 9999"
          >
            <div
              class="modal-content"
              style="
                max-width: 1200px;
                width: 96vw;
                max-height: 96vh;
                min-height: 400px;
                min-width: 320px;
                padding: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
              "
            >
              <span
                class="close-btn"
                id="closeFilePreviewModal"
                style="
                  float: right;
                  cursor: pointer;
                  font-size: 22px;
                  align-self: flex-end;
                  margin: 8px 12px 0 0;
                "
                >✖</span
              >
              <div
                id="filePreviewContent"
                style="
                  width: 100%;
                  height: 100%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              ></div>
            </div>
          </div>
          <!-- docx-preview library for Word file preview -->
          <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.6.5/dist/docx-preview.min.js"></script>
          <div
            id="requirementsUploadConfirmModal"
            class="modal"
            style="display: none"
          >
            <div class="modal-content">
              <span
                class="close-btn"
                onclick="document.getElementById('requirementsUploadConfirmModal').style.display='none'"
                >✖</span
              >
              <h3>Confirm Upload</h3>
              <p>Are you sure you want to upload/save these requirements?</p>
              <button
                id="confirmUploadBtn"
                class="btn"
                style="margin-right: 12px"
              >
                Confirm
              </button>
              <button id="cancelUploadBtn" class="btn btn-light">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Modal for Membership Approval -->
        <div class="modal" id="membershipModal">
          <div class="modal-content">
            <span class="close-btn" onclick="closeMembershipModal()">✖</span>
            <h3>Membership Approvals</h3>

            <div class="member-toolbar">
              <div class="member-left">
                <label class="visually-hidden" for="memberSearch"
                  >Search applicant</label
                >
                <input
                  id="memberSearch"
                  type="text"
                  placeholder="Search by name or club..."
                />
              </div>
              <div class="member-right">
                <span class="pill"
                  >Pending: <strong id="pendingCount">3</strong></span
                >
                <span class="pill green"
                  >Approved: <strong id="approvedCountTop">0</strong></span
                >
                <span class="pill red"
                  >Rejected: <strong id="rejectedCountTop">0</strong></span
                >
              </div>
            </div>

            <div class="member-tabs">
              <button class="tab-btn active" data-tab="pendingTab">
                Pending
              </button>
              <button class="tab-btn" data-tab="approvedTab">Approved</button>
              <button class="tab-btn" data-tab="rejectedTab">Rejected</button>
            </div>

            <div class="approval-sections">
              <!-- Pending List -->
              <div class="tab-pane" id="pendingTab">
                <div class="approval-card">
                  <h4>
                    Pending Applications (<span id="pendingCountHeader">3</span
                    >)
                  </h4>
                  <div class="table-wrap">
                    <table id="pendingTable">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Applying For</th>
                          <th>Current Clubs</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr data-clubs="2">
                          <td>Juan Dela Cruz</td>
                          <td>Math Club</td>
                          <td><span class="badge">2</span></td>
                          <td>
                            <button
                              class="approve"
                              onclick="approveStudent(this)"
                            >
                              <i class="ri-check-line"></i> Approve
                            </button>
                            <button
                              class="reject"
                              onclick="rejectStudent(this)"
                            >
                              <i class="ri-close-line"></i> Reject
                            </button>
                          </td>
                        </tr>
                        <tr data-clubs="1">
                          <td>Maria Santos</td>
                          <td>Physics Club</td>
                          <td><span class="badge">1</span></td>
                          <td>
                            <button
                              class="approve"
                              onclick="approveStudent(this)"
                            >
                              <i class="ri-check-line"></i> Approve
                            </button>
                            <button
                              class="reject"
                              onclick="rejectStudent(this)"
                            >
                              <i class="ri-close-line"></i> Reject
                            </button>
                          </td>
                        </tr>
                        <tr data-clubs="3">
                          <td>Carlos Reyes</td>
                          <td>Science & Math Club</td>
                          <td><span class="badge">3</span></td>
                          <td>
                            <button
                              class="approve"
                              onclick="approveStudent(this)"
                            >
                              <i class="ri-check-line"></i> Approve
                            </button>
                            <button
                              class="reject"
                              onclick="rejectStudent(this)"
                            >
                              <i class="ri-close-line"></i> Reject
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Approved List -->
              <div class="tab-pane" id="approvedTab" style="display: none">
                <div class="approval-card approved">
                  <h4>Approved Members (<span id="approvedCount">0</span>)</h4>
                  <div class="table-wrap">
                    <table id="approvedTable">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Club</th>
                          <th>Current Clubs</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Rejected List -->
              <div class="tab-pane" id="rejectedTab" style="display: none">
                <div class="approval-card rejected">
                  <h4>Rejected Members (<span id="rejectedCount">0</span>)</h4>
                  <div class="table-wrap">
                    <table id="rejectedTable">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Club</th>
                          <th>Current Clubs</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal for Attendance Management -->
        <div class="modal" id="attendanceModal">
          <div class="modal-content">
            <span class="close-btn" onclick="closeAttendanceModal()">✖</span>
            <h3>Attendance Management – General Assembly</h3>

            <div id="attendanceSummary">
              Present: <span id="presentCount">0</span> | Absent:
              <span id="absentCount">0</span>
            </div>

            <div class="attn-toolbar">
              <div class="attn-left">
                <label class="visually-hidden" for="attnSearch"
                  >Search attendee</label
                >
                <input
                  id="attnSearch"
                  type="text"
                  placeholder="Search attendee..."
                />
                <label class="visually-hidden" for="attnFilter"
                  >Filter status</label
                >
                <select id="attnFilter">
                  <option value="all">All</option>
                  <option value="present">Present</option>
                  <option value="absent">Absent</option>
                  <option value="not_marked">Not Marked</option>
                </select>
              </div>
              <div class="attn-right">
                <button
                  id="attnExport"
                  class="btn btn-light"
                  type="button"
                  aria-label="Export attendance to CSV"
                >
                  <i class="ri-download-2-line"></i> Export
                </button>
              </div>
            </div>

            <div class="table-wrap">
              <table id="attendanceTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Juan Dela Cruz</td>
                    <td class="status">Not Marked</td>
                    <td>
                      <button class="approve" onclick="markPresent(this)">
                        <i class="ri-checkbox-circle-line"></i> Present
                      </button>
                      <button class="reject" onclick="markAbsent(this)">
                        <i class="ri-close-circle-line"></i> Absent
                      </button>
                    </td>
                  </tr>
                  <tr>
                    <td>Maria Santos</td>
                    <td class="status">Not Marked</td>
                    <td>
                      <button class="approve" onclick="markPresent(this)">
                        <i class="ri-checkbox-circle-line"></i> Present
                      </button>
                      <button class="reject" onclick="markAbsent(this)">
                        <i class="ri-close-circle-line"></i> Absent
                      </button>
                    </td>
                  </tr>
                  <tr>
                    <td>Carlos Reyes</td>
                    <td class="status">Not Marked</td>
                    <td>
                      <button class="approve" onclick="markPresent(this)">
                        <i class="ri-checkbox-circle-line"></i> Present
                      </button>
                      <button class="reject" onclick="markAbsent(this)">
                        <i class="ri-close-circle-line"></i> Absent
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Modal for Create Post -->
        <div class="modal" id="postModal">
          <div class="modal-content">
            <span
              class="close"
              onclick="document.getElementById('postModal').style.display='none'"
              >&times;</span
            >
            <h3>Create Announcement / Post</h3>

            <form id="postForm">
              <div class="form-group">
                <label for="postTitle">Title</label>
                <input
                  type="text"
                  id="postTitle"
                  placeholder="Enter post title"
                  required
                />
              </div>

              <div class="form-group">
                <label for="postMessage">Message</label>
                <textarea
                  id="postMessage"
                  rows="5"
                  placeholder="Write your announcement here..."
                  required
                ></textarea>
              </div>

              <div class="form-group">
                <label for="postAudience">Audience</label>
                <select id="postAudience" required>
                  <option value="">-- Select Audience --</option>
                  <option value="all">All Members</option>
                  <option value="officers">Officers Only</option>
                  <option value="applicants">Applicants</option>
                </select>
              </div>

              <button type="submit" class="btn">Post Announcement</button>
            </form>
          </div>
        </div>

        <script>
          // Sidebar toggle
          const sidebar = document.getElementById("sidebar");
          const menuToggle = document.getElementById("menuToggle");
          menuToggle.addEventListener("click", () => {
            sidebar.classList.toggle("collapsed");
            menuToggle.classList.toggle("active");
            // Toggle wide-cards class on card grid for wider dashboard cards
            const cardGrid = document.getElementById("cardGrid");
            if (sidebar.classList.contains("collapsed")) {
              cardGrid.classList.add("wide-cards");
            } else {
              cardGrid.classList.remove("wide-cards");
            }
          });

          // Membership Modal
          // Communication Inline Section
          const communicationSection = document.getElementById(
            "communicationSection"
          );
          const communicationInlinePostList = document.getElementById(
            "communicationInlinePostList"
          );
          const inlinePostForm = document.getElementById("inlinePostForm");
          // Sidebar Communication click
          document
            .getElementById("sidebarCommunication")
            .addEventListener("click", function (e) {
              e.preventDefault();
              document.getElementById("cardGrid").style.display = "none";
              document.getElementById("analyticsSection").style.display =
                "none";
              officerRolesSection.style.display = "none";
              communicationSection.style.display = "block";
              renderCommunicationInlinePosts();
            });
          function renderCommunicationInlinePosts() {
            if (!communicationInlinePostList) return;
            communicationInlinePostList.innerHTML = "";
            // Also update dashboard card post list
            if (postList) postList.innerHTML = "";
            if (communicationPosts.length === 0) {
              document.getElementById("noPostsMsg").style.display = "block";
            } else {
              document.getElementById("noPostsMsg").style.display = "none";
              communicationPosts.forEach((post, idx) => {
                const li = document.createElement("li");
                li.classList.add("post-item");
                li.style.marginBottom = "12px";
                li.style.padding = "10px 14px";
                li.style.background = "#fff";
                li.style.border = "1px solid #e5e7eb";
                li.style.borderRadius = "8px";
                li.innerHTML = `
              <div style="word-break:break-word; max-width:100%; white-space:pre-line;">
                <strong style="color:#8e0e00;">${post.title}</strong> <span style="font-size:13px; color:#888;">(${post.audience})</span><br>
                <span class="post-item-message" style="font-size:15px; color:#333;">${post.message}</span>
              </div>
              <button class="delete-post" title="Remove post" style="float:right; margin-top:4px; background:none; border:none; color:#e74c3c; cursor:pointer;"><i class='ri-close-line' style='font-size:18px; vertical-align:middle;'></i></button>
            `;
                li.querySelector(".delete-post").addEventListener(
                  "click",
                  () => {
                    if (confirm("Are you sure you want to delete this post?")) {
                      communicationPosts.splice(idx, 1);
                      renderCommunicationInlinePosts();
                    }
                  }
                );
                communicationInlinePostList.appendChild(li);
                // Also add to dashboard card
                if (postList) {
                  const dashLi = document.createElement("li");
                  dashLi.classList.add("post-item");
                  dashLi.style.marginBottom = "8px";
                  dashLi.style.wordBreak = "break-word";
                  dashLi.style.whiteSpace = "pre-line";
                  dashLi.style.maxWidth = "100%";
                  dashLi.innerHTML = `<div style='display:block; word-break:break-word; white-space:pre-line; max-width:100%;'>
                <strong style='color:#8e0e00;'>${post.title}</strong>: <span style='font-size:14px; color:#333;'>${post.message}</span> <span style='font-size:12px; color:#888;'>(${post.audience})</span>
              </div>`;
                  postList.appendChild(dashLi);
                }
              });
            }
          }

          // ...existing code... (notification handlers consolidated earlier)
          // Officer Roles Inline Section
          const officerRolesInlineTableBody = document.getElementById(
            "officerRolesInlineTableBody"
          );
          const officerRolesSection = document.getElementById(
            "officerRolesSection"
          );
          // Example officer roles data
          const officerRoles = [
            {
              position: "President",
              officer: "Juan Dela Cruz",
              contact: "juan.delacruz@email.com",
              photo: "https://i.pravatar.cc/50?u=juan",
              term: "2024-2025",
              status: "Active",
              responsibilities:
                "Oversees all club activities, leads meetings, represents the club.",
            },
            {
              position: "Vice President",
              officer: "Maria Santos",
              contact: "maria.santos@email.com",
              photo: "https://i.pravatar.cc/50?u=maria",
              term: "2024-2025",
              status: "Active",
              responsibilities:
                "Assists the president, manages club operations, steps in when president is absent.",
            },
            {
              position: "Secretary",
              officer: "Carlos Reyes",
              contact: "carlos.reyes@email.com",
              photo: "https://i.pravatar.cc/50?u=carlos",
              term: "2024-2025",
              status: "Active",
              responsibilities:
                "Keeps minutes, manages club records, handles correspondence.",
            },
            {
              position: "Treasurer",
              officer: "Anna Lim",
              contact: "anna.lim@email.com",
              photo: "https://i.pravatar.cc/50?u=anna",
              term: "2024-2025",
              status: "Active",
              responsibilities:
                "Manages finances, prepares budgets, oversees fundraising.",
            },
            {
              position: "Auditor",
              officer: "Mark Tan",
              contact: "mark.tan@email.com",
              photo: "https://i.pravatar.cc/50?u=mark",
              term: "2024-2025",
              status: "Active",
              responsibilities:
                "Reviews financial records, ensures transparency and accuracy.",
            },
            {
              position: "PRO (Public Relations Officer)",
              officer: "Liza Cruz",
              contact: "liza.cruz@email.com",
              photo: "https://i.pravatar.cc/50?u=liza",
              term: "2024-2025",
              status: "Active",
              responsibilities:
                "Promotes club events, manages social media, communicates with members.",
            },
            {
              position: "Committee Head",
              officer: "Rico Gomez",
              contact: "rico.gomez@email.com",
              photo: "https://i.pravatar.cc/50?u=rico",
              term: "2024-2025",
              status: "Active",
              responsibilities:
                "Leads specific committees, organizes events and activities.",
            },
            {
              position: "Member",
              officer: "Various Members",
              contact: "-",
              photo: "https://i.pravatar.cc/50?u=member",
              term: "2024-2025",
              status: "Active",
              responsibilities:
                "Participates in club activities, supports club goals.",
            },
            {
              position: "Vacant Position",
              officer: "-",
              contact: "-",
              photo: "https://i.pravatar.cc/50?u=vacant",
              term: "-",
              status: "Vacant",
              responsibilities: "Open for applicants.",
            },
          ];
          function renderOfficerRolesInline() {
            if (!officerRolesInlineTableBody) return;
            officerRolesInlineTableBody.innerHTML = "";
            officerRoles.forEach((role) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
            <td>${role.position}</td>
            <td>${role.officer}</td>
            <td>${role.contact}</td>
            <td><img src="${role.photo}" alt="${
                role.officer
              }" style="width:32px;height:32px;border-radius:50%;"></td>
            <td>${role.term}</td>
            <td><span style="color:${
              role.status === "Active" ? "#2ecc40" : "#e74c3c"
            };font-weight:600;">${role.status}</span></td>
            <td>${role.responsibilities}</td>
          `;
              officerRolesInlineTableBody.appendChild(tr);
            });
          }
          // Sidebar Officer Roles click
          document
            .getElementById("sidebarOfficerRoles")
            .addEventListener("click", function (e) {
              e.preventDefault();
              document.getElementById("cardGrid").style.display = "none";
              document.getElementById("analyticsSection").style.display =
                "none";
              communicationSection.style.display = "none";
              officerRolesSection.style.display = "block";
              renderOfficerRolesInline();
            });
          // Dashboard button click restores dashboard view
          document
            .querySelector(".sidebar .active")
            .addEventListener("click", function (e) {
              e.preventDefault();
              document.getElementById("cardGrid").style.display = "grid";
              document.getElementById("analyticsSection").style.display =
                "none";
              officerRolesSection.style.display = "none";
              // Hide requirements/activities section when dashboard is shown
              let reqActSection = document.getElementById(
                "requirementsActivitiesSection"
              );
              if (reqActSection) reqActSection.style.display = "none";
              let attendanceInlineSection = document.getElementById(
                "attendanceInlineSection"
              );
              if (attendanceInlineSection)
                attendanceInlineSection.style.display = "none";
              // Hide membership approval inline section when dashboard is shown
              let membershipInlineSection = document.getElementById(
                "membershipInlineSection"
              );
              if (membershipInlineSection)
                membershipInlineSection.style.display = "none";
            });
          // Analytics Modal
          const analyticsModal = document.getElementById("analyticsModal");
          function openAnalyticsModal() {
            analyticsModal.style.display = "flex";
            document.querySelector(".main").style.display = "none";
            // Render chart in modal
            setTimeout(() => {
              if (window.analyticsModalChartInstance) return;
              const ctx = document
                .getElementById("analyticsModalChart")
                .getContext("2d");
              window.analyticsModalChartInstance = new Chart(ctx, {
                type: "bar",
                data: {
                  labels: ["Jan", "Feb", "Mar", "Apr", "May"],
                  datasets: [
                    {
                      label: "Attendance %",
                      data: [90, 85, 80, 95, 88],
                      backgroundColor: "#8e0e00",
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                    y: { beginAtZero: true, max: 100 },
                  },
                },
              });
            }, 100);
          }
          function closeAnalyticsModal() {
            analyticsModal.style.display = "none";
            document.querySelector(".main").style.display = "";
          }
          // Sidebar Analytics click
          document
            .querySelector(".sidebar .active")
            .addEventListener("click", function (e) {
              e.preventDefault();
              document.getElementById("cardGrid").style.display = "grid";
              document.getElementById("analyticsSection").style.display =
                "none";
            });
          document
            .getElementById("sidebarAnalytics")
            .addEventListener("click", function (e) {
              e.preventDefault();
              document.getElementById("analyticsSection").style.display =
                "block";
              document.getElementById("cardGrid").style.display = "none";
              officerRolesSection.style.display = "none";
              communicationSection.style.display = "none";
              clubRecordsSection.style.display = "none";
              // Render chart in inline section
              setTimeout(() => {
                if (window.analyticsInlineChartInstance) return;
                const ctx = document
                  .getElementById("analyticsInlineChart")
                  .getContext("2d");
                window.analyticsInlineChartInstance = new Chart(ctx, {
                  type: "bar",
                  data: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "May"],
                    datasets: [
                      {
                        label: "Attendance %",
                        data: [90, 85, 80, 95, 88],
                        backgroundColor: "#8e0e00",
                      },
                    ],
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                      y: { beginAtZero: true, max: 100 },
                    },
                  },
                });
              }, 100);
            });
          // Club Records Inline Section
          const clubRecordsInlineTableBody = document.getElementById(
            "clubRecordsInlineTableBody"
          );
          const clubRecordsSection =
            document.getElementById("clubRecordsSection");
          // Example club records data
          const clubRecords = [
            {
              logo: "https://img.icons8.com/color/48/000000/math.png",
              name: "Math Club",
              description:
                "Promotes mathematical thinking and problem solving.",
              members: 24,
              activity: "Math Olympiad Preparation",
              advisor: "Mr. Santos",
              president: "Anna Cruz",
              founded: 2012,
              status: "Active",
              meeting: "Fridays 4pm, Room 201",
              achievements: "Won 2024 Math Olympiad",
              social: "facebook.com/mathclub",
              requirements: "Open to all, pass entrance quiz",
              events: "Math Camp Oct 2025",
            },
            {
              logo: "https://img.icons8.com/color/48/000000/physics.png",
              name: "Physics Club",
              description: "Explores physics concepts and experiments.",
              members: 18,
              activity: "Physics Quiz Bowl",
              advisor: "Ms. Reyes",
              president: "Ben Lim",
              founded: 2014,
              status: "Active",
              meeting: "Wednesdays 3pm, Lab 2",
              achievements: "2nd Place Physics Bowl 2025",
              social: "instagram.com/physicsclub",
              requirements: "Interest in science",
              events: "Physics Fair Nov 2025",
            },
            {
              logo: "https://img.icons8.com/color/48/000000/science.png",
              name: "Science & Math Club",
              description: "Combines science and math for fun projects.",
              members: 32,
              activity: "Science Fair",
              advisor: "Dr. Lim",
              president: "Carla Tan",
              founded: 2010,
              status: "Active",
              meeting: "Mondays 5pm, Room 105",
              achievements: "Best Booth Science Fair 2025",
              social: "twitter.com/sciencemathclub",
              requirements: "Application form",
              events: "STEM Expo Dec 2025",
            },
            // ...add more clubs as needed...
          ];
          function renderClubRecordsInline() {
            if (!clubRecordsInlineTableBody) return;
            clubRecordsInlineTableBody.innerHTML = "";
            clubRecords.forEach((record) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
            <td style='text-align:center;'><img src='${
              record.logo
            }' alt='logo' style='width:32px;height:32px;'></td>
            <td>${record.name}</td>
            <td style='max-width:220px; white-space:normal;'>${
              record.description
            }</td>
            <td>${record.members}</td>
            <td>${record.advisor || ""}</td>
            <td>${record.president || ""}</td>
            <td>${record.status || ""}</td>
            <td>${record.meeting || ""}</td>
          `;
              clubRecordsInlineTableBody.appendChild(tr);
            });
          }
          // Sidebar Club Records click
          document
            .getElementById("sidebarClubRecords")
            .addEventListener("click", function (e) {
              e.preventDefault();
              document.getElementById("cardGrid").style.display = "none";
              document.getElementById("analyticsSection").style.display =
                "none";
              officerRolesSection.style.display = "none";
              communicationSection.style.display = "none";
              clubRecordsSection.style.display = "block";
              renderClubRecordsInline();
            });
          // Hide Club Records when other main sections are shown
          document
            .querySelector(".sidebar .active")
            .addEventListener("click", function (e) {
              e.preventDefault();
              document.getElementById("cardGrid").style.display = "grid";
              document.getElementById("analyticsSection").style.display =
                "none";
              officerRolesSection.style.display = "none";
              communicationSection.style.display = "none";
              clubRecordsSection.style.display = "none";
            });
          document
            .getElementById("sidebarAnalytics")
            .addEventListener("click", function (e) {
              e.preventDefault();
              document.getElementById("analyticsSection").style.display =
                "block";
              document.getElementById("cardGrid").style.display = "none";
              officerRolesSection.style.display = "none";
              communicationSection.style.display = "none";
              clubRecordsSection.style.display = "none";
              // ...existing code for chart...
            });
          document
            .getElementById("sidebarOfficerRoles")
            .addEventListener("click", function (e) {
              e.preventDefault();
              document.getElementById("cardGrid").style.display = "none";
              document.getElementById("analyticsSection").style.display =
                "none";
              communicationSection.style.display = "none";
              clubRecordsSection.style.display = "none";
              officerRolesSection.style.display = "block";
              renderOfficerRolesInline();
            });
          document
            .getElementById("sidebarCommunication")
            .addEventListener("click", function (e) {
              e.preventDefault();
              const heading = document.getElementById("dashboardHeading");
              if (heading) heading.style.display = "none";
              document.getElementById("cardGrid").style.display = "none";
              document.getElementById("analyticsSection").style.display =
                "none";
              officerRolesSection.style.display = "none";
              clubRecordsSection.style.display = "none";
              communicationSection.style.display = "block";
              renderCommunicationInlinePosts();
            });
          const membershipModal = document.getElementById("membershipModal");
          function openMembershipModal() {
            membershipModal.style.display = "flex";
          }
          function closeMembershipModal() {
            membershipModal.style.display = "none";
          }
          // Sidebar Member Approvals click
          document
            .getElementById("sidebarMemberApprovals")
            .addEventListener("click", function (e) {
              e.preventDefault();
              const heading = document.getElementById("dashboardHeading");
              if (heading) heading.style.display = "none";
              // Hide all other main sections
              document.getElementById("cardGrid").style.display = "none";
              document.getElementById("analyticsSection").style.display =
                "none";
              officerRolesSection.style.display = "none";
              communicationSection.style.display = "none";
              clubRecordsSection.style.display = "none";
              let membershipInlineSection = document.getElementById(
                "membershipInlineSection"
              );
              if (!membershipInlineSection) {
                membershipInlineSection = document.createElement("div");
                membershipInlineSection.id = "membershipInlineSection";
                membershipInlineSection.style.marginTop = "30px";
                // Enhanced Membership Approval Inline Section
                membershipInlineSection.innerHTML = `
                  <div class="membership-header" style="padding:24px 0 12px 0; text-align:center;">
                    <h2 style="margin:0; font-size:2.2rem; font-weight:700; color:#8e0e00;">Membership Approvals</h2>
                    <div style="font-size:15px; color:#444; font-weight:500; margin-top:6px;">Review, approve, or reject new club member applications</div>
                  </div>
                  <div class="membership-content" style="background:#fff; border-radius:0 0 18px 18px; box-shadow:0 4px 32px rgba(142,14,0,0.08); padding:32px 32px 32px 32px; border:1px solid #e5e7eb;">
                    <div class="member-toolbar" style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; flex-wrap:wrap;">
                      <div class="member-left" style="display:flex; gap:12px; align-items:center;">
                        <input id="memberSearch" type="text" placeholder="Search member..." style="padding:10px 16px; border-radius:10px; border:1px solid #e5e7eb; font-size:15px; min-width:200px; background:#fff3f1; box-shadow:0 1px 6px rgba(142,14,0,0.04);">
                        <span class="pill" style="background:#fff7f7; border:1px solid #ffdede; padding:4px 10px; border-radius:999px; font-size:13px;">Pending <span id="pendingCountHeader">0</span></span>
                        <span class="pill green" style="background:#e7f6ea; border-color:#bfe7c4; padding:4px 10px; border-radius:999px; font-size:13px;">Approved <span id="approvedCountTop">0</span></span>
                        <span class="pill red" style="background:#fdeeee; border-color:#ffc5c5; padding:4px 10px; border-radius:999px; font-size:13px;">Rejected <span id="rejectedCountTop">0</span></span>
                      </div>
                      <div class="member-right" style="display:flex; gap:12px; align-items:center;">
                        <button class="btn" style="background:#8e0e00; color:#fff; font-weight:600; border-radius:8px; padding:8px 22px; font-size:1rem; box-shadow:0 2px 8px rgba(142,14,0,0.08);">Export</button>
                      </div>
                    </div>
                    <div class="member-tabs" style="display:flex; gap:8px; margin-bottom:18px;">
                      <button class="tab-btn active" data-tab="pendingTab">Pending</button>
                      <button class="tab-btn" data-tab="approvedTab">Approved</button>
                      <button class="tab-btn" data-tab="rejectedTab">Rejected</button>
                    </div>
                    <div class="approval-sections" style="display:block;">
                      <div class="tab-pane" id="pendingTab">
                        <div class="approval-card" style="background:#fafafa; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:14px; margin-bottom:18px;">
                          <h4 style="text-align:center; margin-bottom:10px; font-size:15px; font-weight:600; color:#8e0e00;">Pending Applications</h4>
                          <div class="table-wrap" style="max-height:380px; overflow:auto; border-radius:10px;">
                            <table id="pendingTable" style="font-size:13px; min-width:600px; width:100%; border-radius:10px;">
                              <thead style="background:#8e0e00; color:#fff;">
                                <tr><th>Name</th><th>Club</th><th>Current Clubs</th><th>Action</th></tr>
                              </thead>
                              <tbody>
                                <tr data-clubs="2">
                                  <td>Juan Dela Cruz</td>
                                  <td>Math Club</td>
                                  <td><span class="badge">2</span></td>
                                  <td>
                                    <button class="approve" onclick="approveStudent(this)"><i class="ri-check-line"></i> Approve</button>
                                    <button class="reject" onclick="rejectStudent(this)"><i class="ri-close-line"></i> Reject</button>
                                  </td>
                                </tr>
                                <tr data-clubs="1">
                                  <td>Maria Santos</td>
                                  <td>Physics Club</td>
                                  <td><span class="badge">1</span></td>
                                  <td>
                                    <button class="approve" onclick="approveStudent(this)"><i class="ri-check-line"></i> Approve</button>
                                    <button class="reject" onclick="rejectStudent(this)"><i class="ri-close-line"></i> Reject</button>
                                  </td>
                                </tr>
                                <tr data-clubs="3">
                                  <td>Carlos Reyes</td>
                                  <td>Science & Math Club</td>
                                  <td><span class="badge">3</span></td>
                                  <td>
                                    <button class="approve" onclick="approveStudent(this)"><i class="ri-check-line"></i> Approve</button>
                                    <button class="reject" onclick="rejectStudent(this)"><i class="ri-close-line"></i> Reject</button>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                      <div class="tab-pane" id="approvedTab" style="display:none;">
                        <div class="approval-card approved" style="background:#e7f6ea; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:14px; margin-bottom:18px;">
                          <h4 style="text-align:center; margin-bottom:10px; font-size:15px; font-weight:600; color:#2e7d32;">Approved Members</h4>
                          <div class="table-wrap" style="max-height:380px; overflow:auto; border-radius:10px;">
                            <table id="approvedTable" style="font-size:13px; min-width:600px; width:100%; border-radius:10px;">
                              <thead style="background:#8e0e00; color:#fff;">
                                <tr><th>Name</th><th>Club</th><th>Current Clubs</th><th>Action</th></tr>
                              </thead>
                              <tbody></tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                      <div class="tab-pane" id="rejectedTab" style="display:none;">
                        <div class="approval-card rejected" style="background:#fdeeee; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:14px; margin-bottom:18px;">
                          <h4 style="text-align:center; margin-bottom:10px; font-size:15px; font-weight:600; color:#8e0e00;">Rejected Applications</h4>
                          <div class="table-wrap" style="max-height:380px; overflow:auto; border-radius:10px;">
                            <table id="rejectedTable" style="font-size:13px; min-width:600px; width:100%; border-radius:10px;">
                              <thead style="background:#8e0e00; color:#fff;">
                                <tr><th>Name</th><th>Club</th><th>Current Clubs</th><th>Action</th></tr>
                              </thead>
                              <tbody></tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
                document
                  .querySelector(".main")
                  .appendChild(membershipInlineSection);
                // Add event listeners to inline search and tabs
                setTimeout(() => {
                  const inlineSearch =
                    membershipInlineSection.querySelector("#memberSearch");
                  if (inlineSearch) {
                    inlineSearch.addEventListener("input", () => {
                      const q = inlineSearch.value.toLowerCase();
                      membershipInlineSection
                        .querySelectorAll("#pendingTable tbody tr")
                        .forEach((tr) => {
                          const name =
                            tr.cells[0]?.innerText.toLowerCase() || "";
                          const club =
                            tr.cells[1]?.innerText.toLowerCase() || "";
                          tr.style.display =
                            !q || name.includes(q) || club.includes(q)
                              ? ""
                              : "none";
                        });
                    });
                  }
                  // Tabs
                  membershipInlineSection
                    .querySelectorAll(".tab-btn")
                    .forEach((btn) => {
                      btn.addEventListener("click", () => {
                        membershipInlineSection
                          .querySelectorAll(".tab-btn")
                          .forEach((b) => b.classList.remove("active"));
                        btn.classList.add("active");
                        const id = btn.getAttribute("data-tab");
                        membershipInlineSection
                          .querySelectorAll(".tab-pane")
                          .forEach((p) => {
                            p.style.display = p.id === id ? "" : "none";
                          });
                      });
                    });
                }, 0);
              }

              // Always hide modal
              document.getElementById("membershipModal").style.display = "none";
              // Always show inline section
              membershipInlineSection.style.display = "block";
            });
          // Hide inline membership approval section when any other main section is selected
          // Hide membership approval inline section when ANY other sidebar section is selected
          [
            "sidebarAttendance",
            "sidebarClubRecords",
            "sidebarOfficerRoles",
            "sidebarAnalytics",
            "sidebarCommunication",
          ].forEach((id) => {
            document.getElementById(id).addEventListener("click", function () {
              const heading = document.getElementById("dashboardHeading");
              if (heading) heading.style.display = "none";
              let membershipInlineSection = document.getElementById(
                "membershipInlineSection"
              );
              if (membershipInlineSection)
                membershipInlineSection.style.display = "none";
            });
          });

          // Dashboard click restores heading and dashboard view
          const sidebarDashboard = document.getElementById("sidebarDashboard");
          if (sidebarDashboard) {
            sidebarDashboard.addEventListener("click", function (e) {
              e.preventDefault();
              const heading = document.getElementById("dashboardHeading");
              if (heading) heading.style.display = "";
              const cardGrid = document.getElementById("cardGrid");
              if (cardGrid) cardGrid.style.display = "grid";
              [
                "analyticsSection",
                "requirementsSection",
                "communicationSection",
                "clubRecordsSection",
                "officerRolesSection",
                "attendanceSection",
              ].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.style.display = "none";
              });
              const membershipInlineSection = document.getElementById(
                "membershipInlineSection"
              );
              if (membershipInlineSection)
                membershipInlineSection.style.display = "none";
            });
          }

          function approveStudent(btn) {
            const row = btn.closest("tr");
            const name = row.cells[0].innerText;
            const applyingFor = row.cells[1].innerText;
            const currentClubs = row.cells[2].innerText.replace(/[^0-9]/g, "");

            document.querySelector("#approvedTable tbody").insertAdjacentHTML(
              "beforeend",
              `<tr>
      <td>${name}</td>
      <td>${applyingFor}</td>
      <td>${currentClubs}</td>
      <td><button class="delete-row" onclick="deleteMemberRow(this)"><i class='ri-delete-bin-line'></i> Delete</button></td>
    </tr>`
            );

            row.remove();
            updateCounts();
          }

          function rejectStudent(btn) {
            const row = btn.closest("tr");
            const name = row.cells[0].innerText;
            const applyingFor = row.cells[1].innerText;
            const currentClubs = row.cells[2].innerText.replace(/[^0-9]/g, "");

            document.querySelector("#rejectedTable tbody").insertAdjacentHTML(
              "beforeend",
              `<tr>
      <td>${name}</td>
      <td>${applyingFor}</td>
      <td>${currentClubs}</td>
      <td><button class="delete-row" onclick="deleteMemberRow(this)"><i class='ri-delete-bin-line'></i> Delete</button></td>
    </tr>`
            );

            row.remove();
            updateCounts();
          }

          function deleteMemberRow(btn) {
            const row = btn.closest("tr");
            const table = row.closest("table");
            if (confirm("Delete this record?")) {
              // If deleting from approved or rejected, move back to pending
              if (
                table.id === "approvedTable" ||
                table.id === "rejectedTable"
              ) {
                const name = row.cells[0].innerText;
                const applyingFor = row.cells[1].innerText;
                const currentClubs = row.cells[2].innerText;
                document
                  .querySelector("#pendingTable tbody")
                  .insertAdjacentHTML(
                    "beforeend",
                    `<tr data-clubs="${currentClubs}">
                <td>${name}</td>
                <td>${applyingFor}</td>
                <td><span class="badge">${currentClubs}</span></td>
                <td>
                  <button class="approve" onclick="approveStudent(this)"><i class="ri-check-line"></i> Approve</button>
                  <button class="reject" onclick="rejectStudent(this)"><i class="ri-close-line"></i> Reject</button>
                </td>
              </tr>`
                  );
              }
              row.remove();
              updateCounts();
            }
          }

          // Tabs behavior
          document.querySelectorAll(".tab-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              document
                .querySelectorAll(".tab-btn")
                .forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");
              const id = btn.getAttribute("data-tab");
              document.querySelectorAll(".tab-pane").forEach((p) => {
                p.style.display = p.id === id ? "" : "none";
              });
            });
          });

          // Update counts for membership tables and toolbar
          function updateCounts() {
            const approved = document.querySelectorAll(
              "#approvedTable tbody tr"
            ).length;
            const rejected = document.querySelectorAll(
              "#rejectedTable tbody tr"
            ).length;
            const pending = document.querySelectorAll(
              "#pendingTable tbody tr"
            ).length;
            const approvedCountEl = document.getElementById("approvedCount");
            const rejectedCountEl = document.getElementById("rejectedCount");
            const approvedTop = document.getElementById("approvedCountTop");
            const rejectedTop = document.getElementById("rejectedCountTop");
            const pendingCountEl = document.getElementById("pendingCount");
            const pendingHeaderEl =
              document.getElementById("pendingCountHeader");
            if (approvedCountEl) approvedCountEl.innerText = approved;
            if (rejectedCountEl) rejectedCountEl.innerText = rejected;
            if (approvedTop) approvedTop.innerText = approved;
            if (rejectedTop) rejectedTop.innerText = rejected;
            if (pendingCountEl) pendingCountEl.innerText = pending;
            if (pendingHeaderEl) pendingHeaderEl.innerText = pending;
            const membershipText = document.getElementById("membershipText");
            if (membershipText) {
              membershipText.textContent = pending
                ? `${pending} new application${
                    pending === 1 ? "" : "s"
                  } awaiting approval.`
                : "No pending applications.";
            }
          }

          // Membership search filter
          const memberSearch = document.getElementById("memberSearch");
          if (memberSearch) {
            memberSearch.addEventListener("input", () => {
              const q = memberSearch.value.toLowerCase();
              document
                .querySelectorAll("#pendingTable tbody tr")
                .forEach((tr) => {
                  const name = tr.cells[0]?.innerText.toLowerCase() || "";
                  const club = tr.cells[1]?.innerText.toLowerCase() || "";
                  tr.style.display =
                    !q || name.includes(q) || club.includes(q) ? "" : "none";
                });
            });
          }

          // Attendance Modal
          const attendanceModal = document.getElementById("attendanceModal");
          function openAttendanceModal() {
            attendanceModal.style.display = "flex";
          }
          function closeAttendanceModal() {
            attendanceModal.style.display = "none";
          }
          // Sidebar Attendance click
          document
            .getElementById("sidebarAttendance")
            .addEventListener("click", function (e) {
              e.preventDefault();
              document.getElementById("cardGrid").style.display = "none";
              document.getElementById("analyticsSection").style.display =
                "none";
              officerRolesSection.style.display = "none";
              communicationSection.style.display = "none";
              clubRecordsSection.style.display = "none";
              // Show enhanced inline attendance section
              let attendanceInlineSection = document.getElementById(
                "attendanceInlineSection"
              );
              if (!attendanceInlineSection) {
                attendanceInlineSection = document.createElement("div");
                attendanceInlineSection.id = "attendanceInlineSection";
                attendanceInlineSection.style.marginTop = "30px";
                attendanceInlineSection.innerHTML = `
            <div style="max-width:900px; margin:auto; background:#fff; border-radius:18px; box-shadow:0 4px 32px rgba(142,14,0,0.08); padding:36px 32px 32px 32px; border:1px solid #e5e7eb;">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;">
                <h2 style="color:#8e0e00; font-size:2rem; margin:0; display:flex; align-items:center; gap:12px;"><span style='background:#8e0e00; color:#fff; border-radius:50%; width:38px; height:38px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(142,14,0,0.08);'><i class='ri-calendar-check-line' style='font-size:22px;'></i></span> Attendance Management</h2>
                <span style="background:#8e0e00; color:#fff; font-weight:600; border-radius:8px; padding:8px 18px; font-size:1.1rem; box-shadow:0 2px 8px rgba(142,14,0,0.08);">2024-2025</span>
              </div>
              <div style="margin-bottom:18px; font-size:16px; color:#222; font-weight:500;">
                Present: <span id="presentCount">0</span> | Absent: <span id="absentCount">0</span>
              </div>
              <div class="attn-toolbar" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; gap:18px; flex-wrap:wrap;">
                <div class="attn-left" style="display:flex; gap:12px; align-items:center;">
                  <label class="visually-hidden" for="attnSearch">Search attendee</label>
                  <input id="attnSearch" type="text" placeholder="Search attendee..." style="padding:8px 12px; border-radius:8px; border:1px solid #e5e7eb; font-size:15px; min-width:180px;">
                  <label class="visually-hidden" for="attnFilter">Filter status</label>
                  <select id="attnFilter" style="padding:8px 12px; border-radius:8px; border:1px solid #e5e7eb; font-size:15px;">
                    <option value="all">All</option>
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                    <option value="not_marked">Not Marked</option>
                  </select>
                </div>
                <div class="attn-right">
                  <button id="attnExport" class="btn btn-light" type="button" aria-label="Export attendance to CSV" style="font-size:15px; padding:8px 18px; border-radius:8px; border:1px solid #e5e7eb; background:#fafbfc; color:#8e0e00; cursor:pointer;"><i class="ri-download-2-line"></i> Export</button>
                </div>
              </div>
              <div class="table-wrap" style="overflow-x:auto; max-width:100%; white-space:nowrap;">
                <table id="attendanceTable" style="min-width:600px; width:100%; font-size:15px; border-collapse:collapse; margin-top:12px; table-layout:auto; word-break:break-word; background:#fff; border-radius:12px; box-shadow:0 1px 12px rgba(142,14,0,0.06); overflow:hidden;">
                  <thead style="background:#8e0e00; color:#fff;">
                    <tr>
                      <th style="min-width:120px; padding:14px 0; text-align:center;">Name</th>
                      <th style="min-width:90px; padding:14px 0; text-align:center;">Status</th>
                      <th style="min-width:120px; padding:14px 0; text-align:center;">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="text-align:center;">Juan Dela Cruz</td>
                      <td class="status" style="text-align:center;">Not Marked</td>
                      <td style="text-align:center;">
                        <button class="approve" onclick="markPresent(this)" style="font-size:14px; padding:6px 14px; border-radius:6px;"><i class="ri-checkbox-circle-line"></i> Present</button>
                        <button class="reject" onclick="markAbsent(this)" style="font-size:14px; padding:6px 14px; border-radius:6px;"><i class="ri-close-circle-line"></i> Absent</button>
                      </td>
                    </tr>
                    <tr>
                      <td style="text-align:center;">Maria Santos</td>
                      <td class="status" style="text-align:center;">Not Marked</td>
                      <td style="text-align:center;">
                        <button class="approve" onclick="markPresent(this)" style="font-size:14px; padding:6px 14px; border-radius:6px;"><i class="ri-checkbox-circle-line"></i> Present</button>
                        <button class="reject" onclick="markAbsent(this)" style="font-size:14px; padding:6px 14px; border-radius:6px;"><i class="ri-close-circle-line"></i> Absent</button>
                      </td>
                    </tr>
                    <tr>
                      <td style="text-align:center;">Carlos Reyes</td>
                      <td class="status" style="text-align:center;">Not Marked</td>
                      <td style="text-align:center;">
                        <button class="approve" onclick="markPresent(this)" style="font-size:14px; padding:6px 14px; border-radius:6px;"><i class="ri-checkbox-circle-line"></i> Present</button>
                        <button class="reject" onclick="markAbsent(this)" style="font-size:14px; padding:6px 14px; border-radius:6px;"><i class="ri-close-circle-line"></i> Absent</button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          `;
                document
                  .querySelector(".main")
                  .appendChild(attendanceInlineSection);
                // Add event listeners to inline table search and filter
                setTimeout(() => {
                  const inlineSearch =
                    attendanceInlineSection.querySelector("#attnSearch");
                  const inlineFilter =
                    attendanceInlineSection.querySelector("#attnFilter");
                  const inlineTable =
                    attendanceInlineSection.querySelector("#attendanceTable");
                  function applyInlineAttendanceFilters() {
                    const q = (inlineSearch.value || "").toLowerCase();
                    const filter = inlineFilter.value;
                    Array.from(
                      inlineTable.querySelectorAll("tbody tr")
                    ).forEach((tr) => {
                      const name = tr.cells[0].innerText.toLowerCase();
                      const statusEl = tr.querySelector(".status");
                      const statusText = statusEl
                        ? statusEl.innerText.toLowerCase()
                        : "";
                      const matchesSearch = !q || name.includes(q);
                      const matchesFilter =
                        filter === "all" ||
                        (filter === "present" && statusText === "present") ||
                        (filter === "absent" && statusText === "absent") ||
                        (filter === "not_marked" &&
                          statusText === "not marked");
                      tr.style.display =
                        matchesSearch && matchesFilter ? "" : "none";
                    });
                  }
                  if (inlineSearch && inlineFilter) {
                    inlineSearch.addEventListener(
                      "input",
                      applyInlineAttendanceFilters
                    );
                    inlineFilter.addEventListener(
                      "change",
                      applyInlineAttendanceFilters
                    );
                  }
                }, 0);
              }
              attendanceInlineSection.style.display = "block";
              document.getElementById("attendanceModal").style.display = "none";
            });
          // Hide inline attendance section when any other sidebar section is selected
          [
            "sidebarMemberApprovals",
            "sidebarClubRecords",
            "sidebarOfficerRoles",
            "sidebarAnalytics",
            "sidebarCommunication",
          ].forEach((id) => {
            document.getElementById(id).addEventListener("click", function () {
              let attendanceInlineSection = document.getElementById(
                "attendanceInlineSection"
              );
              if (attendanceInlineSection)
                attendanceInlineSection.style.display = "none";
            });
          });

          function updateAttendanceCounts() {
            // Always count from the main attendance table for accuracy
            const mainTable = document.getElementById("attendanceTable");
            let presentCount = 0;
            let absentCount = 0;
            if (mainTable) {
              Array.from(mainTable.querySelectorAll("tbody tr")).forEach(
                (row) => {
                  const statusCell = row.querySelector(".status");
                  if (statusCell) {
                    if (statusCell.classList.contains("present"))
                      presentCount++;
                    if (statusCell.classList.contains("absent")) absentCount++;
                  }
                }
              );
            }
            // Update modal counts
            const modalPresent = document.querySelector(
              "#attendanceModal #presentCount"
            );
            const modalAbsent = document.querySelector(
              "#attendanceModal #absentCount"
            );
            if (modalPresent) modalPresent.innerText = presentCount;
            if (modalAbsent) modalAbsent.innerText = absentCount;
            // Update inline attendance counts if present
            let attendanceInlineSection = document.getElementById(
              "attendanceInlineSection"
            );
            if (attendanceInlineSection) {
              let presentSpan =
                attendanceInlineSection.querySelector("#presentCount");
              let absentSpan =
                attendanceInlineSection.querySelector("#absentCount");
              if (presentSpan) presentSpan.innerText = presentCount;
              if (absentSpan) absentSpan.innerText = absentCount;
            }
          }

          function markPresent(btn) {
            const row = btn.closest("tr");
            const statusCell = row.querySelector(".status");
            statusCell.innerText = "Present";
            statusCell.classList.remove("absent");
            statusCell.classList.add("present");
            statusCell.dataset.lastChanged = btn.closest("#attendanceModal")
              ? "modal"
              : "inline";
            syncAttendanceTables();
            updateAttendanceCounts();
          }

          function markAbsent(btn) {
            const row = btn.closest("tr");
            const statusCell = row.querySelector(".status");
            statusCell.innerText = "Absent";
            statusCell.classList.remove("present");
            statusCell.classList.add("absent");
            statusCell.dataset.lastChanged = btn.closest("#attendanceModal")
              ? "modal"
              : "inline";
            syncAttendanceTables();
            updateAttendanceCounts();
          }
          // Synchronize attendance status between modal and inline attendance tables
          function syncAttendanceTables() {
            // Get both attendance tables
            const modalTable = document.querySelector(
              "#attendanceModal #attendanceTable"
            );
            const inlineTable = document.getElementById("attendanceTable");
            if (!modalTable || !inlineTable) return;
            // Sync status from modal to inline and vice versa
            const modalRows = Array.from(
              modalTable.querySelectorAll("tbody tr")
            );
            const inlineRows = Array.from(
              inlineTable.querySelectorAll("tbody tr")
            );
            // Assume both tables have same order and number of rows
            for (let i = 0; i < modalRows.length; i++) {
              const modalStatus = modalRows[i].querySelector(".status");
              const inlineStatus = inlineRows[i].querySelector(".status");
              if (modalStatus && inlineStatus) {
                // If status differs, update both to match the most recent change
                // Use a data attribute to track last changed
                if (modalStatus.dataset.lastChanged === "modal") {
                  inlineStatus.innerText = modalStatus.innerText;
                  inlineStatus.className = modalStatus.className;
                } else if (inlineStatus.dataset.lastChanged === "inline") {
                  modalStatus.innerText = inlineStatus.innerText;
                  modalStatus.className = inlineStatus.className;
                }
              }
            }
            // Remove lastChanged after sync
            modalRows.forEach((row) => {
              const status = row.querySelector(".status");
              if (status) status.dataset.lastChanged = "";
            });
            inlineRows.forEach((row) => {
              const status = row.querySelector(".status");
              if (status) status.dataset.lastChanged = "";
            });
          }
          // Attendance search and filter
          const attnSearch = document.getElementById("attnSearch");
          const attnFilter = document.getElementById("attnFilter");
          function applyAttendanceFilters() {
            const q = (attnSearch.value || "").toLowerCase();
            const filter = attnFilter.value; // all | present | absent | not_marked
            document
              .querySelectorAll("#attendanceTable tbody tr")
              .forEach((tr) => {
                const name = tr.cells[0].innerText.toLowerCase();
                const statusEl = tr.querySelector(".status");
                const statusText = statusEl
                  ? statusEl.innerText.toLowerCase()
                  : "";
                const matchesSearch = !q || name.includes(q);
                const matchesFilter =
                  filter === "all" ||
                  (filter === "present" && statusText === "present") ||
                  (filter === "absent" && statusText === "absent") ||
                  (filter === "not_marked" && statusText === "not marked");
                tr.style.display = matchesSearch && matchesFilter ? "" : "none";
              });
          }
          if (attnSearch && attnFilter) {
            attnSearch.addEventListener("input", applyAttendanceFilters);
            attnFilter.addEventListener("change", applyAttendanceFilters);
          }

          // Export visible attendance rows to CSV
          const attnExportBtn = document.getElementById("attnExport");
          function exportAttendanceCSV() {
            const rows = Array.from(
              document.querySelectorAll("#attendanceTable tbody tr")
            ).filter((tr) => getComputedStyle(tr).display !== "none");
            const data = [["Name", "Status"]];
            rows.forEach((tr) => {
              const name = (tr.cells[0]?.innerText || "").trim();
              const status = (
                tr.querySelector(".status")?.innerText || ""
              ).trim();
              data.push([name, status]);
            });
            const csv = data
              .map((r) =>
                r
                  .map((v) => '"' + String(v).replace(/"/g, '""') + '"')
                  .join(",")
              )
              .join("\r\n");
            const blob = new Blob(["\uFEFF" + csv], {
              type: "text/csv;charset=utf-8;",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, "0");
            const dd = String(now.getDate()).padStart(2, "0");
            a.href = url;
            a.download = `attendance-${yyyy}-${mm}-${dd}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }
          if (attnExportBtn) {
            attnExportBtn.addEventListener("click", exportAttendanceCSV);
          }
          const ctx = document
            .getElementById("analyticsChart")
            .getContext("2d");
          let analyticsChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: ["Jan", "Feb", "Mar", "Apr", "May"],
              datasets: [
                {
                  label: "Attendance %",
                  data: [90, 85, 80, 95, 88],
                  backgroundColor: "#8e0e00",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: { beginAtZero: true, max: 100 },
              },
            },
          });

          function refreshChart() {
            analyticsChart.data.datasets[0].data = Array.from(
              { length: 5 },
              () => Math.floor(Math.random() * 21) + 80
            );
            analyticsChart.update();
          }

          // Create Post Modal
          const postModal = document.getElementById("postModal");
          const postForm = document.getElementById("postForm");
          const postList = document.getElementById("postList");

          function createPost() {
            postModal.style.display = "flex";
          }

          function closePostModal() {
            postModal.style.display = "none";
          }

          // Communication posts logic
          const communicationPosts = [];

          function renderCommunicationPosts() {
            postList.innerHTML = "";
            communicationPosts.forEach((post, idx) => {
              const li = document.createElement("li");
              li.classList.add("post-item");
              li.innerHTML = `
            <div style="word-break:break-word; max-width:100%; white-space:pre-line;">
              <strong>${post.title}</strong> - <span class="post-item-message">${post.message}</span> <em>(${post.audience})</em>
            </div>
            <button class="delete-post" title="Remove post"><i class='ri-close-line' style='font-size:18px; vertical-align:middle;'></i></button>
          `;
              li.querySelector(".delete-post").addEventListener("click", () => {
                if (confirm("Are you sure you want to delete this post?")) {
                  communicationPosts.splice(idx, 1);
                  renderCommunicationPosts();
                }
              });
              postList.appendChild(li);
            });
          }

          postForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const title = document.getElementById("postTitle").value;
            const message = document.getElementById("postMessage").value;
            const audience = document.getElementById("postAudience").value;
            communicationPosts.push({ title, message, audience });
            renderCommunicationPosts();
            postForm.reset();
            // Also add to notifications so admins posting appear in the notif dropdown
            addNotification(title, message, { show: false });
            // If dropdown is open, re-render
            const notifDropdown = document.getElementById("notifDropdown");
            if (notifDropdown && notifDropdown.style.display !== "none") {
              renderAnnouncements();
            }
            closePostModal();
          });

          // Calendar Setup
          const calendarEl = document.getElementById("calendar");
          const events = [
            { date: "2025-09-15", name: "General Assembly" },
            { date: "2025-09-22", name: "Leadership Training" },
          ];
          // Pending events storage (awaiting admin approval)
          function getPendingEvents() {
            try {
              return JSON.parse(localStorage.getItem("pendingEvents") || "[]");
            } catch (e) {
              return [];
            }
          }
          function setPendingEvents(list) {
            localStorage.setItem("pendingEvents", JSON.stringify(list));
          }
          function refreshPendingEventsHint() {
            const hint = document.getElementById("pendingEventsHint");
            if (!hint) return;
            const count = getPendingEvents().length;
            hint.textContent = count
              ? `${count} event${count > 1 ? "s" : ""} pending admin approval`
              : "";
          }

          function generateCalendar(year, month) {
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            calendarEl.innerHTML = "";

            for (let i = 0; i < firstDay; i++) {
              const blank = document.createElement("div");
              calendarEl.appendChild(blank);
            }

            const pendingEvents = getPendingEvents();
            for (let day = 1; day <= daysInMonth; day++) {
              const dayEl = document.createElement("div");
              const dateStr = `${year}-${String(month + 1).padStart(
                2,
                "0"
              )}-${String(day).padStart(2, "0")}`;

              dayEl.classList.add("calendar-day");
              dayEl.textContent = day;

              const event = events.find((e) => e.date === dateStr);
              const pending = pendingEvents.find((e) => e.date === dateStr);
              if (event || pending) {
                dayEl.classList.add("event");
                const eventName = event ? event.name : pending.title;
                const isPending = Boolean(pending && !event);
                dayEl.setAttribute("data-event", eventName);
                if (isPending) {
                  dayEl.style.outline = "2px dashed #8e0e00";
                  dayEl.style.outlineOffset = "-4px";
                  dayEl.title = `${eventName} (Pending Approval)`;
                }
                dayEl.addEventListener("click", () => {
                  const nameToShow = eventName;
                  document.querySelector(
                    "#attendanceModal h3"
                  ).innerText = `Attendance Management – ${nameToShow}`;
                  attendanceModal.style.display = "flex";
                });
              }

              calendarEl.appendChild(dayEl);
            }
          }
          generateCalendar(2025, 8);

          // Create Event Modal + Flow
          (function initCreateEventFlow() {
            // Inject modal if not present
            if (!document.getElementById("createEventModal")) {
              const modal = document.createElement("div");
              modal.className = "modal";
              modal.id = "createEventModal";
              modal.innerHTML = `
                <div class="modal-content modal-card" style="max-width:520px;">
                  <div class="modal-header">
                    <h3>Create Event</h3>
                    <button class="close-small" id="closeCreateEventModal" title="Close">✖</button>
                  </div>
                  <div class="modal-body">
                    <form id="createEventForm">
                      <div class="form-group">
                        <label for="ce-title">Title</label>
                        <input id="ce-title" type="text" required placeholder="e.g. Charity Drive" />
                      </div>
                      <div class="form-group">
                        <label for="ce-date">Date</label>
                        <input id="ce-date" type="date" required />
                      </div>
                      <div class="form-group">
                        <label for="ce-club">Club/Organizer</label>
                        <input id="ce-club" type="text" required placeholder="e.g. Science Club" />
                      </div>
                      <div class="form-group">
                        <label for="ce-location">Location</label>
                        <input id="ce-location" type="text" placeholder="Optional" />
                      </div>
                      <div class="form-group">
                        <label for="ce-notes">Notes</label>
                        <input id="ce-notes" type="text" placeholder="Optional" />
                      </div>
                      <div class="modal-footer" style="justify-content:flex-end;">
                        <button type="button" class="btn btn-light" id="cancelCreateEvent">Cancel</button>
                        <button type="submit" class="btn">Submit for Approval</button>
                      </div>
                    </form>
                  </div>
                </div>`;
              document.body.appendChild(modal);
            }

            const openBtn = document.getElementById("openCreateEventBtn");
            const modal = document.getElementById("createEventModal");
            const closeBtn = document.getElementById("closeCreateEventModal");
            const cancelBtn = document.getElementById("cancelCreateEvent");
            const form = document.getElementById("createEventForm");

            function openModal() {
              modal.style.display = "flex";
            }
            function closeModal() {
              modal.style.display = "none";
            }
            if (openBtn) openBtn.addEventListener("click", openModal);
            if (closeBtn) closeBtn.addEventListener("click", closeModal);
            if (cancelBtn) cancelBtn.addEventListener("click", closeModal);

            if (form) {
              form.addEventListener("submit", function (e) {
                e.preventDefault();
                const title = document.getElementById("ce-title").value.trim();
                const date = document.getElementById("ce-date").value;
                const club = document.getElementById("ce-club").value.trim();
                const location = document
                  .getElementById("ce-location")
                  .value.trim();
                const notes = document.getElementById("ce-notes").value.trim();
                if (!title || !date || !club) return;
                const list = getPendingEvents();
                list.push({
                  title,
                  date,
                  club,
                  location,
                  notes,
                  status: "pending",
                });
                setPendingEvents(list);
                closeModal();
                refreshPendingEventsHint();
                // Re-render current month to show pending pill
                const now = new Date(date);
                generateCalendar(now.getFullYear(), now.getMonth());
                showToast(`Event submitted for approval: ${title}`, {
                  type: "success",
                });
              });
            }

            refreshPendingEventsHint();
          })();

          // Requirements/Activities Checklist
          document
            .getElementById("sidebarRequirementsActivities")
            .addEventListener("click", function (e) {
              e.preventDefault();
              // Hide all main sections
              const sectionIds = [
                "cardGrid",
                "analyticsSection",
                "requirementsSection",
                "communicationSection",
                "clubRecordsSection",
                "officerRolesSection",
                "attendanceSection",
              ];
              sectionIds.forEach(function (id) {
                const el = document.getElementById(id);
                if (el) el.style.display = "none";
              });
              // Show only requirementsActivitiesSection
              document.getElementById(
                "requirementsActivitiesSection"
              ).style.display = "block";
            });
          // Hide requirementsActivitiesSection when any other sidebar item is clicked
          [
            "sidebarMemberApprovals",
            "sidebarAttendance",
            "sidebarClubRecords",
            "sidebarOfficerRoles",
            "sidebarAnalytics",
            "sidebarCommunication",
            // Also dashboard main link
            ...Array.from(document.querySelectorAll(".sidebar a"))
              .map((a) => a.id)
              .filter((id) => id && id !== "sidebarRequirementsActivities"),
          ].forEach(function (id) {
            if (!id || id === "sidebarRequirementsActivities") return;
            var el = document.getElementById(id);
            if (el)
              el.addEventListener("click", function () {
                const reqActSection = document.getElementById(
                  "requirementsActivitiesSection"
                );
                if (reqActSection) reqActSection.style.display = "none";
              });
          });
          // Checklist persistence
          function saveRequirementsActivitiesChecklist() {
            const checklist = {};
            document
              .querySelectorAll(
                '#requirementsActivitiesChecklist input[type="checkbox"]'
              )
              .forEach((cb) => {
                checklist[cb.name] = cb.checked;
              });
            localStorage.setItem(
              "requirementsActivitiesChecklist",
              JSON.stringify(checklist)
            );
          }
          function loadRequirementsActivitiesChecklist() {
            const checklist = JSON.parse(
              localStorage.getItem("requirementsActivitiesChecklist") || "{}"
            );
            document
              .querySelectorAll(
                '#requirementsActivitiesChecklist input[type="checkbox"]'
              )
              .forEach((cb) => {
                if (checklist.hasOwnProperty(cb.name)) {
                  cb.checked = checklist[cb.name];
                }
              });
          }
          // File upload persistence
          function saveRequirementsUploadFiles(files) {
            // Only save file names/types for privacy; actual files can't be stored in localStorage
            const fileData = Array.from(files).map((f) => ({
              name: f.name,
              type: f.type,
            }));
            localStorage.setItem(
              "requirementsUploadFiles",
              JSON.stringify(fileData)
            );
          }
          function loadRequirementsUploadFiles() {
            const fileData = JSON.parse(
              localStorage.getItem("requirementsUploadFiles") || "[]"
            );
            const preview = document.getElementById(
              "requirementsUploadPreview"
            );
            preview.innerHTML = "";
            fileData.forEach((file) => {
              const fileDiv = document.createElement("div");
              fileDiv.className = "upload-preview-item";
              fileDiv.textContent = file.name;
              preview.appendChild(fileDiv);
            });
          }
          // Restore checklist and upload preview on sidebar click
          function restoreRequirementsActivitiesState() {
            setTimeout(() => {
              loadRequirementsActivitiesChecklist();
              loadRequirementsUploadFiles();
            }, 100);
          }
          document
            .getElementById("sidebarRequirementsActivities")
            .addEventListener("click", restoreRequirementsActivitiesState);
          // Save checklist on change
          document.addEventListener("change", function (e) {
            if (e.target.closest("#requirementsActivitiesChecklist")) {
              saveRequirementsActivitiesChecklist();
            }
          });
          // Upload preview logic
          let lastUploadFiles = null;
          function renderUploadPreview(files) {
            const preview = document.getElementById(
              "requirementsUploadPreview"
            );
            preview.innerHTML = "";
            Array.from(files).forEach((file, idx) => {
              const fileDiv = document.createElement("div");
              fileDiv.className = "upload-preview-item";
              fileDiv.textContent = file.name;
              if (file.type.startsWith("image/")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.style.maxWidth = "60px";
                img.style.maxHeight = "60px";
                img.style.borderRadius = "6px";
                img.style.marginLeft = "8px";
                fileDiv.appendChild(img);
              }
              // Add remove button
              const removeBtn = document.createElement("button");
              removeBtn.type = "button";
              removeBtn.textContent = "✖";
              removeBtn.className = "upload-remove-btn";
              removeBtn.style.marginLeft = "8px";
              removeBtn.onclick = function () {
                const newFiles = Array.from(files).filter((_, i) => i !== idx);
                // Create a new FileList
                const dataTransfer = new DataTransfer();
                newFiles.forEach((f) => dataTransfer.items.add(f));
                document.getElementById("requirementsUploadInput").files =
                  dataTransfer.files;
                renderUploadPreview(dataTransfer.files);
                window._lastUploadFiles = dataTransfer.files;
              };
              fileDiv.appendChild(removeBtn);
              preview.appendChild(fileDiv);
            });
          }
          document
            .getElementById("requirementsUploadInput")
            .addEventListener("change", function (e) {
              lastUploadFiles = e.target.files;
              window._lastUploadFiles = e.target.files;
              renderUploadPreview(e.target.files);
            });
          // Confirmation before upload/save
          document
            .getElementById("requirementsUploadSaveBtn")
            .addEventListener("click", function () {
              document.getElementById(
                "requirementsUploadConfirmModal"
              ).style.display = "block";
            });
          document
            .getElementById("cancelUploadBtn")
            .addEventListener("click", function () {
              document.getElementById(
                "requirementsUploadConfirmModal"
              ).style.display = "none";
            });
          document
            .getElementById("confirmUploadBtn")
            .addEventListener("click", function () {
              document.getElementById(
                "requirementsUploadConfirmModal"
              ).style.display = "none";
              if (lastUploadFiles) {
                saveRequirementsUploadFiles(lastUploadFiles);
              }
              alert("Requirements uploaded/saved!");
              displayRequirementsActivitiesRecord();
            });
          function displayRequirementsActivitiesRecord() {
            const checklist = JSON.parse(
              localStorage.getItem("requirementsActivitiesChecklist") || "{}"
            );
            const fileData = JSON.parse(
              localStorage.getItem("requirementsUploadFiles") || "[]"
            );
            let html =
              '<div class="requirements-record-box" style="margin-top:24px; background:#eaf7ea; border:1px solid #b2e2b2; border-radius:10px; padding:18px;">';
            html +=
              '<h3 style="color:#218838; margin-top:0;">Saved Requirements Record</h3>';
            html +=
              '<ul style="font-size:14px; color:#222; margin-bottom:12px;">';
            Object.keys(checklist).forEach((key) => {
              if (checklist[key]) {
                html += `<li>${key
                  .replace(/([A-Z])/g, " $1")
                  .replace(/^./, (str) => str.toUpperCase())}</li>`;
              }
            });
            html += "</ul>";
            if (fileData.length > 0 && window._lastUploadFiles) {
              html +=
                '<div><strong>Uploaded Files:</strong><ul style="font-size:13px; color:#333;">';
              fileData.forEach((file, idx) => {
                // Only preview if file is available in _lastUploadFiles
                let previewLink = "";
                const realFile = window._lastUploadFiles[idx];
                if (realFile) {
                  if (realFile.type.startsWith("image/")) {
                    previewLink = `<a href="${URL.createObjectURL(
                      realFile
                    )}" target="_blank" style="color:#218838; text-decoration:underline;">${
                      file.name
                    }</a>`;
                  } else {
                    previewLink = `<a href="${URL.createObjectURL(
                      realFile
                    )}" target="_blank" style="color:#218838; text-decoration:underline;">${
                      file.name
                    }</a>`;
                  }
                } else {
                  previewLink = file.name;
                }
                html += `<li>${previewLink} (${file.type})</li>`;
              });
              html += "</ul></div>";
            }
            html += "</div>";
            document
              .getElementById("requirementsUploadPreview")
              .insertAdjacentHTML("afterend", html);
          }
        </script>
      </body>
      <script>
        // --- Enhanced Checklist Modal Logic ---
        // Store uploaded files per checklist label in localStorage
        function getUploadedFilesForLabel(label) {
          const all = JSON.parse(
            localStorage.getItem("requirementUploadsByLabel") || "{}"
          );
          return all[label] || [];
        }
        function setUploadedFilesForLabel(label, files) {
          const all = JSON.parse(
            localStorage.getItem("requirementUploadsByLabel") || "{}"
          );
          all[label] = files;
          localStorage.setItem(
            "requirementUploadsByLabel",
            JSON.stringify(all)
          );
        }

        let currentChecklistLabel = null;
        let requirementFiles = [];
        const fileInput = document.getElementById("requirementFileInput");
        const preview = document.getElementById("requirementFilePreview");
        const uploadedFilesModal = document.getElementById(
          "requirementUploadedFilesModal"
        );

        // Open modal for checklist box
        document.querySelectorAll(".checklist-box").forEach((box) => {
          box.style.cursor = "pointer";
          box.addEventListener("click", function () {
            const label = this.querySelector(
              ".checklist-label-small"
            ).innerText;
            currentChecklistLabel = label;
            document.getElementById("requirementUploadModal").style.display =
              "block";
            document.getElementById("requirementUploadTitle").innerText =
              "Upload for: " + label;
            document.getElementById("requirementFileInput").value = "";
            requirementFiles = [];
            renderFilePreview();
            renderFilesInModal(label);
          });
        });
        document.getElementById("closeRequirementUploadModal").onclick =
          function () {
            document.getElementById("requirementUploadModal").style.display =
              "none";
          };
        window.onclick = function (event) {
          const modal = document.getElementById("requirementUploadModal");
          if (event.target === modal) modal.style.display = "none";
        };

        // File input change
        fileInput.addEventListener("change", function () {
          requirementFiles = Array.from(this.files);
          renderFilePreview();
        });

        // Render preview of files to be uploaded
        function renderFilePreview() {
          preview.innerHTML = "";
          requirementFiles.forEach((file, idx) => {
            const div = document.createElement("div");
            div.style.display = "flex";
            div.style.alignItems = "center";
            div.style.marginBottom = "6px";
            const nameSpan = document.createElement("span");
            nameSpan.textContent = file.name;
            nameSpan.style.flex = "1";
            nameSpan.style.cursor = "pointer";
            nameSpan.title = "Click to preview";
            nameSpan.onclick = function () {
              const fileURL = URL.createObjectURL(file);
              if (file.type.startsWith("image/")) {
                showFilePreviewModal(
                  `<img src='${fileURL}' alt='preview' style='max-width:80vw;max-height:70vh;display:block;margin:auto;' />`
                );
              } else if (file.type === "application/pdf") {
                showFilePreviewModal(
                  `<iframe src='${fileURL}' style='width:80vw;height:70vh;border:none;'></iframe>`
                );
              } else if (file.type.startsWith("text/")) {
                const reader = new FileReader();
                reader.onload = function (e) {
                  showFilePreviewModal(
                    `<pre style='max-width:80vw;max-height:70vh;overflow:auto;background:#f5f5f5;padding:16px;border-radius:8px;'>${escapeHtml(
                      e.target.result
                    )}</pre>`
                  );
                };
                reader.readAsText(file);
              } else if (file.name.match(/\.(docx)$/i)) {
                const containerId = "docx-preview-container";
                showFilePreviewModal(
                  `<div id='${containerId}' style='width:80vw;max-width:900px;max-height:70vh;overflow:auto;background:#fff;'></div>`
                );
                const container = document.getElementById(containerId);
                const reader = new FileReader();
                reader.onload = function (e) {
                  window.docx.renderAsync(e.target.result, container, null, {
                    className: "docx",
                  });
                };
                reader.readAsArrayBuffer(file);
              } else {
                showFilePreviewModal(
                  `<div style='padding:24px;text-align:center;'>Preview not supported for this file type.<br>You can open it with the appropriate application after upload.</div>`
                );
              }
            };
            const removeBtn = document.createElement("button");
            removeBtn.innerHTML = "✖";
            removeBtn.className = "file-remove-btn";
            removeBtn.title = "Remove file";
            removeBtn.onclick = function () {
              requirementFiles.splice(idx, 1);
              renderFilePreview();
              const dt = new DataTransfer();
              requirementFiles.forEach((f) => dt.items.add(f));
              fileInput.files = dt.files;
            };
            div.appendChild(nameSpan);
            div.appendChild(removeBtn);
            preview.appendChild(div);
          });
        }

        // Render uploaded files for this checklist box in the modal
        function renderFilesInModal(label) {
          const files = getUploadedFilesForLabel(label);
          uploadedFilesModal.innerHTML = "";
          if (!files.length) {
            uploadedFilesModal.innerHTML =
              '<div style="color:#888;font-size:13px;">No files uploaded yet for this requirement.</div>';
            return;
          }
          files.forEach((file, idx) => {
            const div = document.createElement("div");
            div.style.display = "flex";
            div.style.alignItems = "center";
            div.style.marginBottom = "6px";
            const link = document.createElement("a");
            link.textContent = file.name;
            link.href = file.url;
            link.target = "_blank";
            link.style.flex = "1";
            link.style.color = "#8e0e00";
            link.style.textDecoration = "underline";
            link.title = "Click to preview";
            link.onclick = function (e) {
              e.preventDefault();
              if (file.type && file.type.startsWith("image/")) {
                showFilePreviewModal(
                  `<img src='${file.url}' alt='preview' style='max-width:80vw;max-height:70vh;display:block;margin:auto;' />`
                );
              } else if (file.type === "application/pdf") {
                showFilePreviewModal(
                  `<iframe src='${file.url}' style='width:80vw;height:70vh;border:none;'></iframe>`
                );
              } else if (file.type && file.type.startsWith("text/")) {
                fetch(file.url)
                  .then((r) => r.text())
                  .then((txt) => {
                    showFilePreviewModal(
                      `<pre style='max-width:80vw;max-height:70vh;overflow:auto;background:#f5f5f5;padding:16px;border-radius:8px;'>${escapeHtml(
                        txt
                      )}</pre>`
                    );
                  });
              } else if (file.name && file.name.match(/\.(docx)$/i)) {
                const containerId = "docx-preview-container-modal-" + idx;
                showFilePreviewModal(
                  `<div id='${containerId}' style='width:80vw;max-width:900px;max-height:70vh;overflow:auto;background:#fff;'></div>`
                );
                fetch(file.url)
                  .then((r) => r.arrayBuffer())
                  .then((buf) => {
                    window.docx.renderAsync(
                      buf,
                      document.getElementById(containerId),
                      null,
                      { className: "docx" }
                    );
                  });
              } else {
                showFilePreviewModal(
                  `<div style='padding:24px;text-align:center;'>Preview not supported for this file type.<br>You can open it with the appropriate application after download.</div>`
                );
              }
            };
            div.appendChild(link);
            // Remove button for uploaded file
            const removeBtn = document.createElement("button");
            removeBtn.innerHTML = "✖";
            removeBtn.className = "file-remove-btn";
            removeBtn.title = "Remove uploaded file";
            removeBtn.onclick = function () {
              const updated = files.slice();
              updated.splice(idx, 1);
              setUploadedFilesForLabel(label, updated);
              renderFilesInModal(label);
            };
            div.appendChild(removeBtn);
            uploadedFilesModal.appendChild(div);
          });
        }

        // Upload button: save files for this checklist box
        document.getElementById("requirementUploadBtn").onclick = function () {
          if (!currentChecklistLabel || !requirementFiles.length) {
            alert("No files selected.");
            return;
          }
          // Save files in localStorage (simulate by storing name/type/url)
          const prev = getUploadedFilesForLabel(currentChecklistLabel);
          const newFiles = requirementFiles.map((f) => ({
            name: f.name,
            type: f.type,
            url: URL.createObjectURL(f),
          }));
          setUploadedFilesForLabel(
            currentChecklistLabel,
            prev.concat(newFiles)
          );
          renderFilesInModal(currentChecklistLabel);
          requirementFiles = [];
          renderFilePreview();
        };

        // File preview modal logic (unchanged)
        function showFilePreviewModal(html) {
          document.getElementById("filePreviewContent").innerHTML = html;
          document.getElementById("filePreviewModal").style.display = "block";
        }
        document.getElementById("closeFilePreviewModal").onclick = function () {
          document.getElementById("filePreviewModal").style.display = "none";
          document.getElementById("filePreviewContent").innerHTML = "";
        };
        window.addEventListener("click", function (event) {
          const modal = document.getElementById("filePreviewModal");
          if (event.target === modal) {
            modal.style.display = "none";
            document.getElementById("filePreviewContent").innerHTML = "";
          }
        });

        // Helper to escape HTML for text preview
        function escapeHtml(text) {
          var map = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;",
          };
          return text.replace(/[&<>"']/g, function (m) {
            return map[m];
          });
        }
      </script>
    </html>
  </body>
</html>
